c1a32eae3acbb77cbb7d199207da09b6
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileManager = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const vscode = __importStar(require("vscode"));
class FileManager {
    outputChannel;
    workspacePath;
    outputDirectory;
    watchers = [];
    constructor(outputChannel) {
        this.outputChannel = outputChannel;
        this.workspacePath = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath || '';
        this.outputDirectory = path.join(this.workspacePath, '.ai-debug-output');
        this.ensureOutputDirectory();
    }
    // Output directory management
    getOutputDirectory() {
        return this.outputDirectory;
    }
    ensureOutputDirectory() {
        if (!fs.existsSync(this.outputDirectory)) {
            fs.mkdirSync(this.outputDirectory, { recursive: true });
        }
    }
    // Initialize output files
    async initializeOutputFiles(types) {
        const outputFiles = {};
        for (const type of types) {
            const filePath = this.getOutputFilePath(type);
            outputFiles[type] = filePath;
            // Create empty file if it doesn't exist
            if (!fs.existsSync(filePath)) {
                await fs.promises.writeFile(filePath, '', 'utf8');
            }
        }
        return outputFiles;
    }
    // Get output file path
    getOutputFilePath(fileName) {
        if (!fileName.endsWith('.txt')) {
            fileName += '.txt';
        }
        return path.join(this.outputDirectory, fileName);
    }
    // Save output to file
    async saveOutput(type, content) {
        try {
            const filePath = this.getOutputFilePath(type);
            await fs.promises.writeFile(filePath, content, 'utf8');
            this.outputChannel.appendLine(`Saved ${type} output to: ${filePath}`);
            return filePath;
        }
        catch (error) {
            const message = `Failed to save ${type} output: ${error}`;
            this.outputChannel.appendLine(message);
            throw new Error(message);
        }
    }
    // Get file content
    async getFileContent(type) {
        try {
            const filePath = this.getOutputFilePath(type);
            if (!fs.existsSync(filePath)) {
                return '';
            }
            return await fs.promises.readFile(filePath, 'utf8');
        }
        catch (error) {
            this.outputChannel.appendLine(`Error reading ${type} file: ${error}`);
            return '';
        }
    }
    // Get file path
    getFilePath(type) {
        return this.getOutputFilePath(type);
    }
    // Get file modification time
    getFileModTime(type) {
        try {
            const filePath = this.getOutputFilePath(type);
            if (!fs.existsSync(filePath)) {
                return null;
            }
            const stats = fs.statSync(filePath);
            return stats.mtime;
        }
        catch (error) {
            this.outputChannel.appendLine(`Error getting mod time for ${type}: ${error}`);
            return null;
        }
    }
    // Get file stats
    async getFileStats(filePath) {
        try {
            const stats = await fs.promises.stat(filePath);
            return {
                size: stats.size,
                created: stats.birthtime,
                modified: stats.mtime,
                accessed: stats.atime
            };
        }
        catch (error) {
            this.outputChannel.appendLine(`Error getting file stats for ${filePath}: ${error}`);
            return null;
        }
    }
    // Get all output files
    getAllOutputFiles() {
        const files = {};
        try {
            const outputFiles = fs.readdirSync(this.outputDirectory);
            for (const file of outputFiles) {
                if (file.endsWith('.txt')) {
                    const name = file.replace('.txt', '');
                    files[name] = path.join(this.outputDirectory, file);
                }
            }
        }
        catch (error) {
            this.outputChannel.appendLine(`Error reading output directory: ${error}`);
        }
        return files;
    }
    // Cleanup old files
    async cleanupOldFiles(maxAge = 7 * 24 * 60 * 60 * 1000) {
        try {
            const files = fs.readdirSync(this.outputDirectory);
            const now = Date.now();
            for (const file of files) {
                const filePath = path.join(this.outputDirectory, file);
                const stats = fs.statSync(filePath);
                if (now - stats.mtime.getTime() > maxAge) {
                    await fs.promises.unlink(filePath);
                    this.outputChannel.appendLine(`Cleaned up old file: ${file}`);
                }
            }
        }
        catch (error) {
            this.outputChannel.appendLine(`Error cleaning up old files: ${error}`);
        }
    }
    // Copy to clipboard
    async copyToClipboard(type) {
        try {
            const content = await this.getFileContent(type);
            await vscode.env.clipboard.writeText(content);
            vscode.window.showInformationMessage(`${type} content copied to clipboard`);
        }
        catch (error) {
            vscode.window.showErrorMessage(`Failed to copy ${type} to clipboard: ${error}`);
        }
    }
    // Open file in editor
    async openFile(filePath) {
        try {
            const document = await vscode.workspace.openTextDocument(filePath);
            await vscode.window.showTextDocument(document);
        }
        catch (error) {
            vscode.window.showErrorMessage(`Failed to open file: ${error}`);
        }
    }
    // Watch files for changes
    watchFiles(callback) {
        const watcher = fs.watch(this.outputDirectory, (eventType, filename) => {
            if (filename) {
                const filePath = path.join(this.outputDirectory, filename);
                callback(filePath, eventType);
            }
        });
        this.watchers.push(watcher);
        return {
            dispose: () => {
                const index = this.watchers.indexOf(watcher);
                if (index > -1) {
                    this.watchers.splice(index, 1);
                }
                watcher.close();
            }
        };
    }
    // Basic file operations
    async readFile(filePath) {
        try {
            const fullPath = path.resolve(this.workspacePath, filePath);
            const content = await fs.promises.readFile(fullPath, 'utf8');
            return {
                success: true,
                filePath: fullPath,
                content
            };
        }
        catch (error) {
            return {
                success: false,
                filePath,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }
    async writeFile(filePath, content) {
        try {
            const fullPath = path.resolve(this.workspacePath, filePath);
            await fs.promises.mkdir(path.dirname(fullPath), { recursive: true });
            await fs.promises.writeFile(fullPath, content, 'utf8');
            this.outputChannel.appendLine(`File written: ${fullPath}`);
            return {
                success: true,
                filePath: fullPath
            };
        }
        catch (error) {
            return {
                success: false,
                filePath,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }
    async ensureDirectoryExists(dirPath) {
        const fullPath = path.resolve(this.workspacePath, dirPath);
        await fs.promises.mkdir(fullPath, { recursive: true });
    }
    async fileExists(filePath) {
        try {
            const fullPath = path.resolve(this.workspacePath, filePath);
            await fs.promises.access(fullPath);
            return true;
        }
        catch {
            return false;
        }
    }
    async deleteFile(filePath) {
        try {
            const fullPath = path.resolve(this.workspacePath, filePath);
            await fs.promises.unlink(fullPath);
            return {
                success: true,
                filePath: fullPath
            };
        }
        catch (error) {
            return {
                success: false,
                filePath,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }
    async copyFile(sourcePath, destPath) {
        try {
            const fullSourcePath = path.resolve(this.workspacePath, sourcePath);
            const fullDestPath = path.resolve(this.workspacePath, destPath);
            await fs.promises.mkdir(path.dirname(fullDestPath), { recursive: true });
            await fs.promises.copyFile(fullSourcePath, fullDestPath);
            return {
                success: true,
                filePath: fullDestPath
            };
        }
        catch (error) {
            return {
                success: false,
                filePath: destPath,
                error: error instanceof Error ? error.message : 'Unknown error'
            };
        }
    }
    async listFiles(dirPath) {
        try {
            const fullPath = path.resolve(this.workspacePath, dirPath);
            const files = await fs.promises.readdir(fullPath);
            return files.map(file => path.join(dirPath, file));
        }
        catch (error) {
            this.outputChannel.appendLine(`Error listing files in ${dirPath}: ${error}`);
            return [];
        }
    }
    getWorkspacePath() {
        return this.workspacePath;
    }
    getRelativePath(absolutePath) {
        return path.relative(this.workspacePath, absolutePath);
    }
    getAbsolutePath(relativePath) {
        return path.resolve(this.workspacePath, relativePath);
    }
    dispose() {
        this.watchers.forEach(watcher => watcher.close());
        this.watchers = [];
    }
}
exports.FileManager = FileManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9maWxlTWFuYWdlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBQzdCLCtDQUFpQztBQWlCakMsTUFBYSxXQUFXO0lBQ2QsYUFBYSxDQUF1QjtJQUNwQyxhQUFhLENBQVM7SUFDdEIsZUFBZSxDQUFTO0lBQ3hCLFFBQVEsR0FBbUIsRUFBRSxDQUFDO0lBRXRDLFlBQVksYUFBbUM7UUFDN0MsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDOUUsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUN6RSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsOEJBQThCO0lBQ3ZCLGtCQUFrQjtRQUN2QixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDOUIsQ0FBQztJQUVNLHFCQUFxQjtRQUMxQixJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztZQUN6QyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO0lBQ0gsQ0FBQztJQUVELDBCQUEwQjtJQUNuQixLQUFLLENBQUMscUJBQXFCLENBQUMsS0FBZTtRQUNoRCxNQUFNLFdBQVcsR0FBMkIsRUFBRSxDQUFDO1FBRS9DLEtBQUssTUFBTSxJQUFJLElBQUks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QU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRU0sZUFBZSxDQUFDLFlBQW9CO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFTSxlQUFlLENBQUMsWUFBb0I7UUFDekMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7Q0FDRjtBQS9URCxrQ0ErVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9maWxlTWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgdnNjb2RlIGZyb20gJ3ZzY29kZSc7XG5pbXBvcnQgeyBPdXRwdXRUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVPcGVyYXRpb25SZXN1bHQge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBmaWxlUGF0aD86IHN0cmluZztcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIGNvbnRlbnQ/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZVN0YXRzIHtcbiAgc2l6ZTogbnVtYmVyO1xuICBjcmVhdGVkOiBEYXRlO1xuICBtb2RpZmllZDogRGF0ZTtcbiAgYWNjZXNzZWQ6IERhdGU7XG59XG5cbmV4cG9ydCBjbGFzcyBGaWxlTWFuYWdlciB7XG4gIHByaXZhdGUgb3V0cHV0Q2hhbm5lbDogdnNjb2RlLk91dHB1dENoYW5uZWw7XG4gIHByaXZhdGUgd29ya3NwYWNlUGF0aDogc3RyaW5nO1xuICBwcml2YXRlIG91dHB1dERpcmVjdG9yeTogc3RyaW5nO1xuICBwcml2YXRlIHdhdGNoZXJzOiBmcy5GU1dhdGNoZXJbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKG91dHB1dENoYW5uZWw6IHZzY29kZS5PdXRwdXRDaGFubmVsKSB7XG4gICAgdGhpcy5vdXRwdXRDaGFubmVsID0gb3V0cHV0Q2hhbm5lbDtcbiAgICB0aGlzLndvcmtzcGFjZVBhdGggPSB2c2NvZGUud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnM/LlswXT8udXJpLmZzUGF0aCB8fCAnJztcbiAgICB0aGlzLm91dHB1dERpcmVjdG9yeSA9IHBhdGguam9pbih0aGlzLndvcmtzcGFjZVBhdGgsICcuYWktZGVidWctb3V0cHV0Jyk7XG4gICAgdGhpcy5lbnN1cmVPdXRwdXREaXJlY3RvcnkoKTtcbiAgfVxuXG4gIC8vIE91dHB1dCBkaXJlY3RvcnkgbWFuYWdlbWVudFxuICBwdWJsaWMgZ2V0T3V0cHV0RGlyZWN0b3J5KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub3V0cHV0RGlyZWN0b3J5O1xuICB9XG5cbiAgcHVibGljIGVuc3VyZU91dHB1dERpcmVjdG9yeSgpOiB2b2lkIHtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmModGhpcy5vdXRwdXREaXJlY3RvcnkpKSB7XG4gICAgICBmcy5ta2RpclN5bmModGhpcy5vdXRwdXREaXJlY3RvcnksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIEluaXRpYWxpemUgb3V0cHV0IGZpbGVzXG4gIHB1YmxpYyBhc3luYyBpbml0aWFsaXplT3V0cHV0RmlsZXModHlwZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiB7XG4gICAgY29uc3Qgb3V0cHV0RmlsZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IHR5cGUgb2YgdHlwZXMpIHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRPdXRwdXRGaWxlUGF0aCh0eXBlKTtcbiAgICAgIG91dHB1dEZpbGVzW3R5cGVdID0gZmlsZVBhdGg7XG4gICAgICBcbiAgICAgIC8vIENyZWF0ZSBlbXB0eSBmaWxlIGlmIGl0IGRvZXNuJ3QgZXhpc3RcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKGZpbGVQYXRoLCAnJywgJ3V0ZjgnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG91dHB1dEZpbGVzO1xuICB9XG5cbiAgLy8gR2V0IG91dHB1dCBmaWxlIHBhdGhcbiAgcHVibGljIGdldE91dHB1dEZpbGVQYXRoKGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICghZmlsZU5hbWUuZW5kc1dpdGgoJy50eHQnKSkge1xuICAgICAgZmlsZU5hbWUgKz0gJy50eHQnO1xuICAgIH1cbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMub3V0cHV0RGlyZWN0b3J5LCBmaWxlTmFtZSk7XG4gIH1cblxuICAvLyBTYXZlIG91dHB1dCB0byBmaWxlXG4gIHB1YmxpYyBhc3luYyBzYXZlT3V0cHV0KHR5cGU6IE91dHB1dFR5cGUsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRPdXRwdXRGaWxlUGF0aCh0eXBlKTtcbiAgICAgIGF3YWl0IGZzLnByb21pc2VzLndyaXRlRmlsZShmaWxlUGF0aCwgY29udGVudCwgJ3V0ZjgnKTtcbiAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGBTYXZlZCAke3R5cGV9IG91dHB1dCB0bzogJHtmaWxlUGF0aH1gKTtcbiAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGBGYWlsZWQgdG8gc2F2ZSAke3R5cGV9IG91dHB1dDogJHtlcnJvcn1gO1xuICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUobWVzc2FnZSk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gR2V0IGZpbGUgY29udGVudFxuICBwdWJsaWMgYXN5bmMgZ2V0RmlsZUNvbnRlbnQodHlwZTogT3V0cHV0VHlwZSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRPdXRwdXRGaWxlUGF0aCh0eXBlKTtcbiAgICAgIFxuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0ZjgnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUoYEVycm9yIHJlYWRpbmcgJHt0eXBlfSBmaWxlOiAke2Vycm9yfWApO1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBmaWxlIHBhdGhcbiAgcHVibGljIGdldEZpbGVQYXRoKHR5cGU6IE91dHB1dFR5cGUpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmdldE91dHB1dEZpbGVQYXRoKHR5cGUpO1xuICB9XG5cbiAgLy8gR2V0IGZpbGUgbW9kaWZpY2F0aW9uIHRpbWVcbiAgcHVibGljIGdldEZpbGVNb2RUaW1lKHR5cGU6IE91dHB1dFR5cGUpOiBEYXRlIHwgbnVsbCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gdGhpcy5nZXRPdXRwdXRGaWxlUGF0aCh0eXBlKTtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMoZmlsZVBhdGgpO1xuICAgICAgcmV0dXJuIHN0YXRzLm10aW1lO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLm91dHB1dENoYW5uZWwuYXBwZW5kTGluZShgRXJyb3IgZ2V0dGluZyBtb2QgdGltZSBmb3IgJHt0eXBlfTogJHtlcnJvcn1gKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldCBmaWxlIHN0YXRzXG4gIHB1YmxpYyBhc3luYyBnZXRGaWxlU3RhdHMoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8RmlsZVN0YXRzIHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzLnByb21pc2VzLnN0YXQoZmlsZVBhdGgpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2l6ZTogc3RhdHMuc2l6ZSxcbiAgICAgICAgY3JlYXRlZDogc3RhdHMuYmlydGh0aW1lLFxuICAgICAgICBtb2RpZmllZDogc3RhdHMubXRpbWUsXG4gICAgICAgIGFjY2Vzc2VkOiBzdGF0cy5hdGltZVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUoYEVycm9yIGdldHRpbmcgZmlsZSBzdGF0cyBmb3IgJHtmaWxlUGF0aH06ICR7ZXJyb3J9YCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvLyBHZXQgYWxsIG91dHB1dCBmaWxlc1xuICBwdWJsaWMgZ2V0QWxsT3V0cHV0RmlsZXMoKTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gICAgY29uc3QgZmlsZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3V0cHV0RmlsZXMgPSBmcy5yZWFkZGlyU3luYyh0aGlzLm91dHB1dERpcmVjdG9yeSk7XG4gICAgICBcbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBvdXRwdXRGaWxlcykge1xuICAgICAgICBpZiAoZmlsZS5lbmRzV2l0aCgnLnR4dCcpKSB7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IGZpbGUucmVwbGFjZSgnLnR4dCcsICcnKTtcbiAgICAgICAgICBmaWxlc1tuYW1lXSA9IHBhdGguam9pbih0aGlzLm91dHB1dERpcmVjdG9yeSwgZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUoYEVycm9yIHJlYWRpbmcgb3V0cHV0IGRpcmVjdG9yeTogJHtlcnJvcn1gKTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGZpbGVzO1xuICB9XG5cbiAgLy8gQ2xlYW51cCBvbGQgZmlsZXNcbiAgcHVibGljIGFzeW5jIGNsZWFudXBPbGRGaWxlcyhtYXhBZ2U6IG51bWJlciA9IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmModGhpcy5vdXRwdXREaXJlY3RvcnkpO1xuICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgIFxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHRoaXMub3V0cHV0RGlyZWN0b3J5LCBmaWxlKTtcbiAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhmaWxlUGF0aCk7XG4gICAgICAgIFxuICAgICAgICBpZiAobm93IC0gc3RhdHMubXRpbWUuZ2V0VGltZSgpID4gbWF4QWdlKSB7XG4gICAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMudW5saW5rKGZpbGVQYXRoKTtcbiAgICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwuYXBwZW5kTGluZShgQ2xlYW5lZCB1cCBvbGQgZmlsZTogJHtmaWxlfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGBFcnJvciBjbGVhbmluZyB1cCBvbGQgZmlsZXM6ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9XG5cbiAgLy8gQ29weSB0byBjbGlwYm9hcmRcbiAgcHVibGljIGFzeW5jIGNvcHlUb0NsaXBib2FyZCh0eXBlOiBPdXRwdXRUeXBlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmdldEZpbGVDb250ZW50KHR5cGUpO1xuICAgICAgYXdhaXQgdnNjb2RlLmVudi5jbGlwYm9hcmQud3JpdGVUZXh0KGNvbnRlbnQpO1xuICAgICAgdnNjb2RlLndpbmRvdy5zaG93SW5mb3JtYXRpb25NZXNzYWdlKGAke3R5cGV9IGNvbnRlbnQgY29waWVkIHRvIGNsaXBib2FyZGApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB2c2NvZGUud2luZG93LnNob3dFcnJvck1lc3NhZ2UoYEZhaWxlZCB0byBjb3B5ICR7dHlwZX0gdG8gY2xpcGJvYXJkOiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIE9wZW4gZmlsZSBpbiBlZGl0b3JcbiAgcHVibGljIGFzeW5jIG9wZW5GaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZG9jdW1lbnQgPSBhd2FpdCB2c2NvZGUud29ya3NwYWNlLm9wZW5UZXh0RG9jdW1lbnQoZmlsZVBhdGgpO1xuICAgICAgYXdhaXQgdnNjb2RlLndpbmRvdy5zaG93VGV4dERvY3VtZW50KGRvY3VtZW50KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdnNjb2RlLndpbmRvdy5zaG93RXJyb3JNZXNzYWdlKGBGYWlsZWQgdG8gb3BlbiBmaWxlOiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIFdhdGNoIGZpbGVzIGZvciBjaGFuZ2VzXG4gIHB1YmxpYyB3YXRjaEZpbGVzKGNhbGxiYWNrOiAoZmlsZVBhdGg6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcpID0+IHZvaWQpOiB2c2NvZGUuRGlzcG9zYWJsZSB7XG4gICAgY29uc3Qgd2F0Y2hlciA9IGZzLndhdGNoKHRoaXMub3V0cHV0RGlyZWN0b3J5LCAoZXZlbnRUeXBlLCBmaWxlbmFtZSkgPT4ge1xuICAgICAgaWYgKGZpbGVuYW1lKSB7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKHRoaXMub3V0cHV0RGlyZWN0b3J5LCBmaWxlbmFtZSk7XG4gICAgICAgIGNhbGxiYWNrKGZpbGVQYXRoLCBldmVudFR5cGUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIFxuICAgIHRoaXMud2F0Y2hlcnMucHVzaCh3YXRjaGVyKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMud2F0Y2hlcnMuaW5kZXhPZih3YXRjaGVyKTtcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICB0aGlzLndhdGNoZXJzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICAgICAgd2F0Y2hlci5jbG9zZSgpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICAvLyBCYXNpYyBmaWxlIG9wZXJhdGlvbnNcbiAgcHVibGljIGFzeW5jIHJlYWRGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVPcGVyYXRpb25SZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy53b3Jrc3BhY2VQYXRoLCBmaWxlUGF0aCk7XG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZnVsbFBhdGgsICd1dGY4Jyk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBmaWxlUGF0aDogZnVsbFBhdGgsXG4gICAgICAgIGNvbnRlbnRcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB3cml0ZUZpbGUoZmlsZVBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogUHJvbWlzZTxGaWxlT3BlcmF0aW9uUmVzdWx0PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMud29ya3NwYWNlUGF0aCwgZmlsZVBhdGgpO1xuICAgICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICBhd2FpdCBmcy5wcm9taXNlcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQsICd1dGY4Jyk7XG4gICAgICBcbiAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGBGaWxlIHdyaXR0ZW46ICR7ZnVsbFBhdGh9YCk7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGZpbGVQYXRoOiBmdWxsUGF0aFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGZpbGVQYXRoLFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcidcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGVuc3VyZURpcmVjdG9yeUV4aXN0cyhkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLndvcmtzcGFjZVBhdGgsIGRpclBhdGgpO1xuICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKGZ1bGxQYXRoLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmaWxlRXhpc3RzKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy53b3Jrc3BhY2VQYXRoLCBmaWxlUGF0aCk7XG4gICAgICBhd2FpdCBmcy5wcm9taXNlcy5hY2Nlc3MoZnVsbFBhdGgpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZUZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8RmlsZU9wZXJhdGlvblJlc3VsdD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLndvcmtzcGFjZVBhdGgsIGZpbGVQYXRoKTtcbiAgICAgIGF3YWl0IGZzLnByb21pc2VzLnVubGluayhmdWxsUGF0aCk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBmaWxlUGF0aDogZnVsbFBhdGhcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjb3B5RmlsZShzb3VyY2VQYXRoOiBzdHJpbmcsIGRlc3RQYXRoOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVPcGVyYXRpb25SZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZnVsbFNvdXJjZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy53b3Jrc3BhY2VQYXRoLCBzb3VyY2VQYXRoKTtcbiAgICAgIGNvbnN0IGZ1bGxEZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLndvcmtzcGFjZVBhdGgsIGRlc3RQYXRoKTtcbiAgICAgIFxuICAgICAgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIocGF0aC5kaXJuYW1lKGZ1bGxEZXN0UGF0aCksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgYXdhaXQgZnMucHJvbWlzZXMuY29weUZpbGUoZnVsbFNvdXJjZVBhdGgsIGZ1bGxEZXN0UGF0aCk7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGZpbGVQYXRoOiBmdWxsRGVzdFBhdGhcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBmaWxlUGF0aDogZGVzdFBhdGgsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdEZpbGVzKGRpclBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy53b3Jrc3BhY2VQYXRoLCBkaXJQYXRoKTtcbiAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZGRpcihmdWxsUGF0aCk7XG4gICAgICByZXR1cm4gZmlsZXMubWFwKGZpbGUgPT4gcGF0aC5qb2luKGRpclBhdGgsIGZpbGUpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUoYEVycm9yIGxpc3RpbmcgZmlsZXMgaW4gJHtkaXJQYXRofTogJHtlcnJvcn1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0V29ya3NwYWNlUGF0aCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLndvcmtzcGFjZVBhdGg7XG4gIH1cblxuICBwdWJsaWMgZ2V0UmVsYXRpdmVQYXRoKGFic29sdXRlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcGF0aC5yZWxhdGl2ZSh0aGlzLndvcmtzcGFjZVBhdGgsIGFic29sdXRlUGF0aCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0QWJzb2x1dGVQYXRoKHJlbGF0aXZlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKHRoaXMud29ya3NwYWNlUGF0aCwgcmVsYXRpdmVQYXRoKTtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRoaXMud2F0Y2hlcnMuZm9yRWFjaCh3YXRjaGVyID0+IHdhdGNoZXIuY2xvc2UoKSk7XG4gICAgdGhpcy53YXRjaGVycyA9IFtdO1xuICB9XG59Il0sInZlcnNpb24iOjN9