7ece366023d568789f3dfeaf7351c0b0
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectDetector = void 0;
const vscode = __importStar(require("vscode"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs"));
class ProjectDetector {
    _workspacePath;
    _cache = new Map();
    constructor(_workspacePath) {
        this._workspacePath = _workspacePath;
    }
    // Find NX workspace configuration
    async findNxWorkspace() {
        try {
            const nxConfigPath = path.join(this._workspacePath, 'nx.json');
            const angularConfigPath = path.join(this._workspacePath, 'angular.json');
            if (fs.existsSync(nxConfigPath)) {
                return nxConfigPath;
            }
            if (fs.existsSync(angularConfigPath)) {
                return angularConfigPath;
            }
            return null;
        }
        catch (error) {
            console.error('Error finding workspace configuration:', error);
            return null;
        }
    }
    // Get all projects
    async getProjects() {
        return this.detectProjects();
    }
    // Get specific project by name
    async getProject(name) {
        const projects = await this.detectProjects();
        return projects.find(project => project.name === name) || null;
    }
    // Check if project has a specific target
    async hasTarget(projectName, targetName) {
        const project = await this.getProject(projectName);
        return project?.targets?.[targetName] !== undefined;
    }
    // Get workspace root
    getWorkspaceRoot() {
        return this._workspacePath;
    }
    // Legacy method name for compatibility
    async detectCurrentProject() {
        return this.getCurrentProject();
    }
    async detectProjects() {
        const cacheKey = this._workspacePath;
        if (this._cache.has(cacheKey)) {
            return this._cache.get(cacheKey);
        }
        const projects = await this._scanForProjects();
        this._cache.set(cacheKey, projects);
        return projects;
    }
    async _scanForProjects() {
        const projects = [];
        try {
            // Check for NX workspace
            const nxConfigPath = path.join(this._workspacePath, 'nx.json');
            if (fs.existsSync(nxConfigPath)) {
                const nxProjects = await this._detectNxProjects();
                projects.push(...nxProjects);
            }
            // Check for Angular workspace
            const angularConfigPath = path.join(this._workspacePath, 'angular.json');
            if (fs.existsSync(angularConfigPath)) {
                const angularProjects = await this._detectAngularProjects();
                projects.push(...angularProjects);
            }
            // Fallback to npm projects
            if (projects.length === 0) {
                const npmProjects = await this._detectNpmProjects();
                projects.push(...npmProjects);
            }
        }
        catch (error) {
            console.error('Error detecting projects:', error);
        }
        return projects;
    }
    async _detectNxProjects() {
        const projects = [];
        const nxConfigPath = path.join(this._workspacePath, 'nx.json');
        try {
            const nxConfig = JSON.parse(fs.readFileSync(nxConfigPath, 'utf8'));
            // Check for projects in nx.json
            if (nxConfig.projects) {
                for (const [name, projectPath] of Object.entries(nxConfig.projects)) {
                    const fullPath = path.join(this._workspacePath, projectPath);
                    const packageJsonPath = path.join(fullPath, 'package.json');
                    if (fs.existsSync(packageJsonPath)) {
                        projects.push({
                            name,
                            root: fullPath,
                            type: 'nx',
                            packageJsonPath,
                            configPath: nxConfigPath,
                            projectType: 'application' // Default
                        });
                    }
                }
            }
            // Check for project.json files
            const projectJsonPaths = await this._findProjectJsonFiles();
            for (const projectJsonPath of projectJsonPaths) {
                const projectConfig = JSON.parse(fs.readFileSync(projectJsonPath, 'utf8'));
                const projectDir = path.dirname(projectJsonPath);
                const projectName = path.basename(projectDir);
                projects.push({
                    name: projectName,
                    root: projectDir,
                    type: 'nx',
                    packageJsonPath: path.join(projectDir, 'package.json'),
                    configPath: projectJsonPath,
                    projectType: projectConfig.projectType || 'application',
                    targets: projectConfig.targets
                });
            }
        }
        catch (error) {
            console.error('Error detecting NX projects:', error);
        }
        return projects;
    }
    async _detectAngularProjects() {
        const projects = [];
        const angularConfigPath = path.join(this._workspacePath, 'angular.json');
        try {
            const angularConfig = JSON.parse(fs.readFileSync(angularConfigPath, 'utf8'));
            if (angularConfig.projects) {
                for (const [name, projectConfig] of Object.entries(angularConfig.projects)) {
                    const config = projectConfig;
                    const projectRoot = path.join(this._workspacePath, config.root || '');
                    const packageJsonPath = path.join(projectRoot, 'package.json');
                    projects.push({
                        name,
                        root: projectRoot,
                        type: 'angular',
                        packageJsonPath,
                        configPath: angularConfigPath,
                        projectType: config.projectType || 'application',
                        targets: config.architect
                    });
                }
            }
        }
        catch (error) {
            console.error('Error detecting Angular projects:', error);
        }
        return projects;
    }
    async _detectNpmProjects() {
        const projects = [];
        const packageJsonPath = path.join(this._workspacePath, 'package.json');
        if (fs.existsSync(packageJsonPath)) {
            try {
                const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
                projects.push({
                    name: packageJson.name || 'root',
                    root: this._workspacePath,
                    type: 'npm',
                    packageJsonPath,
                    projectType: 'application',
                    targets: packageJson.scripts ? Object.keys(packageJson.scripts).reduce((acc, script) => {
                        acc[script] = { executor: 'npm', options: { command: script } };
                        return acc;
                    }, {}) : undefined
                });
            }
            catch (error) {
                console.error('Error detecting npm project:', error);
            }
        }
        return projects;
    }
    async _findProjectJsonFiles() {
        const projectJsonFiles = [];
        const findFiles = (dir) => {
            const files = fs.readdirSync(dir);
            for (const file of files) {
                const fullPath = path.join(dir, file);
                const stat = fs.statSync(fullPath);
                if (stat.isDirectory() && !file.startsWith('.') && file !== 'node_modules') {
                    findFiles(fullPath);
                }
                else if (file === 'project.json') {
                    projectJsonFiles.push(fullPath);
                }
            }
        };
        try {
            findFiles(this._workspacePath);
        }
        catch (error) {
            console.error('Error finding project.json files:', error);
        }
        return projectJsonFiles;
    }
    clearCache() {
        this._cache.clear();
    }
    async getCurrentProject() {
        const activeEditor = vscode.window.activeTextEditor;
        if (!activeEditor) {
            return undefined;
        }
        const activeFilePath = activeEditor.document.uri.fsPath;
        const projects = await this.detectProjects();
        // Find the project that contains the active file
        return projects.find(project => activeFilePath.startsWith(project.root));
    }
}
exports.ProjectDetector = ProjectDetector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9wcm9qZWN0RGV0ZWN0b3IudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0NBQWlDO0FBQ2pDLDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFZekIsTUFBYSxlQUFlO0lBR0s7SUFGckIsTUFBTSxHQUErQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRXZELFlBQTZCLGNBQXNCO1FBQXRCLG1CQUFjLEdBQWQsY0FBYyxDQUFRO0lBQUcsQ0FBQztJQUV2RCxrQ0FBa0M7SUFDM0IsS0FBSyxDQUFDLGVBQWU7UUFDeEIsSUFBSSxDQUFDO1lBQ0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQy9ELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBRXpFLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO2dCQUM5QixPQUFPLFlBQVksQ0FBQztZQUN4QixDQUFDO1lBRUQsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztnQkFDbkMsT0FBTyxpQkFBaUIsQ0FBQztZQUM3QixDQUFDO1lBRUQsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQy9ELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO0lBRUQsbUJBQW1CO0lBQ1osS0FBSyxDQUFDLFdBQVc7UUFDcEIsT0FBTyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVELCtCQUEr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VXNlcnMvZ3JlZ2R1bm4vc3JjL3Rlc3QvYWlfZGVidWdfY29udGV4dC92c2NvZGUvc3JjL3V0aWxzL3Byb2plY3REZXRlY3Rvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB2c2NvZGUgZnJvbSAndnNjb2RlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvamVjdEluZm8ge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICByb290OiBzdHJpbmc7XG4gICAgdHlwZTogJ254JyB8ICdhbmd1bGFyJyB8ICducG0nO1xuICAgIHBhY2thZ2VKc29uUGF0aDogc3RyaW5nO1xuICAgIGNvbmZpZ1BhdGg/OiBzdHJpbmc7XG4gICAgcHJvamVjdFR5cGU/OiAnYXBwbGljYXRpb24nIHwgJ2xpYnJhcnknOyAvLyBBZGRlZCBmb3IgY29tcGF0aWJpbGl0eVxuICAgIHRhcmdldHM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufVxuXG5leHBvcnQgY2xhc3MgUHJvamVjdERldGVjdG9yIHtcbiAgICBwcml2YXRlIF9jYWNoZTogTWFwPHN0cmluZywgUHJvamVjdEluZm9bXT4gPSBuZXcgTWFwKCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IF93b3Jrc3BhY2VQYXRoOiBzdHJpbmcpIHt9XG5cbiAgICAvLyBGaW5kIE5YIHdvcmtzcGFjZSBjb25maWd1cmF0aW9uXG4gICAgcHVibGljIGFzeW5jIGZpbmROeFdvcmtzcGFjZSgpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG54Q29uZmlnUGF0aCA9IHBhdGguam9pbih0aGlzLl93b3Jrc3BhY2VQYXRoLCAnbnguanNvbicpO1xuICAgICAgICAgICAgY29uc3QgYW5ndWxhckNvbmZpZ1BhdGggPSBwYXRoLmpvaW4odGhpcy5fd29ya3NwYWNlUGF0aCwgJ2FuZ3VsYXIuanNvbicpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhueENvbmZpZ1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG54Q29uZmlnUGF0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoYW5ndWxhckNvbmZpZ1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXJDb25maWdQYXRoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZpbmRpbmcgd29ya3NwYWNlIGNvbmZpZ3VyYXRpb246JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBHZXQgYWxsIHByb2plY3RzXG4gICAgcHVibGljIGFzeW5jIGdldFByb2plY3RzKCk6IFByb21pc2U8UHJvamVjdEluZm9bXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kZXRlY3RQcm9qZWN0cygpO1xuICAgIH1cblxuICAgIC8vIEdldCBzcGVjaWZpYyBwcm9qZWN0IGJ5IG5hbWVcbiAgICBwdWJsaWMgYXN5bmMgZ2V0UHJvamVjdChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPFByb2plY3RJbmZvIHwgbnVsbD4ge1xuICAgICAgICBjb25zdCBwcm9qZWN0cyA9IGF3YWl0IHRoaXMuZGV0ZWN0UHJvamVjdHMoKTtcbiAgICAgICAgcmV0dXJuIHByb2plY3RzLmZpbmQocHJvamVjdCA9PiBwcm9qZWN0Lm5hbWUgPT09IG5hbWUpIHx8IG51bGw7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgcHJvamVjdCBoYXMgYSBzcGVjaWZpYyB0YXJnZXRcbiAgICBwdWJsaWMgYXN5bmMgaGFzVGFyZ2V0KHByb2plY3ROYW1lOiBzdHJpbmcsIHRhcmdldE5hbWU6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgdGhpcy5nZXRQcm9qZWN0KHByb2plY3ROYW1lKTtcbiAgICAgICAgcmV0dXJuIHByb2plY3Q/LnRhcmdldHM/Llt0YXJnZXROYW1lXSAhPT0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIEdldCB3b3Jrc3BhY2Ugcm9vdFxuICAgIHB1YmxpYyBnZXRXb3Jrc3BhY2VSb290KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl93b3Jrc3BhY2VQYXRoO1xuICAgIH1cblxuICAgIC8vIExlZ2FjeSBtZXRob2QgbmFtZSBmb3IgY29tcGF0aWJpbGl0eVxuICAgIHB1YmxpYyBhc3luYyBkZXRlY3RDdXJyZW50UHJvamVjdCgpOiBQcm9taXNlPFByb2plY3RJbmZvIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRQcm9qZWN0KCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGRldGVjdFByb2plY3RzKCk6IFByb21pc2U8UHJvamVjdEluZm9bXT4ge1xuICAgICAgICBjb25zdCBjYWNoZUtleSA9IHRoaXMuX3dvcmtzcGFjZVBhdGg7XG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5fY2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlLmdldChjYWNoZUtleSkhO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcHJvamVjdHMgPSBhd2FpdCB0aGlzLl9zY2FuRm9yUHJvamVjdHMoKTtcbiAgICAgICAgdGhpcy5fY2FjaGUuc2V0KGNhY2hlS2V5LCBwcm9qZWN0cyk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gcHJvamVjdHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfc2NhbkZvclByb2plY3RzKCk6IFByb21pc2U8UHJvamVjdEluZm9bXT4ge1xuICAgICAgICBjb25zdCBwcm9qZWN0czogUHJvamVjdEluZm9bXSA9IFtdO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgTlggd29ya3NwYWNlXG4gICAgICAgICAgICBjb25zdCBueENvbmZpZ1BhdGggPSBwYXRoLmpvaW4odGhpcy5fd29ya3NwYWNlUGF0aCwgJ254Lmpzb24nKTtcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKG54Q29uZmlnUGF0aCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBueFByb2plY3RzID0gYXdhaXQgdGhpcy5fZGV0ZWN0TnhQcm9qZWN0cygpO1xuICAgICAgICAgICAgICAgIHByb2plY3RzLnB1c2goLi4ubnhQcm9qZWN0cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIENoZWNrIGZvciBBbmd1bGFyIHdvcmtzcGFjZVxuICAgICAgICAgICAgY29uc3QgYW5ndWxhckNvbmZpZ1BhdGggPSBwYXRoLmpvaW4odGhpcy5fd29ya3NwYWNlUGF0aCwgJ2FuZ3VsYXIuanNvbicpO1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoYW5ndWxhckNvbmZpZ1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYW5ndWxhclByb2plY3RzID0gYXdhaXQgdGhpcy5fZGV0ZWN0QW5ndWxhclByb2plY3RzKCk7XG4gICAgICAgICAgICAgICAgcHJvamVjdHMucHVzaCguLi5hbmd1bGFyUHJvamVjdHMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBGYWxsYmFjayB0byBucG0gcHJvamVjdHNcbiAgICAgICAgICAgIGlmIChwcm9qZWN0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBucG1Qcm9qZWN0cyA9IGF3YWl0IHRoaXMuX2RldGVjdE5wbVByb2plY3RzKCk7XG4gICAgICAgICAgICAgICAgcHJvamVjdHMucHVzaCguLi5ucG1Qcm9qZWN0cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRldGVjdGluZyBwcm9qZWN0czonLCBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJvamVjdHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZGV0ZWN0TnhQcm9qZWN0cygpOiBQcm9taXNlPFByb2plY3RJbmZvW10+IHtcbiAgICAgICAgY29uc3QgcHJvamVjdHM6IFByb2plY3RJbmZvW10gPSBbXTtcbiAgICAgICAgY29uc3QgbnhDb25maWdQYXRoID0gcGF0aC5qb2luKHRoaXMuX3dvcmtzcGFjZVBhdGgsICdueC5qc29uJyk7XG4gICAgICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgbnhDb25maWcgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhueENvbmZpZ1BhdGgsICd1dGY4JykpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgcHJvamVjdHMgaW4gbnguanNvblxuICAgICAgICAgICAgaWYgKG54Q29uZmlnLnByb2plY3RzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgcHJvamVjdFBhdGhdIG9mIE9iamVjdC5lbnRyaWVzKG54Q29uZmlnLnByb2plY3RzKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguam9pbih0aGlzLl93b3Jrc3BhY2VQYXRoLCBwcm9qZWN0UGF0aCBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwYWNrYWdlSnNvblBhdGggPSBwYXRoLmpvaW4oZnVsbFBhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKHBhY2thZ2VKc29uUGF0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDogZnVsbFBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ254JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlSnNvblBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnUGF0aDogbnhDb25maWdQYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3RUeXBlOiAnYXBwbGljYXRpb24nIC8vIERlZmF1bHRcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgcHJvamVjdC5qc29uIGZpbGVzXG4gICAgICAgICAgICBjb25zdCBwcm9qZWN0SnNvblBhdGhzID0gYXdhaXQgdGhpcy5fZmluZFByb2plY3RKc29uRmlsZXMoKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcHJvamVjdEpzb25QYXRoIG9mIHByb2plY3RKc29uUGF0aHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0Q29uZmlnID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocHJvamVjdEpzb25QYXRoLCAndXRmOCcpKTtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0RGlyID0gcGF0aC5kaXJuYW1lKHByb2plY3RKc29uUGF0aCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvamVjdE5hbWUgPSBwYXRoLmJhc2VuYW1lKHByb2plY3REaXIpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb2plY3RzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9qZWN0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgcm9vdDogcHJvamVjdERpcixcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ254JyxcbiAgICAgICAgICAgICAgICAgICAgcGFja2FnZUpzb25QYXRoOiBwYXRoLmpvaW4ocHJvamVjdERpciwgJ3BhY2thZ2UuanNvbicpLFxuICAgICAgICAgICAgICAgICAgICBjb25maWdQYXRoOiBwcm9qZWN0SnNvblBhdGgsXG4gICAgICAgICAgICAgICAgICAgIHByb2plY3RUeXBlOiBwcm9qZWN0Q29uZmlnLnByb2plY3RUeXBlIHx8ICdhcHBsaWNhdGlvbicsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldHM6IHByb2plY3RDb25maWcudGFyZ2V0c1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZXRlY3RpbmcgTlggcHJvamVjdHM6JywgZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb2plY3RzO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2RldGVjdEFuZ3VsYXJQcm9qZWN0cygpOiBQcm9taXNlPFByb2plY3RJbmZvW10+IHtcbiAgICAgICAgY29uc3QgcHJvamVjdHM6IFByb2plY3RJbmZvW10gPSBbXTtcbiAgICAgICAgY29uc3QgYW5ndWxhckNvbmZpZ1BhdGggPSBwYXRoLmpvaW4odGhpcy5fd29ya3NwYWNlUGF0aCwgJ2FuZ3VsYXIuanNvbicpO1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGFuZ3VsYXJDb25maWcgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhhbmd1bGFyQ29uZmlnUGF0aCwgJ3V0ZjgnKSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChhbmd1bGFyQ29uZmlnLnByb2plY3RzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgcHJvamVjdENvbmZpZ10gb2YgT2JqZWN0LmVudHJpZXMoYW5ndWxhckNvbmZpZy5wcm9qZWN0cykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29uZmlnID0gcHJvamVjdENvbmZpZyBhcyBhbnk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3RSb290ID0gcGF0aC5qb2luKHRoaXMuX3dvcmtzcGFjZVBhdGgsIGNvbmZpZy5yb290IHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZUpzb25QYXRoID0gcGF0aC5qb2luKHByb2plY3RSb290LCAncGFja2FnZS5qc29uJyk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBwcm9qZWN0cy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICByb290OiBwcm9qZWN0Um9vdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdhbmd1bGFyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ1BhdGg6IGFuZ3VsYXJDb25maWdQYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvamVjdFR5cGU6IGNvbmZpZy5wcm9qZWN0VHlwZSB8fCAnYXBwbGljYXRpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0czogY29uZmlnLmFyY2hpdGVjdFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRldGVjdGluZyBBbmd1bGFyIHByb2plY3RzOicsIGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm9qZWN0cztcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9kZXRlY3ROcG1Qcm9qZWN0cygpOiBQcm9taXNlPFByb2plY3RJbmZvW10+IHtcbiAgICAgICAgY29uc3QgcHJvamVjdHM6IFByb2plY3RJbmZvW10gPSBbXTtcbiAgICAgICAgY29uc3QgcGFja2FnZUpzb25QYXRoID0gcGF0aC5qb2luKHRoaXMuX3dvcmtzcGFjZVBhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKHBhY2thZ2VKc29uUGF0aCkpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYWNrYWdlSnNvblBhdGgsICd1dGY4JykpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb2plY3RzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBwYWNrYWdlSnNvbi5uYW1lIHx8ICdyb290JyxcbiAgICAgICAgICAgICAgICAgICAgcm9vdDogdGhpcy5fd29ya3NwYWNlUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ25wbScsXG4gICAgICAgICAgICAgICAgICAgIHBhY2thZ2VKc29uUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgcHJvamVjdFR5cGU6ICdhcHBsaWNhdGlvbicsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldHM6IHBhY2thZ2VKc29uLnNjcmlwdHMgPyBPYmplY3Qua2V5cyhwYWNrYWdlSnNvbi5zY3JpcHRzKS5yZWR1Y2UoKGFjYywgc2NyaXB0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nbc2NyaXB0XSA9IHsgZXhlY3V0b3I6ICducG0nLCBvcHRpb25zOiB7IGNvbW1hbmQ6IHNjcmlwdCB9IH07XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgICAgICAgICAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KSA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGRldGVjdGluZyBucG0gcHJvamVjdDonLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJvamVjdHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluZFByb2plY3RKc29uRmlsZXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCBwcm9qZWN0SnNvbkZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZmluZEZpbGVzID0gKGRpcjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGRpcik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGZ1bGxQYXRoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpICYmICFmaWxlLnN0YXJ0c1dpdGgoJy4nKSAmJiBmaWxlICE9PSAnbm9kZV9tb2R1bGVzJykge1xuICAgICAgICAgICAgICAgICAgICBmaW5kRmlsZXMoZnVsbFBhdGgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsZSA9PT0gJ3Byb2plY3QuanNvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvamVjdEpzb25GaWxlcy5wdXNoKGZ1bGxQYXRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGZpbmRGaWxlcyh0aGlzLl93b3Jrc3BhY2VQYXRoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZpbmRpbmcgcHJvamVjdC5qc29uIGZpbGVzOicsIGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm9qZWN0SnNvbkZpbGVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbGVhckNhY2hlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9jYWNoZS5jbGVhcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRDdXJyZW50UHJvamVjdCgpOiBQcm9taXNlPFByb2plY3RJbmZvIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIGNvbnN0IGFjdGl2ZUVkaXRvciA9IHZzY29kZS53aW5kb3cuYWN0aXZlVGV4dEVkaXRvcjtcbiAgICAgICAgaWYgKCFhY3RpdmVFZGl0b3IpIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhY3RpdmVGaWxlUGF0aCA9IGFjdGl2ZUVkaXRvci5kb2N1bWVudC51cmkuZnNQYXRoO1xuICAgICAgICBjb25zdCBwcm9qZWN0cyA9IGF3YWl0IHRoaXMuZGV0ZWN0UHJvamVjdHMoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEZpbmQgdGhlIHByb2plY3QgdGhhdCBjb250YWlucyB0aGUgYWN0aXZlIGZpbGVcbiAgICAgICAgcmV0dXJuIHByb2plY3RzLmZpbmQocHJvamVjdCA9PiBcbiAgICAgICAgICAgIGFjdGl2ZUZpbGVQYXRoLnN0YXJ0c1dpdGgocHJvamVjdC5yb290KVxuICAgICAgICApO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=