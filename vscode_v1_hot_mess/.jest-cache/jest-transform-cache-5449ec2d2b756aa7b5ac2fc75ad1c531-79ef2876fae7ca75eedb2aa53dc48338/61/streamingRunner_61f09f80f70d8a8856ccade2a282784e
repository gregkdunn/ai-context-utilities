21d173c45883f02069d5d48e5c3c9953
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.StreamingCommandRunner = void 0;
const events_1 = require("events");
const child_process_1 = require("child_process");
const vscode = __importStar(require("vscode"));
class StreamingCommandRunner extends events_1.EventEmitter {
    _outputChannel;
    _activeProcess;
    _isRunning = false;
    _startTime;
    _currentOutput = '';
    _timeoutId;
    _forceKillTimeoutId;
    constructor(_outputChannel) {
        super();
        this._outputChannel = _outputChannel;
    }
    // Main execution method
    async executeWithStreaming(command, args, options = {}) {
        if (this._isRunning) {
            throw new Error('Command is already running');
        }
        this._isRunning = true;
        this._startTime = Date.now();
        this._currentOutput = '';
        try {
            return await this._executeCommand(command, args, options);
        }
        finally {
            this._cleanup();
        }
    }
    // Test command execution
    async executeTestCommand(command, args, cwd) {
        return this.executeWithStreaming(command, args, { cwd });
    }
    // Git command execution
    async executeGitCommand(args, cwd) {
        return this.executeWithStreaming('git', args, { cwd });
    }
    // Lint command execution
    async executeLintCommand(command, args, cwd) {
        return this.executeWithStreaming(command, args, { cwd });
    }
    async _executeCommand(command, args, options) {
        return new Promise((resolve, reject) => {
            this._activeProcess = (0, child_process_1.spawn)(command, args, {
                cwd: options.cwd || vscode.workspace.workspaceFolders?.[0]?.uri.fsPath,
                env: { ...process.env, ...options.env },
                stdio: ['pipe', 'pipe', 'pipe']
            });
            let output = '';
            let error = '';
            // FIX: Add error handling for stdout/stderr streams
            this._activeProcess.stdout?.on('data', (data) => {
                const text = data.toString();
                output += text;
                this._currentOutput += text;
                this.emit('output', text);
                this._outputChannel.append(text);
            });
            this._activeProcess.stdout?.on('error', (err) => {
                console.warn('stdout stream error:', err);
                // Don't reject here, let the process handle it
            });
            this._activeProcess.stderr?.on('data', (data) => {
                const text = data.toString();
                error += text;
                this._currentOutput += text;
                this.emit('error', text);
                this._outputChannel.append(text);
            });
            this._activeProcess.stderr?.on('error', (err) => {
                console.warn('stderr stream error:', err);
                // Don't reject here, let the process handle it
            });
            this._activeProcess.on('close', (code) => {
                const duration = Date.now() - (this._startTime || 0);
                // FIX: Clear timeout when process completes
                if (this._timeoutId) {
                    clearTimeout(this._timeoutId);
                    this._timeoutId = undefined;
                }
                const result = {
                    success: code === 0,
                    exitCode: code,
                    output,
                    error,
                    duration
                };
                this.emit('complete', result);
                resolve(result);
            });
            this._activeProcess.on('error', (err) => {
                const duration = Date.now() - (this._startTime || 0);
                // FIX: Clear timeout when process errors
                if (this._timeoutId) {
                    clearTimeout(this._timeoutId);
                    this._timeoutId = undefined;
                }
                const result = {
                    success: false,
                    exitCode: 1,
                    output,
                    error: err.message,
                    duration
                };
                this.emit('error', err.message);
                this.emit('complete', result);
                resolve(result); // Resolve instead of reject to maintain consistency
            });
            // FIX: Handle timeout properly
            if (options.timeout) {
                this._timeoutId = setTimeout(() => {
                    if (this._activeProcess && this._isRunning) {
                        console.log(`Command timed out after ${options.timeout}ms`);
                        this._cancelWithTimeout();
                        reject(new Error(`Command timed out after ${options.timeout}ms`));
                    }
                }, options.timeout);
            }
        });
    }
    cancel() {
        if (this._activeProcess && this._isRunning) {
            this._cancelWithTimeout();
        }
    }
    // FIX: Improved cancel with timeout handling
    _cancelWithTimeout() {
        if (!this._activeProcess) {
            return;
        }
        console.log('Cancelling command with SIGTERM');
        this._activeProcess.kill('SIGTERM');
        // FIX: Clear existing force kill timeout before setting new one
        if (this._forceKillTimeoutId) {
            clearTimeout(this._forceKillTimeoutId);
        }
        // Force kill after 5 seconds
        this._forceKillTimeoutId = setTimeout(() => {
            if (this._activeProcess) {
                console.log('Force killing command with SIGKILL');
                this._activeProcess.kill('SIGKILL');
            }
            this._forceKillTimeoutId = undefined;
        }, 5000);
    }
    // FIX: Comprehensive cleanup method
    _cleanup() {
        this._isRunning = false;
        this._activeProcess = undefined;
        if (this._timeoutId) {
            clearTimeout(this._timeoutId);
            this._timeoutId = undefined;
        }
        if (this._forceKillTimeoutId) {
            clearTimeout(this._forceKillTimeoutId);
            this._forceKillTimeoutId = undefined;
        }
    }
    get isRunning() {
        return this._isRunning;
    }
    getCurrentOutput() {
        return this._currentOutput;
    }
    clearOutput() {
        this._currentOutput = '';
    }
    simulateProgress(duration) {
        const interval = 100; // Update every 100ms
        const steps = duration / interval;
        let currentStep = 0;
        const progressInterval = setInterval(() => {
            // FIX: Stop progress simulation if command is no longer running
            if (!this._isRunning) {
                clearInterval(progressInterval);
                return;
            }
            currentStep++;
            const progress = Math.min(90, Math.floor((currentStep / steps) * 100)); // Cap at 90%
            this.emit('progress', progress);
            if (currentStep >= steps) {
                clearInterval(progressInterval);
            }
        }, interval);
    }
    dispose() {
        this.cancel();
        this._cleanup();
        this.removeAllListeners();
    }
}
exports.StreamingCommandRunner = StreamingCommandRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9zdHJlYW1pbmdSdW5uZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbUNBQXNDO0FBQ3RDLGlEQUFvRDtBQUNwRCwrQ0FBaUM7QUFXakMsTUFBYSxzQkFBdUIsU0FBUSxxQkFBWTtJQVF2QjtJQVByQixjQUFjLENBQWdCO0lBQzlCLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDbkIsVUFBVSxDQUFVO0lBQ3BCLGNBQWMsR0FBRyxFQUFFLENBQUM7SUFDcEIsVUFBVSxDQUFrQjtJQUM1QixtQkFBbUIsQ0FBa0I7SUFFN0MsWUFBNkIsY0FBb0M7UUFDN0QsS0FBSyxFQUFFLENBQUM7UUFEaUIsbUJBQWMsR0FBZCxjQUFjLENBQXNCO0lBRWpFLENBQUM7SUFFRCx3QkFBd0I7SUFDakIsS0FBSyxDQUFDLG9CQUFvQixDQUFDLE9BQWUsRUFBRSxJQUFjLEVBQUUsVUFBNEIsRUFBRTtRQUM3RixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUVELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBRXpCLElBQUksQ0FBQztZQUNELE9BQU8sTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUQsQ0FBQztnQkFBUyxDQUFDO1lBQ1AsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3BCLENBQUM7SUFDTCxDQUFDO0lBRUQseUJBQXlCO0lBQ2xCLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxPQUFlLEVBQUUs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QUksQ0FBQyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVNLFdBQVc7UUFDZCxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRU0sZ0JBQWdCLENBQUMsUUFBZ0I7UUFDcEMsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLENBQUMscUJBQXFCO1FBQzNDLE1BQU0sS0FBSyxHQUFHLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDbEMsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBRXBCLE1BQU0sZ0JBQWdCLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUN0QyxnRUFBZ0U7WUFDaEUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDbkIsYUFBYSxDQUFDLGdCQUFnQixDQUFDLENBQUM7Z0JBQ2hDLE9BQU87WUFDWCxDQUFDO1lBRUQsV0FBVyxFQUFFLENBQUM7WUFDZCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhO1lBRXJGLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRWhDLElBQUksV0FBVyxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUN2QixhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNwQyxDQUFDO1FBQ0wsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFFTSxPQUFPO1FBQ1YsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzlCLENBQUM7Q0FDSjtBQWxPRCx3REFrT0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9zdHJlYW1pbmdSdW5uZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHNwYXduLCBDaGlsZFByb2Nlc3MgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIHZzY29kZSBmcm9tICd2c2NvZGUnO1xuaW1wb3J0IHsgU3RyZWFtaW5nTWVzc2FnZSwgQ29tbWFuZFJlc3VsdCB9IGZyb20gJy4uL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBTdHJlYW1pbmdPcHRpb25zIHtcbiAgICBjd2Q/OiBzdHJpbmc7XG4gICAgZW52PzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgICB0aW1lb3V0PzogbnVtYmVyO1xuICAgIGtpbGxTaWduYWw/OiBzdHJpbmc7XG4gICAgcHJvZ3Jlc3NTdGVwcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgY2xhc3MgU3RyZWFtaW5nQ29tbWFuZFJ1bm5lciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgcHJpdmF0ZSBfYWN0aXZlUHJvY2Vzcz86IENoaWxkUHJvY2VzcztcbiAgICBwcml2YXRlIF9pc1J1bm5pbmcgPSBmYWxzZTtcbiAgICBwcml2YXRlIF9zdGFydFRpbWU/OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBfY3VycmVudE91dHB1dCA9ICcnO1xuICAgIHByaXZhdGUgX3RpbWVvdXRJZD86IE5vZGVKUy5UaW1lb3V0O1xuICAgIHByaXZhdGUgX2ZvcmNlS2lsbFRpbWVvdXRJZD86IE5vZGVKUy5UaW1lb3V0O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfb3V0cHV0Q2hhbm5lbDogdnNjb2RlLk91dHB1dENoYW5uZWwpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICAvLyBNYWluIGV4ZWN1dGlvbiBtZXRob2RcbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZVdpdGhTdHJlYW1pbmcoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSwgb3B0aW9uczogU3RyZWFtaW5nT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiB7XG4gICAgICAgIGlmICh0aGlzLl9pc1J1bm5pbmcpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tbWFuZCBpcyBhbHJlYWR5IHJ1bm5pbmcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2lzUnVubmluZyA9IHRydWU7XG4gICAgICAgIHRoaXMuX3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgIHRoaXMuX2N1cnJlbnRPdXRwdXQgPSAnJztcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2V4ZWN1dGVDb21tYW5kKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy5fY2xlYW51cCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gVGVzdCBjb21tYW5kIGV4ZWN1dGlvblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlVGVzdENvbW1hbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSwgY3dkPzogc3RyaW5nKTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVXaXRoU3RyZWFtaW5nKGNvbW1hbmQsIGFyZ3MsIHsgY3dkIH0pO1xuICAgIH1cblxuICAgIC8vIEdpdCBjb21tYW5kIGV4ZWN1dGlvblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlR2l0Q29tbWFuZChhcmdzOiBzdHJpbmdbXSwgY3dkPzogc3RyaW5nKTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGVXaXRoU3RyZWFtaW5nKCdnaXQnLCBhcmdzLCB7IGN3ZCB9KTtcbiAgICB9XG5cbiAgICAvLyBMaW50IGNvbW1hbmQgZXhlY3V0aW9uXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVMaW50Q29tbWFuZChjb21tYW5kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdLCBjd2Q/OiBzdHJpbmcpOiBQcm9taXNlPENvbW1hbmRSZXN1bHQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZVdpdGhTdHJlYW1pbmcoY29tbWFuZCwgYXJncywgeyBjd2QgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZXhlY3V0ZUNvbW1hbmQoY29tbWFuZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSwgb3B0aW9uczogU3RyZWFtaW5nT3B0aW9ucyk6IFByb21pc2U8Q29tbWFuZFJlc3VsdD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Q29tbWFuZFJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fYWN0aXZlUHJvY2VzcyA9IHNwYXduKGNvbW1hbmQsIGFyZ3MsIHtcbiAgICAgICAgICAgICAgICBjd2Q6IG9wdGlvbnMuY3dkIHx8IHZzY29kZS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycz8uWzBdPy51cmkuZnNQYXRoLFxuICAgICAgICAgICAgICAgIGVudjogeyAuLi5wcm9jZXNzLmVudiwgLi4ub3B0aW9ucy5lbnYgfSxcbiAgICAgICAgICAgICAgICBzdGRpbzogWydwaXBlJywgJ3BpcGUnLCAncGlwZSddXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IG91dHB1dCA9ICcnO1xuICAgICAgICAgICAgbGV0IGVycm9yID0gJyc7XG5cbiAgICAgICAgICAgIC8vIEZJWDogQWRkIGVycm9yIGhhbmRsaW5nIGZvciBzdGRvdXQvc3RkZXJyIHN0cmVhbXNcbiAgICAgICAgICAgIHRoaXMuX2FjdGl2ZVByb2Nlc3Muc3Rkb3V0Py5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIG91dHB1dCArPSB0ZXh0O1xuICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRPdXRwdXQgKz0gdGV4dDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ291dHB1dCcsIHRleHQpO1xuICAgICAgICAgICAgICAgIHRoaXMuX291dHB1dENoYW5uZWwuYXBwZW5kKHRleHQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2FjdGl2ZVByb2Nlc3Muc3Rkb3V0Py5vbignZXJyb3InLCAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignc3Rkb3V0IHN0cmVhbSBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgICAgICAgIC8vIERvbid0IHJlamVjdCBoZXJlLCBsZXQgdGhlIHByb2Nlc3MgaGFuZGxlIGl0XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fYWN0aXZlUHJvY2Vzcy5zdGRlcnI/Lm9uKCdkYXRhJywgKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgZXJyb3IgKz0gdGV4dDtcbiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50T3V0cHV0ICs9IHRleHQ7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIHRleHQpO1xuICAgICAgICAgICAgICAgIHRoaXMuX291dHB1dENoYW5uZWwuYXBwZW5kKHRleHQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2FjdGl2ZVByb2Nlc3Muc3RkZXJyPy5vbignZXJyb3InLCAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignc3RkZXJyIHN0cmVhbSBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgICAgICAgIC8vIERvbid0IHJlamVjdCBoZXJlLCBsZXQgdGhlIHByb2Nlc3MgaGFuZGxlIGl0XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5fYWN0aXZlUHJvY2Vzcy5vbignY2xvc2UnLCAoY29kZTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gKHRoaXMuX3N0YXJ0VGltZSB8fCAwKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBGSVg6IENsZWFyIHRpbWVvdXQgd2hlbiBwcm9jZXNzIGNvbXBsZXRlc1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl90aW1lb3V0SWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXRJZCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBDb21tYW5kUmVzdWx0ID0ge1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBjb2RlID09PSAwLFxuICAgICAgICAgICAgICAgICAgICBleGl0Q29kZTogY29kZSxcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LFxuICAgICAgICAgICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb25cbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjb21wbGV0ZScsIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuX2FjdGl2ZVByb2Nlc3Mub24oJ2Vycm9yJywgKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSAodGhpcy5fc3RhcnRUaW1lIHx8IDApO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEZJWDogQ2xlYXIgdGltZW91dCB3aGVuIHByb2Nlc3MgZXJyb3JzXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVvdXRJZCkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dElkKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGltZW91dElkID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQ6IENvbW1hbmRSZXN1bHQgPSB7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBleGl0Q29kZTogMSxcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjb21wbGV0ZScsIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOyAvLyBSZXNvbHZlIGluc3RlYWQgb2YgcmVqZWN0IHRvIG1haW50YWluIGNvbnNpc3RlbmN5XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gRklYOiBIYW5kbGUgdGltZW91dCBwcm9wZXJseVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudGltZW91dCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWN0aXZlUHJvY2VzcyAmJiB0aGlzLl9pc1J1bm5pbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDb21tYW5kIHRpbWVkIG91dCBhZnRlciAke29wdGlvbnMudGltZW91dH1tc2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FuY2VsV2l0aFRpbWVvdXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYENvbW1hbmQgdGltZWQgb3V0IGFmdGVyICR7b3B0aW9ucy50aW1lb3V0fW1zYCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgb3B0aW9ucy50aW1lb3V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbmNlbCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX2FjdGl2ZVByb2Nlc3MgJiYgdGhpcy5faXNSdW5uaW5nKSB7XG4gICAgICAgICAgICB0aGlzLl9jYW5jZWxXaXRoVGltZW91dCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gRklYOiBJbXByb3ZlZCBjYW5jZWwgd2l0aCB0aW1lb3V0IGhhbmRsaW5nXG4gICAgcHJpdmF0ZSBfY2FuY2VsV2l0aFRpbWVvdXQoKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5fYWN0aXZlUHJvY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coJ0NhbmNlbGxpbmcgY29tbWFuZCB3aXRoIFNJR1RFUk0nKTtcbiAgICAgICAgdGhpcy5fYWN0aXZlUHJvY2Vzcy5raWxsKCdTSUdURVJNJyk7XG4gICAgICAgIFxuICAgICAgICAvLyBGSVg6IENsZWFyIGV4aXN0aW5nIGZvcmNlIGtpbGwgdGltZW91dCBiZWZvcmUgc2V0dGluZyBuZXcgb25lXG4gICAgICAgIGlmICh0aGlzLl9mb3JjZUtpbGxUaW1lb3V0SWQpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLl9mb3JjZUtpbGxUaW1lb3V0SWQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBGb3JjZSBraWxsIGFmdGVyIDUgc2Vjb25kc1xuICAgICAgICB0aGlzLl9mb3JjZUtpbGxUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9hY3RpdmVQcm9jZXNzKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZvcmNlIGtpbGxpbmcgY29tbWFuZCB3aXRoIFNJR0tJTEwnKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9hY3RpdmVQcm9jZXNzLmtpbGwoJ1NJR0tJTEwnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2ZvcmNlS2lsbFRpbWVvdXRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfSwgNTAwMCk7XG4gICAgfVxuXG4gICAgLy8gRklYOiBDb21wcmVoZW5zaXZlIGNsZWFudXAgbWV0aG9kXG4gICAgcHJpdmF0ZSBfY2xlYW51cCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5faXNSdW5uaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2FjdGl2ZVByb2Nlc3MgPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5fdGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dElkKTtcbiAgICAgICAgICAgIHRoaXMuX3RpbWVvdXRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHRoaXMuX2ZvcmNlS2lsbFRpbWVvdXRJZCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2ZvcmNlS2lsbFRpbWVvdXRJZCk7XG4gICAgICAgICAgICB0aGlzLl9mb3JjZUtpbGxUaW1lb3V0SWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzUnVubmluZygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzUnVubmluZztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q3VycmVudE91dHB1dCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudE91dHB1dDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJPdXRwdXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2N1cnJlbnRPdXRwdXQgPSAnJztcbiAgICB9XG5cbiAgICBwdWJsaWMgc2ltdWxhdGVQcm9ncmVzcyhkdXJhdGlvbjogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGludGVydmFsID0gMTAwOyAvLyBVcGRhdGUgZXZlcnkgMTAwbXNcbiAgICAgICAgY29uc3Qgc3RlcHMgPSBkdXJhdGlvbiAvIGludGVydmFsO1xuICAgICAgICBsZXQgY3VycmVudFN0ZXAgPSAwO1xuXG4gICAgICAgIGNvbnN0IHByb2dyZXNzSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAvLyBGSVg6IFN0b3AgcHJvZ3Jlc3Mgc2ltdWxhdGlvbiBpZiBjb21tYW5kIGlzIG5vIGxvbmdlciBydW5uaW5nXG4gICAgICAgICAgICBpZiAoIXRoaXMuX2lzUnVubmluZykge1xuICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocHJvZ3Jlc3NJbnRlcnZhbCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdXJyZW50U3RlcCsrO1xuICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbig5MCwgTWF0aC5mbG9vcigoY3VycmVudFN0ZXAgLyBzdGVwcykgKiAxMDApKTsgLy8gQ2FwIGF0IDkwJVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb2dyZXNzJywgcHJvZ3Jlc3MpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoY3VycmVudFN0ZXAgPj0gc3RlcHMpIHtcbiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHByb2dyZXNzSW50ZXJ2YWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCBpbnRlcnZhbCk7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2FuY2VsKCk7XG4gICAgICAgIHRoaXMuX2NsZWFudXAoKTtcbiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICB9XG59Il0sInZlcnNpb24iOjN9