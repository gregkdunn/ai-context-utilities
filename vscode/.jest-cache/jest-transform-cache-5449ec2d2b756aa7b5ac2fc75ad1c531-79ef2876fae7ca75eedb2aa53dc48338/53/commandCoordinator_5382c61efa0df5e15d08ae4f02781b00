c98c5cb27f5f83a1d6a36d639a6b40ca
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommandCoordinator = void 0;
const events_1 = require("events");
const vscode = __importStar(require("vscode"));
const streamingRunner_1 = require("./streamingRunner");
/**
 * Coordinates command execution with real-time status tracking and streaming
 */
class CommandCoordinator extends events_1.EventEmitter {
    statusTracker;
    context;
    activeCommands = new Map();
    commandQueue = [];
    maxConcurrentCommands = 3;
    constructor(statusTracker, context) {
        super();
        this.statusTracker = statusTracker;
        this.context = context;
        // Listen to status tracker events
        this.statusTracker.on('status_change', (event) => {
            this.emit('status_update', event);
        });
    }
    /**
     * Execute a command with full status tracking and streaming
     */
    async executeCommand(command, args, options = {}) {
        // Check if we're at the concurrent limit
        if (this.activeCommands.size >= this.maxConcurrentCommands) {
            if (options.priority === 'high') {
                // Cancel lowest priority command for high priority
                this.cancelLowestPriorityCommand();
            }
            else {
                // Queue the command
                return this.queueCommand(command, args, options);
            }
        }
        const commandId = this.statusTracker.startCommand(command, options.project, options.commandOptions);
        try {
            return await this.executeCommandInternal(commandId, command, args, options);
        }
        catch (error) {
            this.statusTracker.updateStatus({ message: error instanceof Error ? error.message : 'Unknown error' });
            throw error;
        }
    }
    /**
     * Cancel a specific command
     */
    cancelCommand(commandId) {
        const runner = this.activeCommands.get(commandId);
        if (runner && runner.isRunning) {
            runner.cancel();
            this.statusTracker.cancelCommand(commandId);
            this.activeCommands.delete(commandId);
            this.processQueue(); // Process next queued command
            return true;
        }
        return false;
    }
    /**
     * Cancel all running commands
     */
    cancelAllCommands() {
        for (const [commandId, runner] of this.activeCommands) {
            if (runner.isRunning) {
                runner.cancel();
                this.statusTracker.cancelCommand(commandId);
            }
        }
        this.activeCommands.clear();
        this.commandQueue = [];
    }
    /**
     * Get current execution status
     */
    getExecutionStatus() {
        return {
            active: this.activeCommands.size,
            queued: this.commandQueue.length,
            maxConcurrent: this.maxConcurrentCommands,
            commands: this.statusTracker.getAllStatuses()
        };
    }
    /**
     * Set maximum concurrent commands
     */
    setMaxConcurrentCommands(max) {
        this.maxConcurrentCommands = Math.max(1, Math.min(10, max));
        // If we're over the limit, queue doesn't need immediate action
        // as commands will naturally complete and be processed
    }
    /**
     * Get streaming output for a command
     */
    getCommandOutput(commandId) {
        const runner = this.activeCommands.get(commandId);
        return runner?.getCurrentOutput() || '';
    }
    /**
     * Clear output for a command
     */
    clearCommandOutput(commandId) {
        const runner = this.activeCommands.get(commandId);
        if (runner) {
            runner.clearOutput();
        }
    }
    /**
     * Get detailed execution metrics
     */
    getExecutionMetrics() {
        const history = this.statusTracker.getHistory();
        const stats = this.statusTracker.getCommandStats();
        return {
            totalCommands: stats.total,
            successRate: stats.total > 0 ? (stats.successful / stats.total) * 100 : 0,
            averageExecutionTime: stats.averageDuration,
            concurrentPeak: this.maxConcurrentCommands, // Could track actual peak
            queueTimeAverage: 0 // Would need to track queue times
        };
    }
    /**
     * Create execution health report
     */
    createHealthReport() {
        const status = this.getExecutionStatus();
        const metrics = this.getExecutionMetrics();
        const now = new Date();
        return `
=================================================================
üè• COMMAND EXECUTION HEALTH REPORT
=================================================================

üìä Generated: ${now.toISOString()}
üîß System Status: ${status.active > 0 ? 'ACTIVE' : 'IDLE'}

=================================================================
üìà CURRENT STATUS
=================================================================

üîÑ Active Commands: ${status.active}/${status.maxConcurrent}
‚è≥ Queued Commands: ${status.queued}
üìä Total Executed: ${metrics.totalCommands}
‚úÖ Success Rate: ${metrics.successRate.toFixed(1)}%
‚è±Ô∏è  Avg Execution: ${(metrics.averageExecutionTime / 1000).toFixed(1)}s

=================================================================
üöÄ ACTIVE COMMANDS
=================================================================

${this.formatActiveCommands(status.commands)}

=================================================================
‚ö° PERFORMANCE METRICS
=================================================================

‚Ä¢ Concurrent Limit: ${status.maxConcurrent} commands
‚Ä¢ Queue Processing: ${status.queued > 0 ? 'PROCESSING' : 'IDLE'}
‚Ä¢ Memory Usage: ${this.getMemoryUsage()}
‚Ä¢ Uptime: ${this.getUptime()}

=================================================================
üí° RECOMMENDATIONS
=================================================================

${this.generateRecommendations(status, metrics)}

=================================================================
`;
    }
    // Private methods
    async executeCommandInternal(commandId, command, args, options) {
        const outputChannel = vscode.window.createOutputChannel('AI Debug Utilities');
        const runner = new streamingRunner_1.StreamingCommandRunner(outputChannel);
        this.activeCommands.set(commandId, runner);
        // Set up streaming event handlers
        runner.on('output', (output) => {
            this.statusTracker.appendOutput(commandId, output);
            this.emitStreamingMessage(commandId, 'output', { text: output });
        });
        runner.on('error', (error) => {
            this.statusTracker.appendError(commandId, error);
            this.emitStreamingMessage(commandId, 'error', { text: error });
        });
        runner.on('progress', (progress) => {
            this.statusTracker.updateProgress(commandId, progress);
            this.emitStreamingMessage(commandId, 'progress', { progress });
        });
        runner.on('status', (status) => {
            this.statusTracker.updateStatus({ message: status });
            this.emitStreamingMessage(commandId, 'status', { status });
        });
        try {
            // Execute based on command type with appropriate streaming
            let result;
            switch (command) {
                case 'nxTest':
                    result = await runner.executeTestCommand('npx', ['nx', 'test', ...args], options.cwd || process.cwd());
                    break;
                case 'gitDiff':
                    result = await runner.executeGitCommand(['diff', ...args], options.cwd || process.cwd());
                    break;
                case 'prepareToPush':
                    result = await runner.executeLintCommand('npx', ['nx', 'lint', ...args], options.cwd || process.cwd());
                    break;
                default:
                    // Generic command execution
                    result = await runner.executeWithStreaming(command, args, {
                        cwd: options.cwd
                    });
            }
            // Complete the command
            this.statusTracker.completeCommand(commandId, result);
            this.emitStreamingMessage(commandId, 'complete', { result });
            return result;
        }
        finally {
            // Clean up
            this.activeCommands.delete(commandId);
            runner.removeAllListeners();
            // Process next queued command
            this.processQueue();
        }
    }
    async queueCommand(command, args, options) {
        return new Promise((resolve, reject) => {
            const commandId = `queued-${Date.now()}`;
            this.commandQueue.push({
                id: commandId,
                command,
                args,
                options,
                resolve,
                reject
            });
            // Emit queue status update
            this.emit('queue_update', {
                queued: this.commandQueue.length,
                position: this.commandQueue.length
            });
        });
    }
    processQueue() {
        if (this.commandQueue.length === 0 || this.activeCommands.size >= this.maxConcurrentCommands) {
            return;
        }
        const next = this.commandQueue.shift();
        if (!next) {
            return;
        }
        // Execute the queued command
        this.executeCommand(next.command, next.args, next.options).then(next.resolve).catch(next.reject);
        // Update queue status
        this.emit('queue_update', {
            queued: this.commandQueue.length,
            processed: true
        });
    }
    cancelLowestPriorityCommand() {
        // Find running command with lowest priority (most recent for now)
        const commandIds = Array.from(this.activeCommands.keys());
        if (commandIds.length > 0) {
            const commandToCancel = commandIds[commandIds.length - 1]; // Most recent
            this.cancelCommand(commandToCancel);
        }
    }
    emitStreamingMessage(commandId, type, data) {
        const message = {
            type,
            data: {
                ...data,
                actionId: commandId
            },
            timestamp: new Date()
        };
        this.emit('streaming_message', message);
    }
    formatActiveCommands(commands) {
        const active = commands.filter(c => c.status === 'running');
        if (active.length === 0) {
            return '‚úÖ No commands currently active';
        }
        return active.map(cmd => {
            const elapsed = cmd.startTime ? Date.now() - cmd.startTime.getTime() : 0;
            const elapsedSeconds = Math.round(elapsed / 1000);
            return `üîÑ ${cmd.command || cmd.action}${cmd.project ? ` (${cmd.project})` : ''}
   Progress: ${cmd.progress}% | Elapsed: ${elapsedSeconds}s
   Status: ${cmd.message || cmd.output}
   ID: ${cmd.id.substring(0, 8)}...`;
        }).join('\n\n');
    }
    getMemoryUsage() {
        const usage = process.memoryUsage();
        return `${Math.round(usage.heapUsed / 1024 / 1024)}MB`;
    }
    getUptime() {
        const uptimeMs = process.uptime() * 1000;
        const hours = Math.floor(uptimeMs / (1000 * 60 * 60));
        const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}h ${minutes}m`;
    }
    generateRecommendations(status, metrics) {
        const recommendations = [];
        if (status.queued > 5) {
            recommendations.push('‚ö†Ô∏è  High queue backlog - consider increasing concurrent limit');
        }
        if (metrics.successRate < 80) {
            recommendations.push('üîß Low success rate - check command configurations');
        }
        if (metrics.averageExecutionTime > 60000) {
            recommendations.push('‚è∞ Long execution times - consider optimizing commands');
        }
        if (status.active === status.maxConcurrent) {
            recommendations.push('üìà At concurrent limit - monitor for bottlenecks');
        }
        if (recommendations.length === 0) {
            recommendations.push('‚úÖ System running optimally');
        }
        return recommendations.map((rec, i) => `${i + 1}. ${rec}`).join('\n');
    }
    /**
     * Dispose of resources
     */
    dispose() {
        this.cancelAllCommands();
        this.removeAllListeners();
    }
}
exports.CommandCoordinator = CommandCoordinator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy91dGlscy9jb21tYW5kQ29vcmRpbmF0b3IudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbUNBQXNDO0FBQ3RDLCtDQUFpQztBQUdqQyx1REFBMkQ7QUFHM0Q7O0dBRUc7QUFDSCxNQUFhLGtCQUFtQixTQUFRLHFCQUFZO0lBYXBDO0lBQ0E7SUFiSixjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQWtDLENBQUM7SUFDM0QsWUFBWSxHQU9mLEVBQUUsQ0FBQztJQUNBLHFCQUFxQixHQUFHLENBQUMsQ0FBQztJQUVsQyxZQUNZLGFBQTRCLEVBQzVCLE9BQWdDO1FBRXhDLEtBQUssRUFBRSxDQUFDO1FBSEEsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsWUFBTyxHQUFQLE9BQU8sQ0FBeUI7UUFJeEMsa0NBQWtDO1FBQ2xDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLGVBQWUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FDaEIsT0FBMkQsRUFDM0QsSUFBYyxFQUNkLFVBS0ksRUFBRTtRQUVOLHlDQUF5QztRQUN6QyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBQ3pELElBQUksT0FBTyxDQUFDLFFBQVEsS0FBSyxNQUFNLEVBQUUsQ0FBQztnQkFDOUIsbURBQW1EO2dCQUNuRCxJQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztZQUN2QyxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osb0JBQW9CO2dCQUNwQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFF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Z3JlZ2R1bm4vc3JjL3Rlc3QvYWlfZGVidWdfY29udGV4dC92c2NvZGUvc3JjL3V0aWxzL2NvbW1hbmRDb29yZGluYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0ICogYXMgdnNjb2RlIGZyb20gJ3ZzY29kZSc7XG5pbXBvcnQgeyBTdGF0dXNUcmFja2VyLCBDb21tYW5kU3RhdHVzIH0gZnJvbSAnLi9zdGF0dXNUcmFja2VyJztcbmV4cG9ydCB0eXBlIHsgQ29tbWFuZFN0YXR1cyB9O1xuaW1wb3J0IHsgU3RyZWFtaW5nQ29tbWFuZFJ1bm5lciB9IGZyb20gJy4vc3RyZWFtaW5nUnVubmVyJztcbmltcG9ydCB7IENvbW1hbmRSZXN1bHQsIENvbW1hbmRPcHRpb25zLCBTdHJlYW1pbmdNZXNzYWdlIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG4vKipcbiAqIENvb3JkaW5hdGVzIGNvbW1hbmQgZXhlY3V0aW9uIHdpdGggcmVhbC10aW1lIHN0YXR1cyB0cmFja2luZyBhbmQgc3RyZWFtaW5nXG4gKi9cbmV4cG9ydCBjbGFzcyBDb21tYW5kQ29vcmRpbmF0b3IgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgYWN0aXZlQ29tbWFuZHMgPSBuZXcgTWFwPHN0cmluZywgU3RyZWFtaW5nQ29tbWFuZFJ1bm5lcj4oKTtcbiAgICBwcml2YXRlIGNvbW1hbmRRdWV1ZTogQXJyYXk8e1xuICAgICAgICBpZDogc3RyaW5nO1xuICAgICAgICBjb21tYW5kOiBzdHJpbmc7XG4gICAgICAgIGFyZ3M6IHN0cmluZ1tdO1xuICAgICAgICBvcHRpb25zOiBhbnk7XG4gICAgICAgIHJlc29sdmU6IChyZXN1bHQ6IENvbW1hbmRSZXN1bHQpID0+IHZvaWQ7XG4gICAgICAgIHJlamVjdDogKGVycm9yOiBFcnJvcikgPT4gdm9pZDtcbiAgICB9PiA9IFtdO1xuICAgIHByaXZhdGUgbWF4Q29uY3VycmVudENvbW1hbmRzID0gMztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHN0YXR1c1RyYWNrZXI6IFN0YXR1c1RyYWNrZXIsXG4gICAgICAgIHByaXZhdGUgY29udGV4dDogdnNjb2RlLkV4dGVuc2lvbkNvbnRleHRcbiAgICApIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIExpc3RlbiB0byBzdGF0dXMgdHJhY2tlciBldmVudHNcbiAgICAgICAgdGhpcy5zdGF0dXNUcmFja2VyLm9uKCdzdGF0dXNfY2hhbmdlJywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3N0YXR1c191cGRhdGUnLCBldmVudCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEV4ZWN1dGUgYSBjb21tYW5kIHdpdGggZnVsbCBzdGF0dXMgdHJhY2tpbmcgYW5kIHN0cmVhbWluZ1xuICAgICAqL1xuICAgIGFzeW5jIGV4ZWN1dGVDb21tYW5kKFxuICAgICAgICBjb21tYW5kOiAnYWlEZWJ1ZycgfCAnbnhUZXN0JyB8ICdnaXREaWZmJyB8ICdwcmVwYXJlVG9QdXNoJyxcbiAgICAgICAgYXJnczogc3RyaW5nW10sXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIHByb2plY3Q/OiBzdHJpbmc7XG4gICAgICAgICAgICBjd2Q/OiBzdHJpbmc7XG4gICAgICAgICAgICBjb21tYW5kT3B0aW9ucz86IENvbW1hbmRPcHRpb25zO1xuICAgICAgICAgICAgcHJpb3JpdHk/OiAnbG93JyB8ICdub3JtYWwnIHwgJ2hpZ2gnO1xuICAgICAgICB9ID0ge31cbiAgICApOiBQcm9taXNlPENvbW1hbmRSZXN1bHQ+IHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgYXQgdGhlIGNvbmN1cnJlbnQgbGltaXRcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlQ29tbWFuZHMuc2l6ZSA+PSB0aGlzLm1heENvbmN1cnJlbnRDb21tYW5kcykge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMucHJpb3JpdHkgPT09ICdoaWdoJykge1xuICAgICAgICAgICAgICAgIC8vIENhbmNlbCBsb3dlc3QgcHJpb3JpdHkgY29tbWFuZCBmb3IgaGlnaCBwcmlvcml0eVxuICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsTG93ZXN0UHJpb3JpdHlDb21tYW5kKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFF1ZXVlIHRoZSBjb21tYW5kXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVldWVDb21tYW5kKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29tbWFuZElkID0gdGhpcy5zdGF0dXNUcmFja2VyLnN0YXJ0Q29tbWFuZChcbiAgICAgICAgICAgIGNvbW1hbmQsIFxuICAgICAgICAgICAgb3B0aW9ucy5wcm9qZWN0LCBcbiAgICAgICAgICAgIG9wdGlvbnMuY29tbWFuZE9wdGlvbnNcbiAgICAgICAgKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUNvbW1hbmRJbnRlcm5hbChjb21tYW5kSWQsIGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNUcmFja2VyLnVwZGF0ZVN0YXR1cyh7IG1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InIH0pO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYW5jZWwgYSBzcGVjaWZpYyBjb21tYW5kXG4gICAgICovXG4gICAgY2FuY2VsQ29tbWFuZChjb21tYW5kSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBydW5uZXIgPSB0aGlzLmFjdGl2ZUNvbW1hbmRzLmdldChjb21tYW5kSWQpO1xuICAgICAgICBpZiAocnVubmVyICYmIHJ1bm5lci5pc1J1bm5pbmcpIHtcbiAgICAgICAgICAgIHJ1bm5lci5jYW5jZWwoKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzVHJhY2tlci5jYW5jZWxDb21tYW5kKGNvbW1hbmRJZCk7XG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUNvbW1hbmRzLmRlbGV0ZShjb21tYW5kSWQpO1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUXVldWUoKTsgLy8gUHJvY2VzcyBuZXh0IHF1ZXVlZCBjb21tYW5kXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FuY2VsIGFsbCBydW5uaW5nIGNvbW1hbmRzXG4gICAgICovXG4gICAgY2FuY2VsQWxsQ29tbWFuZHMoKTogdm9pZCB7XG4gICAgICAgIGZvciAoY29uc3QgW2NvbW1hbmRJZCwgcnVubmVyXSBvZiB0aGlzLmFjdGl2ZUNvbW1hbmRzKSB7XG4gICAgICAgICAgICBpZiAocnVubmVyLmlzUnVubmluZykge1xuICAgICAgICAgICAgICAgIHJ1bm5lci5jYW5jZWwoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1c1RyYWNrZXIuY2FuY2VsQ29tbWFuZChjb21tYW5kSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuYWN0aXZlQ29tbWFuZHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5jb21tYW5kUXVldWUgPSBbXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY3VycmVudCBleGVjdXRpb24gc3RhdHVzXG4gICAgICovXG4gICAgZ2V0RXhlY3V0aW9uU3RhdHVzKCk6IHtcbiAgICAgICAgYWN0aXZlOiBudW1iZXI7XG4gICAgICAgIHF1ZXVlZDogbnVtYmVyO1xuICAgICAgICBtYXhDb25jdXJyZW50OiBudW1iZXI7XG4gICAgICAgIGNvbW1hbmRzOiBDb21tYW5kU3RhdHVzW107XG4gICAgfSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhY3RpdmU6IHRoaXMuYWN0aXZlQ29tbWFuZHMuc2l6ZSxcbiAgICAgICAgICAgIHF1ZXVlZDogdGhpcy5jb21tYW5kUXVldWUubGVuZ3RoLFxuICAgICAgICAgICAgbWF4Q29uY3VycmVudDogdGhpcy5tYXhDb25jdXJyZW50Q29tbWFuZHMsXG4gICAgICAgICAgICBjb21tYW5kczogdGhpcy5zdGF0dXNUcmFja2VyLmdldEFsbFN0YXR1c2VzKClcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgbWF4aW11bSBjb25jdXJyZW50IGNvbW1hbmRzXG4gICAgICovXG4gICAgc2V0TWF4Q29uY3VycmVudENvbW1hbmRzKG1heDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMubWF4Q29uY3VycmVudENvbW1hbmRzID0gTWF0aC5tYXgoMSwgTWF0aC5taW4oMTAsIG1heCkpO1xuICAgICAgICBcbiAgICAgICAgLy8gSWYgd2UncmUgb3ZlciB0aGUgbGltaXQsIHF1ZXVlIGRvZXNuJ3QgbmVlZCBpbW1lZGlhdGUgYWN0aW9uXG4gICAgICAgIC8vIGFzIGNvbW1hbmRzIHdpbGwgbmF0dXJhbGx5IGNvbXBsZXRlIGFuZCBiZSBwcm9jZXNzZWRcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgc3RyZWFtaW5nIG91dHB1dCBmb3IgYSBjb21tYW5kXG4gICAgICovXG4gICAgZ2V0Q29tbWFuZE91dHB1dChjb21tYW5kSWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJ1bm5lciA9IHRoaXMuYWN0aXZlQ29tbWFuZHMuZ2V0KGNvbW1hbmRJZCk7XG4gICAgICAgIHJldHVybiBydW5uZXI/LmdldEN1cnJlbnRPdXRwdXQoKSB8fCAnJztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGVhciBvdXRwdXQgZm9yIGEgY29tbWFuZFxuICAgICAqL1xuICAgIGNsZWFyQ29tbWFuZE91dHB1dChjb21tYW5kSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBydW5uZXIgPSB0aGlzLmFjdGl2ZUNvbW1hbmRzLmdldChjb21tYW5kSWQpO1xuICAgICAgICBpZiAocnVubmVyKSB7XG4gICAgICAgICAgICBydW5uZXIuY2xlYXJPdXRwdXQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBkZXRhaWxlZCBleGVjdXRpb24gbWV0cmljc1xuICAgICAqL1xuICAgIGdldEV4ZWN1dGlvbk1ldHJpY3MoKToge1xuICAgICAgICB0b3RhbENvbW1hbmRzOiBudW1iZXI7XG4gICAgICAgIHN1Y2Nlc3NSYXRlOiBudW1iZXI7XG4gICAgICAgIGF2ZXJhZ2VFeGVjdXRpb25UaW1lOiBudW1iZXI7XG4gICAgICAgIGNvbmN1cnJlbnRQZWFrOiBudW1iZXI7XG4gICAgICAgIHF1ZXVlVGltZUF2ZXJhZ2U6IG51bWJlcjtcbiAgICB9IHtcbiAgICAgICAgY29uc3QgaGlzdG9yeSA9IHRoaXMuc3RhdHVzVHJhY2tlci5nZXRIaXN0b3J5KCk7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gdGhpcy5zdGF0dXNUcmFja2VyLmdldENvbW1hbmRTdGF0cygpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsQ29tbWFuZHM6IHN0YXRzLnRvdGFsLFxuICAgICAgICAgICAgc3VjY2Vzc1JhdGU6IHN0YXRzLnRvdGFsID4gMCA/IChzdGF0cy5zdWNjZXNzZnVsIC8gc3RhdHMudG90YWwpICogMTAwIDogMCxcbiAgICAgICAgICAgIGF2ZXJhZ2VFeGVjdXRpb25UaW1lOiBzdGF0cy5hdmVyYWdlRHVyYXRpb24sXG4gICAgICAgICAgICBjb25jdXJyZW50UGVhazogdGhpcy5tYXhDb25jdXJyZW50Q29tbWFuZHMsIC8vIENvdWxkIHRyYWNrIGFjdHVhbCBwZWFrXG4gICAgICAgICAgICBxdWV1ZVRpbWVBdmVyYWdlOiAwIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgcXVldWUgdGltZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgZXhlY3V0aW9uIGhlYWx0aCByZXBvcnRcbiAgICAgKi9cbiAgICBjcmVhdGVIZWFsdGhSZXBvcnQoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3Qgc3RhdHVzID0gdGhpcy5nZXRFeGVjdXRpb25TdGF0dXMoKTtcbiAgICAgICAgY29uc3QgbWV0cmljcyA9IHRoaXMuZ2V0RXhlY3V0aW9uTWV0cmljcygpO1xuICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGBcbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG7wn4+lIENPTU1BTkQgRVhFQ1VUSU9OIEhFQUxUSCBSRVBPUlRcbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbvCfk4ogR2VuZXJhdGVkOiAke25vdy50b0lTT1N0cmluZygpfVxu8J+UpyBTeXN0ZW0gU3RhdHVzOiAke3N0YXR1cy5hY3RpdmUgPiAwID8gJ0FDVElWRScgOiAnSURMRSd9XG5cbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG7wn5OIIENVUlJFTlQgU1RBVFVTXG49PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG7wn5SEIEFjdGl2ZSBDb21tYW5kczogJHtzdGF0dXMuYWN0aXZlfS8ke3N0YXR1cy5tYXhDb25jdXJyZW50fVxu4o+zIFF1ZXVlZCBDb21tYW5kczogJHtzdGF0dXMucXVldWVkfVxu8J+TiiBUb3RhbCBFeGVjdXRlZDogJHttZXRyaWNzLnRvdGFsQ29tbWFuZHN9XG7inIUgU3VjY2VzcyBSYXRlOiAke21ldHJpY3Muc3VjY2Vzc1JhdGUudG9GaXhlZCgxKX0lXG7ij7HvuI8gIEF2ZyBFeGVjdXRpb246ICR7KG1ldHJpY3MuYXZlcmFnZUV4ZWN1dGlvblRpbWUgLyAxMDAwKS50b0ZpeGVkKDEpfXNcblxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbvCfmoAgQUNUSVZFIENPTU1BTkRTXG49PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4ke3RoaXMuZm9ybWF0QWN0aXZlQ29tbWFuZHMoc3RhdHVzLmNvbW1hbmRzKX1cblxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbuKaoSBQRVJGT1JNQU5DRSBNRVRSSUNTXG49PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG7igKIgQ29uY3VycmVudCBMaW1pdDogJHtzdGF0dXMubWF4Q29uY3VycmVudH0gY29tbWFuZHNcbuKAoiBRdWV1ZSBQcm9jZXNzaW5nOiAke3N0YXR1cy5xdWV1ZWQgPiAwID8gJ1BST0NFU1NJTkcnIDogJ0lETEUnfVxu4oCiIE1lbW9yeSBVc2FnZTogJHt0aGlzLmdldE1lbW9yeVVzYWdlKCl9XG7igKIgVXB0aW1lOiAke3RoaXMuZ2V0VXB0aW1lKCl9XG5cbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG7wn5KhIFJFQ09NTUVOREFUSU9OU1xuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuJHt0aGlzLmdlbmVyYXRlUmVjb21tZW5kYXRpb25zKHN0YXR1cywgbWV0cmljcyl9XG5cbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5gO1xuICAgIH1cblxuICAgIC8vIFByaXZhdGUgbWV0aG9kc1xuICAgIHByaXZhdGUgYXN5bmMgZXhlY3V0ZUNvbW1hbmRJbnRlcm5hbChcbiAgICAgICAgY29tbWFuZElkOiBzdHJpbmcsXG4gICAgICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICAgICAgYXJnczogc3RyaW5nW10sXG4gICAgICAgIG9wdGlvbnM6IGFueVxuICAgICk6IFByb21pc2U8Q29tbWFuZFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBvdXRwdXRDaGFubmVsID0gdnNjb2RlLndpbmRvdy5jcmVhdGVPdXRwdXRDaGFubmVsKCdBSSBEZWJ1ZyBVdGlsaXRpZXMnKTtcbiAgICAgICAgY29uc3QgcnVubmVyID0gbmV3IFN0cmVhbWluZ0NvbW1hbmRSdW5uZXIob3V0cHV0Q2hhbm5lbCk7XG4gICAgICAgIHRoaXMuYWN0aXZlQ29tbWFuZHMuc2V0KGNvbW1hbmRJZCwgcnVubmVyKTtcblxuICAgICAgICAvLyBTZXQgdXAgc3RyZWFtaW5nIGV2ZW50IGhhbmRsZXJzXG4gICAgICAgIHJ1bm5lci5vbignb3V0cHV0JywgKG91dHB1dDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1c1RyYWNrZXIuYXBwZW5kT3V0cHV0KGNvbW1hbmRJZCwgb3V0cHV0KTtcbiAgICAgICAgICAgIHRoaXMuZW1pdFN0cmVhbWluZ01lc3NhZ2UoY29tbWFuZElkLCAnb3V0cHV0JywgeyB0ZXh0OiBvdXRwdXQgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJ1bm5lci5vbignZXJyb3InLCAoZXJyb3I6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNUcmFja2VyLmFwcGVuZEVycm9yKGNvbW1hbmRJZCwgZXJyb3IpO1xuICAgICAgICAgICAgdGhpcy5lbWl0U3RyZWFtaW5nTWVzc2FnZShjb21tYW5kSWQsICdlcnJvcicsIHsgdGV4dDogZXJyb3IgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJ1bm5lci5vbigncHJvZ3Jlc3MnLCAocHJvZ3Jlc3M6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNUcmFja2VyLnVwZGF0ZVByb2dyZXNzKGNvbW1hbmRJZCwgcHJvZ3Jlc3MpO1xuICAgICAgICAgICAgdGhpcy5lbWl0U3RyZWFtaW5nTWVzc2FnZShjb21tYW5kSWQsICdwcm9ncmVzcycsIHsgcHJvZ3Jlc3MgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJ1bm5lci5vbignc3RhdHVzJywgKHN0YXR1czogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1c1RyYWNrZXIudXBkYXRlU3RhdHVzKHsgbWVzc2FnZTogc3RhdHVzIH0pO1xuICAgICAgICAgICAgdGhpcy5lbWl0U3RyZWFtaW5nTWVzc2FnZShjb21tYW5kSWQsICdzdGF0dXMnLCB7IHN0YXR1cyB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIEV4ZWN1dGUgYmFzZWQgb24gY29tbWFuZCB0eXBlIHdpdGggYXBwcm9wcmlhdGUgc3RyZWFtaW5nXG4gICAgICAgICAgICBsZXQgcmVzdWx0OiBDb21tYW5kUmVzdWx0O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBzd2l0Y2ggKGNvbW1hbmQpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdueFRlc3QnOlxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBydW5uZXIuZXhlY3V0ZVRlc3RDb21tYW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgJ25weCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ254JywgJ3Rlc3QnLCAuLi5hcmdzXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY3dkIHx8IHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNhc2UgJ2dpdERpZmYnOlxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBydW5uZXIuZXhlY3V0ZUdpdENvbW1hbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ2RpZmYnLCAuLi5hcmdzXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY3dkIHx8IHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNhc2UgJ3ByZXBhcmVUb1B1c2gnOlxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBydW5uZXIuZXhlY3V0ZUxpbnRDb21tYW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgJ25weCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBbJ254JywgJ2xpbnQnLCAuLi5hcmdzXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY3dkIHx8IHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIC8vIEdlbmVyaWMgY29tbWFuZCBleGVjdXRpb25cbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYXdhaXQgcnVubmVyLmV4ZWN1dGVXaXRoU3RyZWFtaW5nKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MsXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dkOiBvcHRpb25zLmN3ZFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDb21wbGV0ZSB0aGUgY29tbWFuZFxuICAgICAgICAgICAgdGhpcy5zdGF0dXNUcmFja2VyLmNvbXBsZXRlQ29tbWFuZChjb21tYW5kSWQsIHJlc3VsdCk7XG4gICAgICAgICAgICB0aGlzLmVtaXRTdHJlYW1pbmdNZXNzYWdlKGNvbW1hbmRJZCwgJ2NvbXBsZXRlJywgeyByZXN1bHQgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIC8vIENsZWFuIHVwXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUNvbW1hbmRzLmRlbGV0ZShjb21tYW5kSWQpO1xuICAgICAgICAgICAgcnVubmVyLnJlbW92ZUFsbExpc3RlbmVycygpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBQcm9jZXNzIG5leHQgcXVldWVkIGNvbW1hbmRcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1F1ZXVlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHF1ZXVlQ29tbWFuZChcbiAgICAgICAgY29tbWFuZDogc3RyaW5nLFxuICAgICAgICBhcmdzOiBzdHJpbmdbXSxcbiAgICAgICAgb3B0aW9uczogYW55XG4gICAgKTogUHJvbWlzZTxDb21tYW5kUmVzdWx0PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kSWQgPSBgcXVldWVkLSR7RGF0ZS5ub3coKX1gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmNvbW1hbmRRdWV1ZS5wdXNoKHtcbiAgICAgICAgICAgICAgICBpZDogY29tbWFuZElkLFxuICAgICAgICAgICAgICAgIGNvbW1hbmQsXG4gICAgICAgICAgICAgICAgYXJncyxcbiAgICAgICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgICAgIHJlc29sdmUsXG4gICAgICAgICAgICAgICAgcmVqZWN0XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gRW1pdCBxdWV1ZSBzdGF0dXMgdXBkYXRlXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3F1ZXVlX3VwZGF0ZScsIHtcbiAgICAgICAgICAgICAgICBxdWV1ZWQ6IHRoaXMuY29tbWFuZFF1ZXVlLmxlbmd0aCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogdGhpcy5jb21tYW5kUXVldWUubGVuZ3RoXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUXVldWUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmNvbW1hbmRRdWV1ZS5sZW5ndGggPT09IDAgfHwgdGhpcy5hY3RpdmVDb21tYW5kcy5zaXplID49IHRoaXMubWF4Q29uY3VycmVudENvbW1hbmRzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXh0ID0gdGhpcy5jb21tYW5kUXVldWUuc2hpZnQoKTtcbiAgICAgICAgaWYgKCFuZXh0KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBFeGVjdXRlIHRoZSBxdWV1ZWQgY29tbWFuZFxuICAgICAgICB0aGlzLmV4ZWN1dGVDb21tYW5kKFxuICAgICAgICAgICAgbmV4dC5jb21tYW5kIGFzIGFueSxcbiAgICAgICAgICAgIG5leHQuYXJncyxcbiAgICAgICAgICAgIG5leHQub3B0aW9uc1xuICAgICAgICApLnRoZW4obmV4dC5yZXNvbHZlKS5jYXRjaChuZXh0LnJlamVjdCk7XG5cbiAgICAgICAgLy8gVXBkYXRlIHF1ZXVlIHN0YXR1c1xuICAgICAgICB0aGlzLmVtaXQoJ3F1ZXVlX3VwZGF0ZScsIHtcbiAgICAgICAgICAgIHF1ZXVlZDogdGhpcy5jb21tYW5kUXVldWUubGVuZ3RoLFxuICAgICAgICAgICAgcHJvY2Vzc2VkOiB0cnVlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FuY2VsTG93ZXN0UHJpb3JpdHlDb21tYW5kKCk6IHZvaWQge1xuICAgICAgICAvLyBGaW5kIHJ1bm5pbmcgY29tbWFuZCB3aXRoIGxvd2VzdCBwcmlvcml0eSAobW9zdCByZWNlbnQgZm9yIG5vdylcbiAgICAgICAgY29uc3QgY29tbWFuZElkcyA9IEFycmF5LmZyb20odGhpcy5hY3RpdmVDb21tYW5kcy5rZXlzKCkpO1xuICAgICAgICBpZiAoY29tbWFuZElkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kVG9DYW5jZWwgPSBjb21tYW5kSWRzW2NvbW1hbmRJZHMubGVuZ3RoIC0gMV07IC8vIE1vc3QgcmVjZW50XG4gICAgICAgICAgICB0aGlzLmNhbmNlbENvbW1hbmQoY29tbWFuZFRvQ2FuY2VsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZW1pdFN0cmVhbWluZ01lc3NhZ2UoY29tbWFuZElkOiBzdHJpbmcsIHR5cGU6IFN0cmVhbWluZ01lc3NhZ2VbJ3R5cGUnXSwgZGF0YTogYW55KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2U6IFN0cmVhbWluZ01lc3NhZ2UgPSB7XG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIC4uLmRhdGEsXG4gICAgICAgICAgICAgICAgYWN0aW9uSWQ6IGNvbW1hbmRJZFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5lbWl0KCdzdHJlYW1pbmdfbWVzc2FnZScsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0QWN0aXZlQ29tbWFuZHMoY29tbWFuZHM6IENvbW1hbmRTdGF0dXNbXSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGFjdGl2ZSA9IGNvbW1hbmRzLmZpbHRlcihjID0+IGMuc3RhdHVzID09PSAncnVubmluZycpO1xuICAgICAgICBcbiAgICAgICAgaWYgKGFjdGl2ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiAn4pyFIE5vIGNvbW1hbmRzIGN1cnJlbnRseSBhY3RpdmUnO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gYWN0aXZlLm1hcChjbWQgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxhcHNlZCA9IGNtZC5zdGFydFRpbWUgPyBEYXRlLm5vdygpIC0gY21kLnN0YXJ0VGltZS5nZXRUaW1lKCkgOiAwO1xuICAgICAgICAgICAgY29uc3QgZWxhcHNlZFNlY29uZHMgPSBNYXRoLnJvdW5kKGVsYXBzZWQgLyAxMDAwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGDwn5SEICR7Y21kLmNvbW1hbmQgfHwgY21kLmFjdGlvbn0ke2NtZC5wcm9qZWN0ID8gYCAoJHtjbWQucHJvamVjdH0pYCA6ICcnfVxuICAgUHJvZ3Jlc3M6ICR7Y21kLnByb2dyZXNzfSUgfCBFbGFwc2VkOiAke2VsYXBzZWRTZWNvbmRzfXNcbiAgIFN0YXR1czogJHtjbWQubWVzc2FnZSB8fCBjbWQub3V0cHV0fVxuICAgSUQ6ICR7Y21kLmlkLnN1YnN0cmluZygwLCA4KX0uLi5gO1xuICAgICAgICB9KS5qb2luKCdcXG5cXG4nKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE1lbW9yeVVzYWdlKCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHVzYWdlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgICAgICByZXR1cm4gYCR7TWF0aC5yb3VuZCh1c2FnZS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KX1NQmA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRVcHRpbWUoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgdXB0aW1lTXMgPSBwcm9jZXNzLnVwdGltZSgpICogMTAwMDtcbiAgICAgICAgY29uc3QgaG91cnMgPSBNYXRoLmZsb29yKHVwdGltZU1zIC8gKDEwMDAgKiA2MCAqIDYwKSk7XG4gICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKCh1cHRpbWVNcyAlICgxMDAwICogNjAgKiA2MCkpIC8gKDEwMDAgKiA2MCkpO1xuICAgICAgICByZXR1cm4gYCR7aG91cnN9aCAke21pbnV0ZXN9bWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZVJlY29tbWVuZGF0aW9ucyhzdGF0dXM6IGFueSwgbWV0cmljczogYW55KTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcmVjb21tZW5kYXRpb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgaWYgKHN0YXR1cy5xdWV1ZWQgPiA1KSB7XG4gICAgICAgICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgn4pqg77iPICBIaWdoIHF1ZXVlIGJhY2tsb2cgLSBjb25zaWRlciBpbmNyZWFzaW5nIGNvbmN1cnJlbnQgbGltaXQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKG1ldHJpY3Muc3VjY2Vzc1JhdGUgPCA4MCkge1xuICAgICAgICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ/CflKcgTG93IHN1Y2Nlc3MgcmF0ZSAtIGNoZWNrIGNvbW1hbmQgY29uZmlndXJhdGlvbnMnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKG1ldHJpY3MuYXZlcmFnZUV4ZWN1dGlvblRpbWUgPiA2MDAwMCkge1xuICAgICAgICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ+KPsCBMb25nIGV4ZWN1dGlvbiB0aW1lcyAtIGNvbnNpZGVyIG9wdGltaXppbmcgY29tbWFuZHMnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHN0YXR1cy5hY3RpdmUgPT09IHN0YXR1cy5tYXhDb25jdXJyZW50KSB7XG4gICAgICAgICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgn8J+TiCBBdCBjb25jdXJyZW50IGxpbWl0IC0gbW9uaXRvciBmb3IgYm90dGxlbmVja3MnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHJlY29tbWVuZGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCfinIUgU3lzdGVtIHJ1bm5pbmcgb3B0aW1hbGx5Jyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiByZWNvbW1lbmRhdGlvbnMubWFwKChyZWMsIGkpID0+IGAke2kgKyAxfS4gJHtyZWN9YCkuam9pbignXFxuJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGlzcG9zZSBvZiByZXNvdXJjZXNcbiAgICAgKi9cbiAgICBkaXNwb3NlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNhbmNlbEFsbENvbW1hbmRzKCk7XG4gICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==