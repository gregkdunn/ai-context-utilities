bc719c13a8985e87d2b3807639a90858
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.NxAffectedManager = void 0;
const vscode = __importStar(require("vscode"));
const child_process_1 = require("child_process");
const path = __importStar(require("path"));
const fs = __importStar(require("fs"));
class NxAffectedManager {
    context;
    workspaceRoot;
    nxConfig;
    affectedCache = new Map();
    fileWatcher = null;
    constructor(context) {
        this.context = context;
        this.workspaceRoot = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath || '';
        this.initialize();
    }
    async initialize() {
        try {
            await this.loadNxConfiguration();
            this.setupFileWatcher();
        }
        catch (error) {
            console.error('Failed to initialize NX Affected Manager:', error);
        }
    }
    async loadNxConfiguration() {
        const nxConfigPath = path.join(this.workspaceRoot, 'nx.json');
        const angularConfigPath = path.join(this.workspaceRoot, 'angular.json');
        try {
            if (fs.existsSync(nxConfigPath)) {
                const configContent = fs.readFileSync(nxConfigPath, 'utf-8');
                this.nxConfig = JSON.parse(configContent);
            }
            else if (fs.existsSync(angularConfigPath)) {
                const configContent = fs.readFileSync(angularConfigPath, 'utf-8');
                this.nxConfig = JSON.parse(configContent);
            }
            else {
                throw new Error('No NX configuration found');
            }
        }
        catch (error) {
            throw new Error(`Failed to load NX configuration: ${error.message}`);
        }
    }
    setupFileWatcher() {
        if (this.fileWatcher) {
            this.fileWatcher.dispose();
        }
        this.fileWatcher = vscode.workspace.createFileSystemWatcher('**/*');
        this.fileWatcher.onDidChange(() => this.clearAffectedCache());
        this.fileWatcher.onDidCreate(() => this.clearAffectedCache());
        this.fileWatcher.onDidDelete(() => this.clearAffectedCache());
        this.context.subscriptions.push(this.fileWatcher);
    }
    clearAffectedCache() {
        this.affectedCache.clear();
    }
    async getAffectedProjects(base = 'main') {
        const headCommit = await this.getHeadCommit();
        const cacheKey = `${base}-${headCommit}`;
        if (this.affectedCache.has(cacheKey)) {
            return this.affectedCache.get(cacheKey);
        }
        try {
            const projects = await this.executeNxCommand(['show', 'projects', '--affected', '--base', base]);
            this.affectedCache.set(cacheKey, projects);
            return projects;
        }
        catch (error) {
            console.error('Failed to get affected projects:', error);
            return [];
        }
    }
    async getAllProjects() {
        try {
            const projectNames = await this.executeNxCommand(['show', 'projects']);
            const projects = [];
            for (const projectName of projectNames) {
                try {
                    const projectConfig = await this.getProjectConfiguration(projectName);
                    projects.push(projectConfig);
                }
                catch (error) {
                    console.warn(`Failed to get configuration for project ${projectName}:`, error);
                }
            }
            return projects;
        }
        catch (error) {
            console.error('Failed to get all projects:', error);
            return [];
        }
    }
    async getProjectConfiguration(projectName) {
        try {
            const configOutput = await this.executeNxCommandRaw(['show', 'project', projectName, '--json']);
            const config = JSON.parse(configOutput);
            return {
                name: projectName,
                root: config.root || '',
                targets: config.targets || {},
                type: this.inferProjectType(config)
            };
        }
        catch (error) {
            throw new Error(`Failed to get project configuration for ${projectName}: ${error.message}`);
        }
    }
    inferProjectType(config) {
        if (config.targets && config.targets.serve) {
            return 'application';
        }
        return 'library';
    }
    async runAffectedCommand(target, base = 'main', options = []) {
        try {
            const projects = await this.getAffectedProjects(base);
            if (projects.length === 0) {
                return {
                    projects: [],
                    output: 'No affected projects found',
                    success: true
                };
            }
            const args = ['run-many', '--target', target, '--projects', projects.join(','), ...options];
            const output = await this.executeNxCommandRaw(args);
            return {
                projects,
                output,
                success: true
            };
        }
        catch (error) {
            return {
                projects: [],
                output: error.message,
                success: false,
                errors: [error.message]
            };
        }
    }
    async runAffectedTest(base = 'main', parallel = true) {
        const options = parallel ? ['--parallel'] : [];
        return this.runAffectedCommand('test', base, options);
    }
    async runAffectedLint(base = 'main', parallel = true) {
        const options = parallel ? ['--parallel'] : [];
        return this.runAffectedCommand('lint', base, options);
    }
    async runAffectedBuild(base = 'main', parallel = true) {
        const options = parallel ? ['--parallel'] : [];
        return this.runAffectedCommand('build', base, options);
    }
    async executeNxCommand(args) {
        const output = await this.executeNxCommandRaw(args);
        return output.trim().split('\n').filter(line => line.length > 0);
    }
    async executeNxCommandRaw(args) {
        return new Promise((resolve, reject) => {
            const child = (0, child_process_1.spawn)('npx', ['nx', ...args], {
                cwd: this.workspaceRoot,
                stdio: 'pipe',
                shell: process.platform === 'win32'
            });
            let output = '';
            let errorOutput = '';
            child.stdout.on('data', (data) => {
                output += data.toString();
            });
            child.stderr.on('data', (data) => {
                errorOutput += data.toString();
            });
            child.on('close', (code) => {
                if (code === 0) {
                    resolve(output);
                }
                else {
                    reject(new Error(`NX command failed with code ${code}: ${errorOutput}`));
                }
            });
            child.on('error', (error) => {
                reject(new Error(`Failed to execute NX command: ${error.message}`));
            });
            // Set timeout for long-running commands
            setTimeout(() => {
                child.kill();
                reject(new Error('NX command timeout'));
            }, 120000); // 2 minutes timeout
        });
    }
    async getHeadCommit() {
        return new Promise((resolve, reject) => {
            const child = (0, child_process_1.spawn)('git', ['rev-parse', 'HEAD'], {
                cwd: this.workspaceRoot,
                stdio: 'pipe'
            });
            let output = '';
            child.stdout.on('data', (data) => {
                output += data.toString();
            });
            child.on('close', (code) => {
                if (code === 0) {
                    resolve(output.trim());
                }
                else {
                    resolve('unknown');
                }
            });
            child.on('error', () => {
                resolve('unknown');
            });
        });
    }
    async isNxWorkspace() {
        const nxConfig = path.join(this.workspaceRoot, 'nx.json');
        const angularConfig = path.join(this.workspaceRoot, 'angular.json');
        return fs.existsSync(nxConfig) || fs.existsSync(angularConfig);
    }
    dispose() {
        if (this.fileWatcher) {
            this.fileWatcher.dispose();
        }
        this.clearAffectedCache();
    }
}
exports.NxAffectedManager = NxAffectedManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy9zZXJ2aWNlcy9ueC9OeEFmZmVjdGVkTWFuYWdlci50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQ0FBaUM7QUFDakMsaURBQXNDO0FBQ3RDLDJDQUE2QjtBQUM3Qix1Q0FBeUI7QUFnQnpCLE1BQWEsaUJBQWlCO0lBTU47SUFMWixhQUFhLENBQVM7SUFDdEIsUUFBUSxDQUFNO0lBQ2QsYUFBYSxHQUEwQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2pELFdBQVcsR0FBb0MsSUFBSSxDQUFDO0lBRTVELFlBQW9CLE9BQWdDO1FBQWhDLFlBQU8sR0FBUCxPQUFPLENBQXlCO1FBQ2hELElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQzlFLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRU8sS0FBSyxDQUFDLFVBQVU7UUFDcEIsSUFBSSxDQUFDO1lBQ0QsTUFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUNqQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1QixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkNBQTJDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdEUsQ0FBQztJQUNMLENBQUM7SUFFTyxLQUFLLENBQUMsbUJBQW1CO1FBQzdCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUM5RCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUMsQ0FBQztR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LENBQUMsQ0FBQztnQkFDM0IsQ0FBQztxQkFBTSxDQUFDO29CQUNKLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDdkIsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO2dCQUNuQixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYTtRQUNmLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUMxRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDcEUsT0FBTyxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9CLENBQUM7UUFDRCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM5QixDQUFDO0NBQ0o7QUF0UEQsOENBc1BDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9ncmVnZHVubi9zcmMvdGVzdC9haV9kZWJ1Z19jb250ZXh0L3ZzY29kZS9zcmMvc2VydmljZXMvbngvTnhBZmZlY3RlZE1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdnNjb2RlIGZyb20gJ3ZzY29kZSc7XG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcblxuZXhwb3J0IGludGVyZmFjZSBOeFByb2plY3Qge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICByb290OiBzdHJpbmc7XG4gICAgdGFyZ2V0czogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgICB0eXBlOiAnYXBwbGljYXRpb24nIHwgJ2xpYnJhcnknO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFmZmVjdGVkQ29tbWFuZFJlc3VsdCB7XG4gICAgcHJvamVjdHM6IHN0cmluZ1tdO1xuICAgIG91dHB1dDogc3RyaW5nO1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgZXJyb3JzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBjbGFzcyBOeEFmZmVjdGVkTWFuYWdlciB7XG4gICAgcHJpdmF0ZSB3b3Jrc3BhY2VSb290OiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBueENvbmZpZzogYW55O1xuICAgIHByaXZhdGUgYWZmZWN0ZWRDYWNoZTogTWFwPHN0cmluZywgc3RyaW5nW10+ID0gbmV3IE1hcCgpO1xuICAgIHByaXZhdGUgZmlsZVdhdGNoZXI6IHZzY29kZS5GaWxlU3lzdGVtV2F0Y2hlciB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjb250ZXh0OiB2c2NvZGUuRXh0ZW5zaW9uQ29udGV4dCkge1xuICAgICAgICB0aGlzLndvcmtzcGFjZVJvb3QgPSB2c2NvZGUud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnM/LlswXT8udXJpLmZzUGF0aCB8fCAnJztcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkTnhDb25maWd1cmF0aW9uKCk7XG4gICAgICAgICAgICB0aGlzLnNldHVwRmlsZVdhdGNoZXIoKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIE5YIEFmZmVjdGVkIE1hbmFnZXI6JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBsb2FkTnhDb25maWd1cmF0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBueENvbmZpZ1BhdGggPSBwYXRoLmpvaW4odGhpcy53b3Jrc3BhY2VSb290LCAnbnguanNvbicpO1xuICAgICAgICBjb25zdCBhbmd1bGFyQ29uZmlnUGF0aCA9IHBhdGguam9pbih0aGlzLndvcmtzcGFjZVJvb3QsICdhbmd1bGFyLmpzb24nKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMobnhDb25maWdQYXRoKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZ0NvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMobnhDb25maWdQYXRoLCAndXRmLTgnKTtcbiAgICAgICAgICAgICAgICB0aGlzLm54Q29uZmlnID0gSlNPTi5wYXJzZShjb25maWdDb250ZW50KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZnMuZXhpc3RzU3luYyhhbmd1bGFyQ29uZmlnUGF0aCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb25maWdDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGFuZ3VsYXJDb25maWdQYXRoLCAndXRmLTgnKTtcbiAgICAgICAgICAgICAgICB0aGlzLm54Q29uZmlnID0gSlNPTi5wYXJzZShjb25maWdDb250ZW50KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBOWCBjb25maWd1cmF0aW9uIGZvdW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBsb2FkIE5YIGNvbmZpZ3VyYXRpb246ICR7KGVycm9yIGFzIEVycm9yKS5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXR1cEZpbGVXYXRjaGVyKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5maWxlV2F0Y2hlcikge1xuICAgICAgICAgICAgdGhpcy5maWxlV2F0Y2hlci5kaXNwb3NlKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmZpbGVXYXRjaGVyID0gdnNjb2RlLndvcmtzcGFjZS5jcmVhdGVGaWxlU3lzdGVtV2F0Y2hlcignKiovKicpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlci5vbkRpZENoYW5nZSgoKSA9PiB0aGlzLmNsZWFyQWZmZWN0ZWRDYWNoZSgpKTtcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlci5vbkRpZENyZWF0ZSgoKSA9PiB0aGlzLmNsZWFyQWZmZWN0ZWRDYWNoZSgpKTtcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlci5vbkRpZERlbGV0ZSgoKSA9PiB0aGlzLmNsZWFyQWZmZWN0ZWRDYWNoZSgpKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5maWxlV2F0Y2hlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhckFmZmVjdGVkQ2FjaGUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYWZmZWN0ZWRDYWNoZS5jbGVhcigpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEFmZmVjdGVkUHJvamVjdHMoYmFzZTogc3RyaW5nID0gJ21haW4nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgICAgICBjb25zdCBoZWFkQ29tbWl0ID0gYXdhaXQgdGhpcy5nZXRIZWFkQ29tbWl0KCk7XG4gICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYCR7YmFzZX0tJHtoZWFkQ29tbWl0fWA7XG5cbiAgICAgICAgaWYgKHRoaXMuYWZmZWN0ZWRDYWNoZS5oYXMoY2FjaGVLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hZmZlY3RlZENhY2hlLmdldChjYWNoZUtleSkhO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByb2plY3RzID0gYXdhaXQgdGhpcy5leGVjdXRlTnhDb21tYW5kKFsnc2hvdycsICdwcm9qZWN0cycsICctLWFmZmVjdGVkJywgJy0tYmFzZScsIGJhc2VdKTtcbiAgICAgICAgICAgIHRoaXMuYWZmZWN0ZWRDYWNoZS5zZXQoY2FjaGVLZXksIHByb2plY3RzKTtcbiAgICAgICAgICAgIHJldHVybiBwcm9qZWN0cztcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgYWZmZWN0ZWQgcHJvamVjdHM6JywgZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QWxsUHJvamVjdHMoKTogUHJvbWlzZTxOeFByb2plY3RbXT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcHJvamVjdE5hbWVzID0gYXdhaXQgdGhpcy5leGVjdXRlTnhDb21tYW5kKFsnc2hvdycsICdwcm9qZWN0cyddKTtcbiAgICAgICAgICAgIGNvbnN0IHByb2plY3RzOiBOeFByb2plY3RbXSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHByb2plY3ROYW1lIG9mIHByb2plY3ROYW1lcykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb2plY3RDb25maWcgPSBhd2FpdCB0aGlzLmdldFByb2plY3RDb25maWd1cmF0aW9uKHByb2plY3ROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgcHJvamVjdHMucHVzaChwcm9qZWN0Q29uZmlnKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBnZXQgY29uZmlndXJhdGlvbiBmb3IgcHJvamVjdCAke3Byb2plY3ROYW1lfTpgLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcHJvamVjdHM7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZ2V0IGFsbCBwcm9qZWN0czonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXRQcm9qZWN0Q29uZmlndXJhdGlvbihwcm9qZWN0TmFtZTogc3RyaW5nKTogUHJvbWlzZTxOeFByb2plY3Q+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZ091dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZU54Q29tbWFuZFJhdyhbJ3Nob3cnLCAncHJvamVjdCcsIHByb2plY3ROYW1lLCAnLS1qc29uJ10pO1xuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gSlNPTi5wYXJzZShjb25maWdPdXRwdXQpO1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6IHByb2plY3ROYW1lLFxuICAgICAgICAgICAgICAgIHJvb3Q6IGNvbmZpZy5yb290IHx8ICcnLFxuICAgICAgICAgICAgICAgIHRhcmdldHM6IGNvbmZpZy50YXJnZXRzIHx8IHt9LFxuICAgICAgICAgICAgICAgIHR5cGU6IHRoaXMuaW5mZXJQcm9qZWN0VHlwZShjb25maWcpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZ2V0IHByb2plY3QgY29uZmlndXJhdGlvbiBmb3IgJHtwcm9qZWN0TmFtZX06ICR7KGVycm9yIGFzIEVycm9yKS5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbmZlclByb2plY3RUeXBlKGNvbmZpZzogYW55KTogJ2FwcGxpY2F0aW9uJyB8ICdsaWJyYXJ5JyB7XG4gICAgICAgIGlmIChjb25maWcudGFyZ2V0cyAmJiBjb25maWcudGFyZ2V0cy5zZXJ2ZSkge1xuICAgICAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbic7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICdsaWJyYXJ5JztcbiAgICB9XG5cbiAgICBhc3luYyBydW5BZmZlY3RlZENvbW1hbmQodGFyZ2V0OiBzdHJpbmcsIGJhc2U6IHN0cmluZyA9ICdtYWluJywgb3B0aW9uczogc3RyaW5nW10gPSBbXSk6IFByb21pc2U8QWZmZWN0ZWRDb21tYW5kUmVzdWx0PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBwcm9qZWN0cyA9IGF3YWl0IHRoaXMuZ2V0QWZmZWN0ZWRQcm9qZWN0cyhiYXNlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHByb2plY3RzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHByb2plY3RzOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiAnTm8gYWZmZWN0ZWQgcHJvamVjdHMgZm91bmQnLFxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsncnVuLW1hbnknLCAnLS10YXJnZXQnLCB0YXJnZXQsICctLXByb2plY3RzJywgcHJvamVjdHMuam9pbignLCcpLCAuLi5vcHRpb25zXTtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZU54Q29tbWFuZFJhdyhhcmdzKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBwcm9qZWN0cyxcbiAgICAgICAgICAgICAgICBvdXRwdXQsXG4gICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcHJvamVjdHM6IFtdLFxuICAgICAgICAgICAgICAgIG91dHB1dDogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yczogWyhlcnJvciBhcyBFcnJvcikubWVzc2FnZV1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBydW5BZmZlY3RlZFRlc3QoYmFzZTogc3RyaW5nID0gJ21haW4nLCBwYXJhbGxlbDogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFmZmVjdGVkQ29tbWFuZFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gcGFyYWxsZWwgPyBbJy0tcGFyYWxsZWwnXSA6IFtdO1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5BZmZlY3RlZENvbW1hbmQoJ3Rlc3QnLCBiYXNlLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBydW5BZmZlY3RlZExpbnQoYmFzZTogc3RyaW5nID0gJ21haW4nLCBwYXJhbGxlbDogYm9vbGVhbiA9IHRydWUpOiBQcm9taXNlPEFmZmVjdGVkQ29tbWFuZFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gcGFyYWxsZWwgPyBbJy0tcGFyYWxsZWwnXSA6IFtdO1xuICAgICAgICByZXR1cm4gdGhpcy5ydW5BZmZlY3RlZENvbW1hbmQoJ2xpbnQnLCBiYXNlLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBhc3luYyBydW5BZmZlY3RlZEJ1aWxkKGJhc2U6IHN0cmluZyA9ICdtYWluJywgcGFyYWxsZWw6IGJvb2xlYW4gPSB0cnVlKTogUHJvbWlzZTxBZmZlY3RlZENvbW1hbmRSZXN1bHQ+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHBhcmFsbGVsID8gWyctLXBhcmFsbGVsJ10gOiBbXTtcbiAgICAgICAgcmV0dXJuIHRoaXMucnVuQWZmZWN0ZWRDb21tYW5kKCdidWlsZCcsIGJhc2UsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgZXhlY3V0ZU54Q29tbWFuZChhcmdzOiBzdHJpbmdbXSk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlTnhDb21tYW5kUmF3KGFyZ3MpO1xuICAgICAgICByZXR1cm4gb3V0cHV0LnRyaW0oKS5zcGxpdCgnXFxuJykuZmlsdGVyKGxpbmUgPT4gbGluZS5sZW5ndGggPiAwKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGV4ZWN1dGVOeENvbW1hbmRSYXcoYXJnczogc3RyaW5nW10pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBzcGF3bignbnB4JywgWydueCcsIC4uLmFyZ3NdLCB7XG4gICAgICAgICAgICAgICAgY3dkOiB0aGlzLndvcmtzcGFjZVJvb3QsXG4gICAgICAgICAgICAgICAgc3RkaW86ICdwaXBlJyxcbiAgICAgICAgICAgICAgICBzaGVsbDogcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJ1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxldCBvdXRwdXQgPSAnJztcbiAgICAgICAgICAgIGxldCBlcnJvck91dHB1dCA9ICcnO1xuXG4gICAgICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIG91dHB1dCArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY2hpbGQuc3RkZXJyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBlcnJvck91dHB1dCArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY2hpbGQub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG91dHB1dCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTlggY29tbWFuZCBmYWlsZWQgd2l0aCBjb2RlICR7Y29kZX06ICR7ZXJyb3JPdXRwdXR9YCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjaGlsZC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBOWCBjb21tYW5kOiAke2Vycm9yLm1lc3NhZ2V9YCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIFNldCB0aW1lb3V0IGZvciBsb25nLXJ1bm5pbmcgY29tbWFuZHNcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNoaWxkLmtpbGwoKTtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdOWCBjb21tYW5kIHRpbWVvdXQnKSk7XG4gICAgICAgICAgICB9LCAxMjAwMDApOyAvLyAyIG1pbnV0ZXMgdGltZW91dFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGdldEhlYWRDb21taXQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gc3Bhd24oJ2dpdCcsIFsncmV2LXBhcnNlJywgJ0hFQUQnXSwge1xuICAgICAgICAgICAgICAgIGN3ZDogdGhpcy53b3Jrc3BhY2VSb290LFxuICAgICAgICAgICAgICAgIHN0ZGlvOiAncGlwZSdcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgb3V0cHV0ID0gJyc7XG4gICAgICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIG91dHB1dCArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY2hpbGQub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG91dHB1dC50cmltKCkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoJ3Vua25vd24nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY2hpbGQub24oJ2Vycm9yJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoJ3Vua25vd24nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBpc054V29ya3NwYWNlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBueENvbmZpZyA9IHBhdGguam9pbih0aGlzLndvcmtzcGFjZVJvb3QsICdueC5qc29uJyk7XG4gICAgICAgIGNvbnN0IGFuZ3VsYXJDb25maWcgPSBwYXRoLmpvaW4odGhpcy53b3Jrc3BhY2VSb290LCAnYW5ndWxhci5qc29uJyk7XG4gICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKG54Q29uZmlnKSB8fCBmcy5leGlzdHNTeW5jKGFuZ3VsYXJDb25maWcpO1xuICAgIH1cblxuICAgIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmZpbGVXYXRjaGVyKSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVXYXRjaGVyLmRpc3Bvc2UoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsZWFyQWZmZWN0ZWRDYWNoZSgpO1xuICAgIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==