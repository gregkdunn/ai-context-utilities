# Phase 3.5.0: Copilot Instructions Setup Module

## Overview
Create a new module that automatically generates and maintains `.github/instructions/copilot-instructions.md` and framework-specific instruction files based on the workspace's detected technologies.

## Key Objectives
1. **Automated Setup** - Create folder structure and initial files
2. **Framework Detection** - Leverage existing WorkspaceAnalyzer
3. **Intelligent Instruction Generation** - Framework-specific best practices
4. **AI Context Integration** - Link to AI Context utilities
5. **MCP Server Integration** - Consider Context7 for dynamic docs

## Research Summary

### Key Resources Analyzed
- **VS Code MCP Servers** - Model Context Protocol for AI tool integration
- **Context7** - Documentation aggregation service for LLMs
- **CopilotCraft.dev** - Template generator with metadata support
- **GitHub Copilot Docs** - Official best practices
- **Community Insights** - Real-world implementation tips

### Key Findings
1. **Three Layers of Instructions** - User, Repository, Organization levels
2. **Keep It Concise** - Copilot is non-deterministic, avoid conflicts
3. **File Targeting** - Use glob patterns for specific instructions
4. **Metadata Support** - Front matter for better organization
5. **Version Awareness** - Framework-specific, version-specific docs

## Proposed Architecture

### 1. Folder Structure
```
.github/
‚îú‚îÄ‚îÄ instructions/
‚îÇ   ‚îú‚îÄ‚îÄ copilot-instructions.md          # Main instructions file
‚îÇ   ‚îú‚îÄ‚îÄ ai-utilities-context/            # AI Context outputs (existing)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai-debug-context.txt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ diff.txt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test-output.txt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pr-description.txt
‚îÇ   ‚îú‚îÄ‚îÄ angular/                         # Framework-specific folders
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ angular-best-practices.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ llms-full.txt
‚îÇ   ‚îú‚îÄ‚îÄ react/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ react-best-practices.md
‚îÇ   ‚îú‚îÄ‚îÄ typescript/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ typescript-best-practices.md
‚îÇ   ‚îî‚îÄ‚îÄ jest/
‚îÇ       ‚îî‚îÄ‚îÄ jest-best-practices.md
‚îî‚îÄ‚îÄ prompts/                             # Optional: reusable prompts
```

### 2. Core Components

#### A. CopilotInstructionsGenerator
```typescript
class CopilotInstructionsGenerator {
  // Main orchestrator for generating instructions
  async generateInstructions(options: GeneratorOptions): Promise<void>
  private createFolderStructure(): Promise<void>
  private generateMainInstructionsFile(): Promise<string>
  private generateFrameworkInstructions(): Promise<void>
  private buildInstructionSet(workspace: WorkspaceAnalysis): Promise<InstructionSet>
}
```

#### B. FrameworkInstructionProvider
```typescript
interface FrameworkInstructionProvider {
  getInstructions(version: string): Promise<string>
  getSourceUrl(): string
  getName(): string
}

// Implementations:
class AngularInstructionProvider
class ReactInstructionProvider
class TypeScriptInstructionProvider
class JestInstructionProvider
```

#### C. InstructionTemplateEngine
```typescript
class InstructionTemplateEngine {
  // Generates consistent, well-formatted instruction files
  generateMainTemplate(context: WorkspaceContext): string
  generateFrameworkTemplate(framework: string, content: string): string
  mergeInstructions(instructions: Instruction[]): string
}
```

#### D. InstructionConflictResolver
```typescript
class InstructionConflictResolver {
  resolve(instructions: Instruction[]): Instruction[]
  calculateSpecificity(targets: string[]): number
  mergeNonConflicting(instructions: Instruction[]): Instruction[]
}
```

### 3. Instruction File Format

#### Main Instructions Template
```markdown
# Copilot Instructions for [Workspace Name]

## Overview
This repository uses [detected frameworks] with [detected test framework].

## AI Context Utilities
These files are automatically generated by the AI Context Utilities extension to provide real-time context for debugging and understanding code changes:

- **[Debugging Context](./ai-utilities-context/ai-debug-context.txt)** - Consolidated git diff and test run data optimized for AI analysis
- **[Git Diff Data](./ai-utilities-context/diff.txt)** - Current uncommitted changes in the repository
- **[Test Output](./ai-utilities-context/test-output.txt)** - Latest test execution results and failures
- **[PR Description](./ai-utilities-context/pr-description.txt)** - AI-ready context for generating pull request descriptions

These files are updated automatically when you run tests or prepare commits using the AI Context Utilities commands.

## Technology Stack
[Auto-generated based on WorkspaceAnalyzer]

## Framework-Specific Guidelines
[Links to framework-specific files]

## Project Conventions
[Placeholder for user customization]
```

#### Framework Instruction Format (with metadata)
```markdown
---
targets:
  - "**/*.component.ts"
  - "**/*.service.ts"
language: typescript
framework: angular
version: 17.0
testing: jest
---

# Angular Component Guidelines

[Instructions content...]
```

### 4. Framework Detection & Mapping

```typescript
const FRAMEWORK_MAPPINGS = {
  'Angular': {
    instructionFiles: [
      { 
        name: 'angular-best-practices.md',
        source: 'https://angular.dev/assets/context/best-practices.md'
      },
      {
        name: 'llms-full.txt',
        source: 'https://angular.dev/ai/develop-with-ai'
      }
    ],
    additionalContext: 'Angular with Jest testing patterns'
  },
  'React': {
    instructionFiles: [
      {
        name: 'react-best-practices.md',
        source: 'bundled' // Use bundled content
      }
    ]
  },
  'TypeScript': {
    instructionFiles: [
      {
        name: 'typescript-best-practices.md',
        source: 'bundled'
      }
    ]
  },
  'Jest': {
    instructionFiles: [
      {
        name: 'jest-best-practices.md',
        source: 'custom',
        content: 'Jest testing patterns and mock best practices'
      }
    ]
  }
}
```

### 5. Instruction Templates Library

```typescript
const INSTRUCTION_TEMPLATES = {
  angular: {
    component: {
      metadata: {
        targets: ['**/*.component.ts'],
        framework: 'angular',
        codeStyle: 'clean'
      },
      content: `
# Angular Component Guidelines

## Structure
- Use standalone components
- Implement OnPush change detection
- Follow single responsibility principle

## Testing with Jest
- Test component inputs/outputs
- Mock services using jest.mock()
- Use TestBed for integration tests
      `
    },
    service: {
      metadata: {
        targets: ['**/*.service.ts'],
        framework: 'angular'
      },
      content: `...`
    }
  },
  react: {
    // Similar structure for React
  },
  typescript: {
    // TypeScript-specific instructions
  }
}
```

### 6. Configuration Schema

```typescript
interface CopilotInstructionsConfig {
  // Basic settings
  enabled: boolean;
  autoSetup: boolean;
  
  // Instruction sources
  sources: {
    bundled: boolean;      // Use bundled best practices
    context7: boolean;     // Use Context7 when available
    custom: string[];      // Custom instruction URLs
  };
  
  // Targeting
  useTargeting: boolean;   // Enable file-specific instructions
  globalTargets: string[]; // Global exclusions
  
  // Style preferences
  instructionStyle: {
    length: 'concise' | 'detailed';
    format: 'markdown' | 'plain';
    examples: boolean;
  };
  
  // Framework overrides
  frameworkSettings: {
    [framework: string]: {
      enabled: boolean;
      version: string;
      customPath?: string;
    };
  };
}
```

### 7. User Experience Flow

```typescript
class CopilotInstructionsUI {
  async showSetupWizard(): Promise<void> {
    // Step 1: Detect workspace
    const detected = await this.detectFrameworks();
    
    // Step 2: Show customization options
    const options = await vscode.window.showQuickPick([
      { label: 'üöÄ Quick Setup', description: 'Use recommended settings' },
      { label: '‚öôÔ∏è Custom Setup', description: 'Configure each framework' },
      { label: 'üìö Browse Templates', description: 'See available templates' }
    ]);
    
    // Step 3: Preview before writing
    const preview = await this.generatePreview(options);
    const confirmed = await this.showPreview(preview);
    
    // Step 4: Write files
    if (confirmed) {
      await this.writeInstructions(preview);
    }
  }
}
```

## Implementation Phases

### Phase 1: MVP (Week 1)
- [ ] Create `CopilotInstructionsGenerator` class
- [ ] Implement folder structure creation
- [ ] Generate basic `copilot-instructions.md` with AI Context links
- [ ] Basic Angular support with hardcoded best practices
- [ ] Command palette integration

### Phase 2: Smart Instructions (Week 2)
- [ ] Metadata and targeting support
- [ ] Multiple framework support (React, Vue, TypeScript)
- [ ] Conflict resolution system
- [ ] Testing framework integration
- [ ] Instruction validation

### Phase 3: Advanced Features (Week 3)
- [ ] Context7 API integration research
- [ ] Custom instruction templates
- [ ] VS Code settings integration
- [ ] Update detection and merging
- [ ] User customization preservation

### Phase 4: Intelligence Layer (Week 4)
- [ ] Usage analytics (opt-in)
- [ ] Instruction effectiveness tracking
- [ ] Suggestion improvements
- [ ] Community template sharing

## Best Practices (from research)

1. **Keep It Concise** - Limit instructions to high-impact rules
2. **Provide Examples** - Include code examples for style guidelines  
3. **Layer Appropriately** - Understand repo vs user vs org instructions
4. **Focus on Value** - Don't duplicate what linters already handle
5. **Test Iteratively** - Copilot is non-deterministic, test thoroughly
6. **Use File Targeting** - Apply specific rules to specific file types
7. **Version Everything** - Track instruction versions for updates

## Success Metrics

1. **Technical Metrics**
   - Successful file generation without errors
   - No conflicts with existing instructions
   - Proper framework detection accuracy

2. **User Experience Metrics**
   - Time to setup < 30 seconds
   - Clear preview before writing files
   - Easy customization options

3. **Impact Metrics**
   - Improved Copilot suggestion accuracy
   - Reduced need for manual context in prompts
   - Positive user feedback

## Future Considerations

1. **MCP Server Integration**
   - Build custom MCP server for project context
   - Dynamic instruction updates based on code changes

2. **AI-Powered Improvements**
   - Learn from accepted/rejected suggestions
   - Auto-tune instructions based on patterns

3. **Ecosystem Integration**
   - Share instruction templates
   - Community-driven best practices
   - Integration with other AI tools

## Technical Decisions

1. **Bundled vs Dynamic Content**
   - Start with bundled content for reliability
   - Add dynamic fetching as optional feature
   - Cache frequently used instructions

2. **File Format**
   - Use markdown with YAML front matter
   - Support for includes/references
   - Versioning in metadata

3. **Conflict Resolution**
   - Specificity-based (more specific wins)
   - Priority levels in metadata
   - User overrides always win

## Risk Mitigation

1. **Over-Engineering** - Start simple, iterate based on feedback
2. **Instruction Conflicts** - Clear precedence rules, validation
3. **Performance** - Cache instructions, lazy load templates
4. **Maintenance** - Version everything, clear update paths

## Conclusion

Phase 3.5.0 will transform how developers interact with GitHub Copilot in their projects by providing intelligent, context-aware instructions that improve code generation quality while maintaining simplicity and avoiding instruction conflicts.