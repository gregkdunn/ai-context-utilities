b5da2670a16c842ecf009bbd01eb9e35
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
// Mock dependencies
jest.mock('vscode');
const FlipperDetectionManager_1 = require("../FlipperDetectionManager");
const vscode = __importStar(require("vscode"));
describe('FlipperDetectionManager', () => {
    let flipperManager;
    let mockContext;
    beforeEach(() => {
        mockContext = {
            subscriptions: [],
            extensionUri: vscode.Uri.file('/test')
        };
        // Mock vscode.workspace
        vscode.workspace.createFileSystemWatcher = jest.fn().mockReturnValue({
            onDidChange: jest.fn(),
            onDidCreate: jest.fn(),
            onDidDelete: jest.fn(),
            dispose: jest.fn()
        });
        flipperManager = new FlipperDetectionManager_1.FlipperDetectionManager(mockContext);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe('analyzeCode', () => {
        it('should detect FlipperService imports', async () => {
            const code = `import { FlipperService } from '@callrail/looky/core';`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(1);
            expect(result.detections[0].type).toBe('import');
            expect(result.detections[0].pattern).toContain('FlipperService import');
        });
        it('should detect and extract flag names from flipperEnabled calls', async () => {
            const code = `if (this.flipperService.flipperEnabled('zuora_maintenance')) {`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(3); // method_call, flag_literal, conditional
            const methodCallDetection = result.detections.find(d => d.type === 'method_call');
            expect(methodCallDetection).toBeDefined();
            expect(methodCallDetection.flagName).toBe('zuora_maintenance');
        });
        it('should detect predefined observable usage', async () => {
            const code = `
                return this.flipperService.zuoraMaintenance$.pipe(
                    switchMap(enabled => enabled ? this.processPayment() : of(false))
                );
            `;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections.length).toBeGreaterThan(0);
            expect(result.detections.some(d => d.flagName === 'zuora_maintenance')).toBe(true);
        });
        it('should detect multiple different patterns in same code', async () => {
            const code = `
                import { FlipperService } from '@callrail/looky/core';
                
                export class TestService {
                    constructor(private flipperService: FlipperService) {}
                    
                    test() {
                        if (this.flipperService.flipperEnabled('test_flag')) {
                            return this.flipperService.eagerlyEnabled('another_flag');
                        }
                        return this.flipperService.zuoraMaintenance$.pipe(map(x => x));
                    }
                }
            `;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections.length).toBeGreaterThan(3);
            // Check for different types of detections
            const types = result.detections.map(d => d.type);
            expect(types).toContain('import');
            expect(types).toContain('injection');
            expect(types).toContain('method_call');
            expect(types).toContain('predefined_observable');
        });
        it('should detect Angular template patterns', async () => {
            const code = `<div *ngIf="flipperService.flipperEnabled('ui_feature')">Content</div>`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(2); // method_call and template
            const templateDetection = result.detections.find(d => d.type === 'template');
            expect(templateDetection).toBeDefined();
            expect(templateDetection.flagName).toBe('ui_feature');
        });
        it('should detect flag literals', async () => {
            const code = `const flag = 'zuora_maintenance';`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(1);
            expect(result.detections[0].type).toBe('flag_literal');
            expect(result.detections[0].flagName).toBe('zuora_maintenance');
        });
        it('should provide context for detections', async () => {
            const code = `
                const someCode = 'before';
                if (this.flipperService.flipperEnabled('test_flag')) {
                    console.log('feature enabled');
                }
                const moreCode = 'after';
            `;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(2); // method_call and conditional
            const methodCallDetection = result.detections.find(d => d.type === 'method_call');
            expect(methodCallDetection).toBeDefined();
            expect(methodCallDetection.context).toContain('flipperEnabled');
            expect(methodCallDetection.context).toContain('test_flag');
        });
        it('should calculate line and column numbers correctly', async () => {
            const code = `line 1
line 2
if (this.flipperService.flipperEnabled('test_flag')) {
line 4`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections).toHaveLength(2); // method_call and conditional
            const methodCallDetection = result.detections.find(d => d.type === 'method_call');
            expect(methodCallDetection).toBeDefined();
            expect(methodCallDetection.line).toBe(3);
            expect(methodCallDetection.column).toBeGreaterThan(0);
        });
    });
    describe('analyzeGitDiffForFlippers', () => {
        it('should analyze git diff and detect flipper changes', async () => {
            const mockDiff = `
diff --git a/src/app/services/billing.service.ts b/src/app/services/billing.service.ts
index 1234567..abcdefg 100644
--- a/src/app/services/billing.service.ts
+++ b/src/app/services/billing.service.ts
@@ -1,4 +1,8 @@
+import { FlipperService } from '@callrail/looky/core';
+
 export class BillingService {
+  constructor(private flipperService: FlipperService) {}
+  
+  isZuoraMaintenance = this.flipperService.flipperEnabled('zuora_maintenance');
   canProcessPayment(): Observable<boolean> {
     return of(true);
   }
            `;
            const result = await flipperManager.analyzeGitDiffForFlippers(mockDiff);
            expect(result.detectedFlags).toContain('zuora_maintenance');
            expect(result.files).toHaveLength(1);
            expect(result.files[0].path).toBe('src/app/services/billing.service.ts');
            expect(result.files[0].detections.length).toBeGreaterThan(0);
        });
        it('should generate QA section for PR', async () => {
            const mockDiff = `
diff --git a/src/app/test.ts b/src/app/test.ts
+  if (this.flipperService.flipperEnabled('new_feature')) {
+    // New feature implementation
+  }
            `;
            const result = await flipperManager.analyzeGitDiffForFlippers(mockDiff);
            expect(result.qaSection).toContain('ðŸ”„ Feature Flags / Flipper Changes');
            expect(result.qaSection).toContain('QA Checklist - Flipper Setup Required');
            expect(result.qaSection).toContain('new_feature');
            expect(result.qaSection).toContain('Schedule flipper removal');
        });
        it('should generate details section for environment setup', async () => {
            const mockDiff = `
diff --git a/src/app/test.ts b/src/app/test.ts
+  if (this.flipperService.flipperEnabled('test_flag')) {
+    return true;
+  }
            `;
            const result = await flipperManager.analyzeGitDiffForFlippers(mockDiff);
            expect(result.detailsSection).toContain('Environment Setup Details');
            expect(result.detailsSection).toContain('Staging Environment Setup');
            expect(result.detailsSection).toContain('Production Environment Setup');
            expect(result.detailsSection).toContain('test_flag');
        });
        it('should return empty sections when no flippers detected', async () => {
            const mockDiff = `
diff --git a/src/app/test.ts b/src/app/test.ts
+  const normalCode = 'no flippers here';
            `;
            const result = await flipperManager.analyzeGitDiffForFlippers(mockDiff);
            expect(result.detectedFlags).toHaveLength(0);
            expect(result.qaSection).toBe('');
            expect(result.detailsSection).toBe('');
        });
        it('should only analyze relevant file types', async () => {
            const mockDiff = `
diff --git a/README.md b/README.md
+  # This contains flipperEnabled('test') but should be ignored
diff --git a/src/app/test.ts b/src/app/test.ts
+  if (this.flipperService.flipperEnabled('real_flag')) {
            `;
            const result = await flipperManager.analyzeGitDiffForFlippers(mockDiff);
            expect(result.files).toHaveLength(1);
            expect(result.files[0].path).toBe('src/app/test.ts');
            expect(result.detectedFlags).toEqual(['real_flag']);
        });
    });
    describe('caching', () => {
        it('should cache analysis results', async () => {
            const code = `if (this.flipperService.flipperEnabled('test_flag')) {}`;
            // First call
            const result1 = await flipperManager.analyzeCode(code);
            // Second call should use cache
            const result2 = await flipperManager.analyzeCode(code);
            expect(result1).toEqual(result2);
            expect(result1.detections).toHaveLength(2); // method_call and conditional
        });
    });
    describe('flag mapping', () => {
        it('should map predefined observables to correct flag names', async () => {
            const code = `return this.flipperService.zuoraMaintenance$.pipe(map(x => x));`;
            const result = await flipperManager.analyzeCode(code);
            expect(result.detections.some(d => d.flagName === 'zuora_maintenance')).toBe(true);
        });
        it('should handle all predefined observable mappings', async () => {
            const code = `
                this.flipperService.zuoraMaintenance$.subscribe();
                this.flipperService.reportingNoop$.subscribe();
                this.flipperService.acceleratedCallLog$.subscribe();
                this.flipperService.otherHomepage$.subscribe();
                this.flipperService.fullstory$.subscribe();
                this.flipperService.cursorPaginateAcceleratedCallLog$.subscribe();
            `;
            const result = await flipperManager.analyzeCode(code);
            const expectedFlags = [
                'zuora_maintenance',
                'reporting_noop',
                'accelerated_call_log',
                'other_homepage',
                'allow_fullstory_tracking',
                'cursor_paginate_accelerated_call_log'
            ];
            const detectedFlags = result.detections.map(d => d.flagName).filter(Boolean);
            expectedFlags.forEach(flag => {
                expect(detectedFlags).toContain(flag);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy9zZXJ2aWNlcy9mbGlwcGVyL19fdGVzdHNfXy9GbGlwcGVyRGV0ZWN0aW9uTWFuYWdlci50ZXN0LnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR0Esb0JBQW9CO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFKcEIsd0VBQXFFO0FBQ3JFLCtDQUFpQztBQUtqQyxRQUFRLENBQUMseUJBQXlCLEVBQUUsR0FBRyxFQUFFO0lBQ3JDLElBQUksY0FBdUMsQ0FBQztJQUM1QyxJQUFJLFdBQW9DLENBQUM7SUFFekMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNaLFdBQVcsR0FBRztZQUNWLGFBQWEsRUFBRSxFQUFFO1lBQ2pCLFlBQVksRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDbEMsQ0FBQztRQUVULHdCQUF3QjtRQUN2QixNQUFNLENBQUMsU0FBaUIsQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQzFFLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3JCLENBQUMsQ0FBQztRQUVILGNBQWMsR0FBRyxJQUFJLGlEQUF1QixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlELENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNYLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQ3pCLEVBQUUsQ0FBQyxz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QztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9ncmVnZHVubi9zcmMvdGVzdC9haV9kZWJ1Z19jb250ZXh0L3ZzY29kZS9zcmMvc2VydmljZXMvZmxpcHBlci9fX3Rlc3RzX18vRmxpcHBlckRldGVjdGlvbk1hbmFnZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGbGlwcGVyRGV0ZWN0aW9uTWFuYWdlciB9IGZyb20gJy4uL0ZsaXBwZXJEZXRlY3Rpb25NYW5hZ2VyJztcbmltcG9ydCAqIGFzIHZzY29kZSBmcm9tICd2c2NvZGUnO1xuXG4vLyBNb2NrIGRlcGVuZGVuY2llc1xuamVzdC5tb2NrKCd2c2NvZGUnKTtcblxuZGVzY3JpYmUoJ0ZsaXBwZXJEZXRlY3Rpb25NYW5hZ2VyJywgKCkgPT4ge1xuICAgIGxldCBmbGlwcGVyTWFuYWdlcjogRmxpcHBlckRldGVjdGlvbk1hbmFnZXI7XG4gICAgbGV0IG1vY2tDb250ZXh0OiB2c2NvZGUuRXh0ZW5zaW9uQ29udGV4dDtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBtb2NrQ29udGV4dCA9IHtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnM6IFtdLFxuICAgICAgICAgICAgZXh0ZW5zaW9uVXJpOiB2c2NvZGUuVXJpLmZpbGUoJy90ZXN0JylcbiAgICAgICAgfSBhcyBhbnk7XG5cbiAgICAgICAgLy8gTW9jayB2c2NvZGUud29ya3NwYWNlXG4gICAgICAgICh2c2NvZGUud29ya3NwYWNlIGFzIGFueSkuY3JlYXRlRmlsZVN5c3RlbVdhdGNoZXIgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICAgIG9uRGlkQ2hhbmdlOiBqZXN0LmZuKCksXG4gICAgICAgICAgICBvbkRpZENyZWF0ZTogamVzdC5mbigpLFxuICAgICAgICAgICAgb25EaWREZWxldGU6IGplc3QuZm4oKSxcbiAgICAgICAgICAgIGRpc3Bvc2U6IGplc3QuZm4oKVxuICAgICAgICB9KTtcblxuICAgICAgICBmbGlwcGVyTWFuYWdlciA9IG5ldyBGbGlwcGVyRGV0ZWN0aW9uTWFuYWdlcihtb2NrQ29udGV4dCk7XG4gICAgfSk7XG5cbiAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdhbmFseXplQ29kZScsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCBkZXRlY3QgRmxpcHBlclNlcnZpY2UgaW1wb3J0cycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgaW1wb3J0IHsgRmxpcHBlclNlcnZpY2UgfSBmcm9tICdAY2FsbHJhaWwvbG9va3kvY29yZSc7YDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmxpcHBlck1hbmFnZXIuYW5hbHl6ZUNvZGUoY29kZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGV0ZWN0aW9ucykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zWzBdLnR5cGUpLnRvQmUoJ2ltcG9ydCcpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zWzBdLnBhdHRlcm4pLnRvQ29udGFpbignRmxpcHBlclNlcnZpY2UgaW1wb3J0Jyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZGV0ZWN0IGFuZCBleHRyYWN0IGZsYWcgbmFtZXMgZnJvbSBmbGlwcGVyRW5hYmxlZCBjYWxscycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgaWYgKHRoaXMuZmxpcHBlclNlcnZpY2UuZmxpcHBlckVuYWJsZWQoJ3p1b3JhX21haW50ZW5hbmNlJykpIHtgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zKS50b0hhdmVMZW5ndGgoMyk7IC8vIG1ldGhvZF9jYWxsLCBmbGFnX2xpdGVyYWwsIGNvbmRpdGlvbmFsXG4gICAgICAgICAgICBjb25zdCBtZXRob2RDYWxsRGV0ZWN0aW9uID0gcmVzdWx0LmRldGVjdGlvbnMuZmluZChkID0+IGQudHlwZSA9PT0gJ21ldGhvZF9jYWxsJyk7XG4gICAgICAgICAgICBleHBlY3QobWV0aG9kQ2FsbERldGVjdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXRob2RDYWxsRGV0ZWN0aW9uIS5mbGFnTmFtZSkudG9CZSgnenVvcmFfbWFpbnRlbmFuY2UnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZXRlY3QgcHJlZGVmaW5lZCBvYnNlcnZhYmxlIHVzYWdlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29kZSA9IGBcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mbGlwcGVyU2VydmljZS56dW9yYU1haW50ZW5hbmNlJC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoZW5hYmxlZCA9PiBlbmFibGVkID8gdGhpcy5wcm9jZXNzUGF5bWVudCgpIDogb2YoZmFsc2UpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zLnNvbWUoZCA9PiBkLmZsYWdOYW1lID09PSAnenVvcmFfbWFpbnRlbmFuY2UnKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZXRlY3QgbXVsdGlwbGUgZGlmZmVyZW50IHBhdHRlcm5zIGluIHNhbWUgY29kZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgXG4gICAgICAgICAgICAgICAgaW1wb3J0IHsgRmxpcHBlclNlcnZpY2UgfSBmcm9tICdAY2FsbHJhaWwvbG9va3kvY29yZSc7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZXhwb3J0IGNsYXNzIFRlc3RTZXJ2aWNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBmbGlwcGVyU2VydmljZTogRmxpcHBlclNlcnZpY2UpIHt9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0ZXN0KCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZmxpcHBlclNlcnZpY2UuZmxpcHBlckVuYWJsZWQoJ3Rlc3RfZmxhZycpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmxpcHBlclNlcnZpY2UuZWFnZXJseUVuYWJsZWQoJ2Fub3RoZXJfZmxhZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmxpcHBlclNlcnZpY2UuenVvcmFNYWludGVuYW5jZSQucGlwZShtYXAoeCA9PiB4KSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDMpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgZGlmZmVyZW50IHR5cGVzIG9mIGRldGVjdGlvbnNcbiAgICAgICAgICAgIGNvbnN0IHR5cGVzID0gcmVzdWx0LmRldGVjdGlvbnMubWFwKGQgPT4gZC50eXBlKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlcykudG9Db250YWluKCdpbXBvcnQnKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlcykudG9Db250YWluKCdpbmplY3Rpb24nKTtcbiAgICAgICAgICAgIGV4cGVjdCh0eXBlcykudG9Db250YWluKCdtZXRob2RfY2FsbCcpO1xuICAgICAgICAgICAgZXhwZWN0KHR5cGVzKS50b0NvbnRhaW4oJ3ByZWRlZmluZWRfb2JzZXJ2YWJsZScpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGRldGVjdCBBbmd1bGFyIHRlbXBsYXRlIHBhdHRlcm5zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29kZSA9IGA8ZGl2ICpuZ0lmPVwiZmxpcHBlclNlcnZpY2UuZmxpcHBlckVuYWJsZWQoJ3VpX2ZlYXR1cmUnKVwiPkNvbnRlbnQ8L2Rpdj5gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zKS50b0hhdmVMZW5ndGgoMik7IC8vIG1ldGhvZF9jYWxsIGFuZCB0ZW1wbGF0ZVxuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGVEZXRlY3Rpb24gPSByZXN1bHQuZGV0ZWN0aW9ucy5maW5kKGQgPT4gZC50eXBlID09PSAndGVtcGxhdGUnKTtcbiAgICAgICAgICAgIGV4cGVjdCh0ZW1wbGF0ZURldGVjdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh0ZW1wbGF0ZURldGVjdGlvbiEuZmxhZ05hbWUpLnRvQmUoJ3VpX2ZlYXR1cmUnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkZXRlY3QgZmxhZyBsaXRlcmFscycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgY29uc3QgZmxhZyA9ICd6dW9yYV9tYWludGVuYW5jZSc7YDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmxpcHBlck1hbmFnZXIuYW5hbHl6ZUNvZGUoY29kZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGV0ZWN0aW9ucykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zWzBdLnR5cGUpLnRvQmUoJ2ZsYWdfbGl0ZXJhbCcpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zWzBdLmZsYWdOYW1lKS50b0JlKCd6dW9yYV9tYWludGVuYW5jZScpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHByb3ZpZGUgY29udGV4dCBmb3IgZGV0ZWN0aW9ucycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgXG4gICAgICAgICAgICAgICAgY29uc3Qgc29tZUNvZGUgPSAnYmVmb3JlJztcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5mbGlwcGVyU2VydmljZS5mbGlwcGVyRW5hYmxlZCgndGVzdF9mbGFnJykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZlYXR1cmUgZW5hYmxlZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBtb3JlQ29kZSA9ICdhZnRlcic7XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zKS50b0hhdmVMZW5ndGgoMik7IC8vIG1ldGhvZF9jYWxsIGFuZCBjb25kaXRpb25hbFxuICAgICAgICAgICAgY29uc3QgbWV0aG9kQ2FsbERldGVjdGlvbiA9IHJlc3VsdC5kZXRlY3Rpb25zLmZpbmQoZCA9PiBkLnR5cGUgPT09ICdtZXRob2RfY2FsbCcpO1xuICAgICAgICAgICAgZXhwZWN0KG1ldGhvZENhbGxEZXRlY3Rpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QobWV0aG9kQ2FsbERldGVjdGlvbiEuY29udGV4dCkudG9Db250YWluKCdmbGlwcGVyRW5hYmxlZCcpO1xuICAgICAgICAgICAgZXhwZWN0KG1ldGhvZENhbGxEZXRlY3Rpb24hLmNvbnRleHQpLnRvQ29udGFpbigndGVzdF9mbGFnJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgY2FsY3VsYXRlIGxpbmUgYW5kIGNvbHVtbiBudW1iZXJzIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgbGluZSAxXG5saW5lIDJcbmlmICh0aGlzLmZsaXBwZXJTZXJ2aWNlLmZsaXBwZXJFbmFibGVkKCd0ZXN0X2ZsYWcnKSkge1xubGluZSA0YDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmxpcHBlck1hbmFnZXIuYW5hbHl6ZUNvZGUoY29kZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGV0ZWN0aW9ucykudG9IYXZlTGVuZ3RoKDIpOyAvLyBtZXRob2RfY2FsbCBhbmQgY29uZGl0aW9uYWxcbiAgICAgICAgICAgIGNvbnN0IG1ldGhvZENhbGxEZXRlY3Rpb24gPSByZXN1bHQuZGV0ZWN0aW9ucy5maW5kKGQgPT4gZC50eXBlID09PSAnbWV0aG9kX2NhbGwnKTtcbiAgICAgICAgICAgIGV4cGVjdChtZXRob2RDYWxsRGV0ZWN0aW9uKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgZXhwZWN0KG1ldGhvZENhbGxEZXRlY3Rpb24hLmxpbmUpLnRvQmUoMyk7XG4gICAgICAgICAgICBleHBlY3QobWV0aG9kQ2FsbERldGVjdGlvbiEuY29sdW1uKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2FuYWx5emVHaXREaWZmRm9yRmxpcHBlcnMnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgYW5hbHl6ZSBnaXQgZGlmZiBhbmQgZGV0ZWN0IGZsaXBwZXIgY2hhbmdlcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tEaWZmID0gYFxuZGlmZiAtLWdpdCBhL3NyYy9hcHAvc2VydmljZXMvYmlsbGluZy5zZXJ2aWNlLnRzIGIvc3JjL2FwcC9zZXJ2aWNlcy9iaWxsaW5nLnNlcnZpY2UudHNcbmluZGV4IDEyMzQ1NjcuLmFiY2RlZmcgMTAwNjQ0XG4tLS0gYS9zcmMvYXBwL3NlcnZpY2VzL2JpbGxpbmcuc2VydmljZS50c1xuKysrIGIvc3JjL2FwcC9zZXJ2aWNlcy9iaWxsaW5nLnNlcnZpY2UudHNcbkBAIC0xLDQgKzEsOCBAQFxuK2ltcG9ydCB7IEZsaXBwZXJTZXJ2aWNlIH0gZnJvbSAnQGNhbGxyYWlsL2xvb2t5L2NvcmUnO1xuK1xuIGV4cG9ydCBjbGFzcyBCaWxsaW5nU2VydmljZSB7XG4rICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZsaXBwZXJTZXJ2aWNlOiBGbGlwcGVyU2VydmljZSkge31cbisgIFxuKyAgaXNadW9yYU1haW50ZW5hbmNlID0gdGhpcy5mbGlwcGVyU2VydmljZS5mbGlwcGVyRW5hYmxlZCgnenVvcmFfbWFpbnRlbmFuY2UnKTtcbiAgIGNhblByb2Nlc3NQYXltZW50KCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICB9XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplR2l0RGlmZkZvckZsaXBwZXJzKG1vY2tEaWZmKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3RlZEZsYWdzKS50b0NvbnRhaW4oJ3p1b3JhX21haW50ZW5hbmNlJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmZpbGVzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmZpbGVzWzBdLnBhdGgpLnRvQmUoJ3NyYy9hcHAvc2VydmljZXMvYmlsbGluZy5zZXJ2aWNlLnRzJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmZpbGVzWzBdLmRldGVjdGlvbnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgUUEgc2VjdGlvbiBmb3IgUFInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2NrRGlmZiA9IGBcbmRpZmYgLS1naXQgYS9zcmMvYXBwL3Rlc3QudHMgYi9zcmMvYXBwL3Rlc3QudHNcbisgIGlmICh0aGlzLmZsaXBwZXJTZXJ2aWNlLmZsaXBwZXJFbmFibGVkKCduZXdfZmVhdHVyZScpKSB7XG4rICAgIC8vIE5ldyBmZWF0dXJlIGltcGxlbWVudGF0aW9uXG4rICB9XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplR2l0RGlmZkZvckZsaXBwZXJzKG1vY2tEaWZmKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5xYVNlY3Rpb24pLnRvQ29udGFpbign8J+UhCBGZWF0dXJlIEZsYWdzIC8gRmxpcHBlciBDaGFuZ2VzJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnFhU2VjdGlvbikudG9Db250YWluKCdRQSBDaGVja2xpc3QgLSBGbGlwcGVyIFNldHVwIFJlcXVpcmVkJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnFhU2VjdGlvbikudG9Db250YWluKCduZXdfZmVhdHVyZScpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5xYVNlY3Rpb24pLnRvQ29udGFpbignU2NoZWR1bGUgZmxpcHBlciByZW1vdmFsJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgZGV0YWlscyBzZWN0aW9uIGZvciBlbnZpcm9ubWVudCBzZXR1cCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tEaWZmID0gYFxuZGlmZiAtLWdpdCBhL3NyYy9hcHAvdGVzdC50cyBiL3NyYy9hcHAvdGVzdC50c1xuKyAgaWYgKHRoaXMuZmxpcHBlclNlcnZpY2UuZmxpcHBlckVuYWJsZWQoJ3Rlc3RfZmxhZycpKSB7XG4rICAgIHJldHVybiB0cnVlO1xuKyAgfVxuICAgICAgICAgICAgYDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmxpcHBlck1hbmFnZXIuYW5hbHl6ZUdpdERpZmZGb3JGbGlwcGVycyhtb2NrRGlmZik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGV0YWlsc1NlY3Rpb24pLnRvQ29udGFpbignRW52aXJvbm1lbnQgU2V0dXAgRGV0YWlscycpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRhaWxzU2VjdGlvbikudG9Db250YWluKCdTdGFnaW5nIEVudmlyb25tZW50IFNldHVwJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmRldGFpbHNTZWN0aW9uKS50b0NvbnRhaW4oJ1Byb2R1Y3Rpb24gRW52aXJvbm1lbnQgU2V0dXAnKTtcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuZGV0YWlsc1NlY3Rpb24pLnRvQ29udGFpbigndGVzdF9mbGFnJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGVtcHR5IHNlY3Rpb25zIHdoZW4gbm8gZmxpcHBlcnMgZGV0ZWN0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2NrRGlmZiA9IGBcbmRpZmYgLS1naXQgYS9zcmMvYXBwL3Rlc3QudHMgYi9zcmMvYXBwL3Rlc3QudHNcbisgIGNvbnN0IG5vcm1hbENvZGUgPSAnbm8gZmxpcHBlcnMgaGVyZSc7XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplR2l0RGlmZkZvckZsaXBwZXJzKG1vY2tEaWZmKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3RlZEZsYWdzKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnFhU2VjdGlvbikudG9CZSgnJyk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmRldGFpbHNTZWN0aW9uKS50b0JlKCcnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBvbmx5IGFuYWx5emUgcmVsZXZhbnQgZmlsZSB0eXBlcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tEaWZmID0gYFxuZGlmZiAtLWdpdCBhL1JFQURNRS5tZCBiL1JFQURNRS5tZFxuKyAgIyBUaGlzIGNvbnRhaW5zIGZsaXBwZXJFbmFibGVkKCd0ZXN0JykgYnV0IHNob3VsZCBiZSBpZ25vcmVkXG5kaWZmIC0tZ2l0IGEvc3JjL2FwcC90ZXN0LnRzIGIvc3JjL2FwcC90ZXN0LnRzXG4rICBpZiAodGhpcy5mbGlwcGVyU2VydmljZS5mbGlwcGVyRW5hYmxlZCgncmVhbF9mbGFnJykpIHtcbiAgICAgICAgICAgIGA7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZsaXBwZXJNYW5hZ2VyLmFuYWx5emVHaXREaWZmRm9yRmxpcHBlcnMobW9ja0RpZmYpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmZpbGVzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmZpbGVzWzBdLnBhdGgpLnRvQmUoJ3NyYy9hcHAvdGVzdC50cycpO1xuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3RlZEZsYWdzKS50b0VxdWFsKFsncmVhbF9mbGFnJ10pO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdjYWNoaW5nJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIGNhY2hlIGFuYWx5c2lzIHJlc3VsdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb2RlID0gYGlmICh0aGlzLmZsaXBwZXJTZXJ2aWNlLmZsaXBwZXJFbmFibGVkKCd0ZXN0X2ZsYWcnKSkge31gO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBGaXJzdCBjYWxsXG4gICAgICAgICAgICBjb25zdCByZXN1bHQxID0gYXdhaXQgZmxpcHBlck1hbmFnZXIuYW5hbHl6ZUNvZGUoY29kZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlY29uZCBjYWxsIHNob3VsZCB1c2UgY2FjaGVcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDIgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdDEpLnRvRXF1YWwocmVzdWx0Mik7XG4gICAgICAgICAgICBleHBlY3QocmVzdWx0MS5kZXRlY3Rpb25zKS50b0hhdmVMZW5ndGgoMik7IC8vIG1ldGhvZF9jYWxsIGFuZCBjb25kaXRpb25hbFxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdmbGFnIG1hcHBpbmcnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgbWFwIHByZWRlZmluZWQgb2JzZXJ2YWJsZXMgdG8gY29ycmVjdCBmbGFnIG5hbWVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29kZSA9IGByZXR1cm4gdGhpcy5mbGlwcGVyU2VydmljZS56dW9yYU1haW50ZW5hbmNlJC5waXBlKG1hcCh4ID0+IHgpKTtgO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmbGlwcGVyTWFuYWdlci5hbmFseXplQ29kZShjb2RlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kZXRlY3Rpb25zLnNvbWUoZCA9PiBkLmZsYWdOYW1lID09PSAnenVvcmFfbWFpbnRlbmFuY2UnKSkudG9CZSh0cnVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgYWxsIHByZWRlZmluZWQgb2JzZXJ2YWJsZSBtYXBwaW5ncycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBgXG4gICAgICAgICAgICAgICAgdGhpcy5mbGlwcGVyU2VydmljZS56dW9yYU1haW50ZW5hbmNlJC5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZsaXBwZXJTZXJ2aWNlLnJlcG9ydGluZ05vb3AkLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmxpcHBlclNlcnZpY2UuYWNjZWxlcmF0ZWRDYWxsTG9nJC5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZsaXBwZXJTZXJ2aWNlLm90aGVySG9tZXBhZ2UkLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZmxpcHBlclNlcnZpY2UuZnVsbHN0b3J5JC5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZsaXBwZXJTZXJ2aWNlLmN1cnNvclBhZ2luYXRlQWNjZWxlcmF0ZWRDYWxsTG9nJC5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIGA7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZsaXBwZXJNYW5hZ2VyLmFuYWx5emVDb2RlKGNvZGUpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZEZsYWdzID0gW1xuICAgICAgICAgICAgICAgICd6dW9yYV9tYWludGVuYW5jZScsXG4gICAgICAgICAgICAgICAgJ3JlcG9ydGluZ19ub29wJyxcbiAgICAgICAgICAgICAgICAnYWNjZWxlcmF0ZWRfY2FsbF9sb2cnLFxuICAgICAgICAgICAgICAgICdvdGhlcl9ob21lcGFnZScsXG4gICAgICAgICAgICAgICAgJ2FsbG93X2Z1bGxzdG9yeV90cmFja2luZycsXG4gICAgICAgICAgICAgICAgJ2N1cnNvcl9wYWdpbmF0ZV9hY2NlbGVyYXRlZF9jYWxsX2xvZydcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IGRldGVjdGVkRmxhZ3MgPSByZXN1bHQuZGV0ZWN0aW9ucy5tYXAoZCA9PiBkLmZsYWdOYW1lKS5maWx0ZXIoQm9vbGVhbik7XG4gICAgICAgICAgICBleHBlY3RlZEZsYWdzLmZvckVhY2goZmxhZyA9PiB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGRldGVjdGVkRmxhZ3MpLnRvQ29udGFpbihmbGFnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9