bbe2cdd7681b3f378cc12aca7c53c4a9
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.PluginSecurityService = exports.PluginDiscoveryService = void 0;
const path = __importStar(require("path"));
const fs = __importStar(require("fs"));
class PluginDiscoveryService {
    context;
    securityService;
    constructor(context) {
        this.context = context;
        this.securityService = new PluginSecurityService();
    }
    async discoverPlugins(directories) {
        const manifests = [];
        try {
            const dirArray = Array.isArray(directories) ? directories : [directories];
            const allPluginDirs = [];
            for (const directory of dirArray) {
                const pluginDirs = await this.getPluginDirectories(directory);
                allPluginDirs.push(...pluginDirs);
            }
            for (const pluginDir of allPluginDirs) {
                const manifest = await this.loadPluginManifest(pluginDir);
                if (manifest) {
                    manifests.push(manifest);
                }
            }
        }
        catch (error) {
            console.warn(`Failed to discover plugins:`, error);
        }
        return manifests;
    }
    async loadPlugin(manifest) {
        try {
            // Security check
            // Convert manifest to plugin-like object for security scan
            const pluginForScan = {
                metadata: manifest.metadata,
                activate: async () => { },
                deactivate: async () => { }
            };
            const securityReport = await this.securityService.scanPlugin(pluginForScan);
            if (!securityReport.approved) {
                throw new Error(`Plugin ${manifest.metadata.id} failed security scan`);
            }
            // Load plugin module
            const pluginModule = require(manifest.entryPoint);
            const PluginClass = pluginModule.default || pluginModule;
            if (typeof PluginClass !== 'function') {
                throw new Error(`Plugin ${manifest.metadata.id} does not export a valid plugin class`);
            }
            const plugin = new PluginClass();
            // Validate plugin structure
            if (!await this.validatePlugin(plugin)) {
                throw new Error(`Plugin ${manifest.metadata.id} failed validation`);
            }
            return plugin;
        }
        catch (error) {
            throw new Error(`Failed to load plugin ${manifest.metadata.id}: ${error.message}`);
        }
    }
    async validatePlugin(manifest) {
        const errors = [];
        const warnings = [];
        try {
            // Check required properties
            if (!manifest.metadata.id || !manifest.metadata.name || !manifest.metadata.version) {
                errors.push('Plugin must have id, name, and version in metadata');
            }
            // Check capabilities
            if (!manifest.metadata.capabilities || manifest.metadata.capabilities.length === 0) {
                warnings.push('Plugin should declare at least one capability');
            }
            // Validate version format
            if (!this.isValidVersion(manifest.metadata.version)) {
                errors.push('Plugin version must follow semantic versioning');
            }
            // Check capabilities structure
            for (const capability of manifest.metadata.capabilities) {
                if (!capability.type || !capability.name) {
                    errors.push('Each capability must have type and name');
                }
            }
            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }
        catch (error) {
            return {
                isValid: false,
                errors: [`Plugin validation failed: ${error.message}`],
                warnings
            };
        }
    }
    async getPluginDirectories(directory) {
        const directories = [];
        if (!fs.existsSync(directory)) {
            return directories;
        }
        const entries = fs.readdirSync(directory, { withFileTypes: true });
        for (const entry of entries) {
            if (entry.isDirectory()) {
                const pluginDir = path.join(directory, entry.name);
                const packageJsonPath = path.join(pluginDir, 'package.json');
                if (fs.existsSync(packageJsonPath)) {
                    directories.push(pluginDir);
                }
            }
        }
        return directories;
    }
    async loadPluginManifest(pluginDir) {
        try {
            const packageJsonPath = path.join(pluginDir, 'package.json');
            const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
            // Check if it's an AI Debug plugin
            if (!packageJson.keywords?.includes('ai-debug-plugin')) {
                return null;
            }
            const metadata = {
                id: packageJson.name,
                name: packageJson.displayName || packageJson.name,
                version: packageJson.version,
                description: packageJson.description,
                author: packageJson.author,
                license: packageJson.license,
                repository: packageJson.repository?.url,
                homepage: packageJson.homepage,
                keywords: packageJson.keywords,
                enabled: true, // Default to enabled
                capabilities: packageJson.aiDebugPlugin?.capabilities || [],
                dependencies: packageJson.aiDebugPlugin?.dependencies || [],
                engineVersion: packageJson.aiDebugPlugin?.engineVersion || '1.0.0',
                config: packageJson.aiDebugPlugin?.config || {},
                icon: packageJson.aiDebugPlugin?.icon,
                documentation: packageJson.aiDebugPlugin?.documentation,
                examples: packageJson.aiDebugPlugin?.examples || []
            };
            const entryPoint = path.join(pluginDir, packageJson.main || 'index.js');
            if (!fs.existsSync(entryPoint)) {
                throw new Error(`Entry point not found: ${entryPoint}`);
            }
            return {
                path: pluginDir,
                packageJson,
                metadata,
                entryPoint
            };
        }
        catch (error) {
            console.warn(`Failed to load plugin manifest from ${pluginDir}:`, error);
            return null;
        }
    }
    isValidVersion(version) {
        // Simplified semver regex that works with TypeScript
        const semverRegex = /^\d+\.\d+\.\d+(?:-[\w.-]+)?(?:\+[\w.-]+)?$/;
        return semverRegex.test(version);
    }
}
exports.PluginDiscoveryService = PluginDiscoveryService;
class PluginSecurityService {
    async validatePlugin(plugin) {
        const errors = [];
        const warnings = [];
        try {
            // Check required methods
            if (typeof plugin.activate !== 'function') {
                errors.push('Plugin must have an activate method');
            }
            if (typeof plugin.deactivate !== 'function') {
                errors.push('Plugin must have a deactivate method');
            }
            // Check metadata
            const { metadata } = plugin;
            if (!metadata.id || !metadata.name || !metadata.version) {
                errors.push('Plugin must have id, name, and version in metadata');
            }
            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }
        catch (error) {
            return {
                isValid: false,
                errors: [`Plugin validation failed: ${error.message}`],
                warnings
            };
        }
    }
    async scanPlugin(plugin) {
        const vulnerabilities = [];
        let riskLevel = 'low';
        // Check for suspicious dependencies
        // const suspiciousDeps = await this.checkDependencies(dependencies || {});
        // vulnerabilities.push(...suspiciousDeps);
        // Check permissions
        const permissionIssues = await this.checkPermissionsPrivate(plugin.metadata.capabilities);
        vulnerabilities.push(...permissionIssues);
        // Check code patterns - would need entry point from plugin metadata
        // const codeIssues = await this.checkCodePatterns(entryPoint);
        // vulnerabilities.push(...codeIssues);
        // Determine risk level
        const criticalVulns = vulnerabilities.filter(v => v.severity === 'critical');
        const highVulns = vulnerabilities.filter(v => v.severity === 'high');
        const mediumVulns = vulnerabilities.filter(v => v.severity === 'medium');
        if (criticalVulns.length > 0) {
            riskLevel = 'critical';
        }
        else if (highVulns.length > 0) {
            riskLevel = 'high';
        }
        else if (mediumVulns.length > 0) {
            riskLevel = 'medium';
        }
        return {
            pluginId: plugin.metadata.id,
            scannedAt: new Date(),
            riskLevel,
            issues: vulnerabilities.map(v => ({
                type: v.type,
                severity: v.severity,
                message: v.description,
                location: v.affectedFiles?.join(', '),
                fix: v.fix
            })),
            recommendations: this.generateRecommendations(vulnerabilities),
            approved: riskLevel !== 'critical' && vulnerabilities.length === 0
        };
    }
    async validatePermissions(plugin, permissions) {
        // Check if plugin is requesting only necessary permissions
        const validPermissions = ['file-system', 'network', 'extension-api', 'user-interaction', 'workspace-access'];
        for (const permission of permissions) {
            if (!validPermissions.includes(permission.type)) {
                return false;
            }
        }
        return true;
    }
    async sandboxPlugin(plugin) {
        // Implement plugin sandboxing if needed
        // This would involve creating a restricted execution environment
        console.log(`Sandboxing plugin: ${plugin.metadata.id}`);
    }
    async checkIntegrity(plugin) {
        // Implement integrity checking
        // This would involve verifying plugin signatures, checksums, etc.
        return true;
    }
    async checkDependencies(dependencies) {
        const vulnerabilities = [];
        // List of known malicious or problematic packages
        const suspiciousPackages = [
            'exec', 'child_process', 'spawn', 'eval', 'vm'
        ];
        for (const [depName, version] of Object.entries(dependencies)) {
            if (suspiciousPackages.includes(depName)) {
                vulnerabilities.push({
                    id: `dep-${depName}`,
                    type: 'dependency',
                    severity: 'medium',
                    description: `Potentially dangerous dependency: ${depName}`,
                    impact: 'Plugin can execute arbitrary code'
                });
            }
        }
        return vulnerabilities;
    }
    async checkPermissions(plugin) {
        const capabilities = plugin.metadata.capabilities;
        const granted = [];
        const denied = [];
        const requested = [];
        for (const capability of capabilities) {
            requested.push(capability.type);
            // Simple approval logic
            if (['command', 'analyzer', 'formatter'].includes(capability.type)) {
                granted.push(capability.type);
            }
            else {
                denied.push(capability.type);
            }
        }
        return { granted, denied, requested };
    }
    async checkPermissionsPrivate(capabilities) {
        const vulnerabilities = [];
        for (const capability of capabilities) {
            if (capability.permissions) {
                for (const permission of capability.permissions) {
                    if (permission.type === 'file-system' && permission.scope === '*') {
                        vulnerabilities.push({
                            id: `perm-fs-wildcard`,
                            type: 'permission',
                            severity: 'high',
                            description: 'Plugin requests unrestricted file system access',
                            impact: 'Plugin can read/write any file'
                        });
                    }
                }
            }
        }
        return vulnerabilities;
    }
    async checkCodePatterns(entryPoint) {
        const vulnerabilities = [];
        try {
            const code = fs.readFileSync(entryPoint, 'utf8');
            // Check for eval usage
            if (code.includes('eval(')) {
                vulnerabilities.push({
                    id: 'code-eval',
                    type: 'code',
                    severity: 'critical',
                    description: 'Plugin uses eval() which can execute arbitrary code',
                    impact: 'Code injection vulnerability'
                });
            }
            // Check for network requests to suspicious domains
            const suspiciousDomains = ['bit.ly', 'tinyurl.com', 'raw.githubusercontent.com'];
            for (const domain of suspiciousDomains) {
                if (code.includes(domain)) {
                    vulnerabilities.push({
                        id: `code-suspicious-domain-${domain}`,
                        type: 'network',
                        severity: 'medium',
                        description: `Plugin makes requests to suspicious domain: ${domain}`,
                        impact: 'Potential data exfiltration'
                    });
                }
            }
        }
        catch (error) {
            console.warn(`Failed to scan code patterns in ${entryPoint}:`, error);
        }
        return vulnerabilities;
    }
    generateRecommendations(vulnerabilities) {
        const recommendations = [];
        if (vulnerabilities.some(v => v.severity === 'critical')) {
            recommendations.push('Do not install this plugin due to critical security issues');
        }
        if (vulnerabilities.some(v => v.severity === 'high')) {
            recommendations.push('Review plugin permissions and code before installation');
        }
        if (vulnerabilities.some(v => v.type === 'dependency')) {
            recommendations.push('Audit plugin dependencies for known vulnerabilities');
        }
        if (vulnerabilities.some(v => v.type === 'permission')) {
            recommendations.push('Limit plugin permissions to minimum necessary');
        }
        return recommendations;
    }
}
exports.PluginSecurityService = PluginSecurityService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2dyZWdkdW5uL3NyYy90ZXN0L2FpX2RlYnVnX2NvbnRleHQvdnNjb2RlL3NyYy9zZXJ2aWNlcy9wbHVnaW5zL3BsdWdpbkRpc2NvdmVyeS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSwyQ0FBNkI7QUFDN0IsdUNBQXlCO0FBYXpCLE1BQWEsc0JBQXNCO0lBR2I7SUFGWixlQUFlLENBQXdCO0lBRS9DLFlBQW9CLE9BQWdDO1FBQWhDLFlBQU8sR0FBUCxPQUFPLENBQXlCO1FBQ2xELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxxQkFBcUIsRUFBRSxDQUFDO0lBQ3JELENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQThCO1FBQ2xELE1BQU0sU0FBUyxHQUFxQixFQUFFLENBQUM7UUFFdkMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sYUFBYSxHQUFhLEVBQUUsQ0FBQztZQUVuQyxLQUFLLE1BQU0sU0FBUyxJQUFJLFFBQVEsRUFBRSxDQUFDO2dCQUNqQyxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDOUQsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDO1lBQ3BDLENBQUM7WUFFRCxLQUFLLE1BQU0sU0FBUyxJQUFJLGFBQWEsRUFBRSxDQUFDO2dCQUN0QyxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDMUQsSUFBSSxRQUFRLEVBQUUsQ0FBQztvQkFDYixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMzQixDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFB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RUFBRSxDQUFDO1lBQ3JELGVBQWUsQ0FBQyxJQUFJLENBQUMsd0RBQXdELENBQUMsQ0FBQztRQUNqRixDQUFDO1FBRUQsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQ3ZELGVBQWUsQ0FBQyxJQUFJLENBQUMscURBQXFELENBQUMsQ0FBQztRQUM5RSxDQUFDO1FBRUQsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQ3ZELGVBQWUsQ0FBQyxJQUFJLENBQUMsK0NBQStDLENBQUMsQ0FBQztRQUN4RSxDQUFDO1FBRUQsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBRVEsc0RBQXFCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9ncmVnZHVubi9zcmMvdGVzdC9haV9kZWJ1Z19jb250ZXh0L3ZzY29kZS9zcmMvc2VydmljZXMvcGx1Z2lucy9wbHVnaW5EaXNjb3ZlcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdnNjb2RlIGZyb20gJ3ZzY29kZSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgXG4gIFBsdWdpbkRpc2NvdmVyeSwgXG4gIFBsdWdpbk1hbmlmZXN0LCBcbiAgUGx1Z2luLCBcbiAgUGx1Z2luTWV0YWRhdGEsXG4gIFBsdWdpblNlY3VyaXR5LFxuICBTZWN1cml0eVJlcG9ydCxcbiAgU2VjdXJpdHlWdWxuZXJhYmlsaXR5LFxuICBWYWxpZGF0aW9uUmVzdWx0LFxuICBQZXJtaXNzaW9uUmVzdWx0IFxufSBmcm9tICcuLi8uLi90eXBlcy9wbHVnaW4nO1xuXG5leHBvcnQgY2xhc3MgUGx1Z2luRGlzY292ZXJ5U2VydmljZSBpbXBsZW1lbnRzIFBsdWdpbkRpc2NvdmVyeSB7XG4gIHByaXZhdGUgc2VjdXJpdHlTZXJ2aWNlOiBQbHVnaW5TZWN1cml0eVNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb250ZXh0OiB2c2NvZGUuRXh0ZW5zaW9uQ29udGV4dCkge1xuICAgIHRoaXMuc2VjdXJpdHlTZXJ2aWNlID0gbmV3IFBsdWdpblNlY3VyaXR5U2VydmljZSgpO1xuICB9XG5cbiAgYXN5bmMgZGlzY292ZXJQbHVnaW5zKGRpcmVjdG9yaWVzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IFByb21pc2U8UGx1Z2luTWFuaWZlc3RbXT4ge1xuICAgIGNvbnN0IG1hbmlmZXN0czogUGx1Z2luTWFuaWZlc3RbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRpckFycmF5ID0gQXJyYXkuaXNBcnJheShkaXJlY3RvcmllcykgPyBkaXJlY3RvcmllcyA6IFtkaXJlY3Rvcmllc107XG4gICAgICBjb25zdCBhbGxQbHVnaW5EaXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgXG4gICAgICBmb3IgKGNvbnN0IGRpcmVjdG9yeSBvZiBkaXJBcnJheSkge1xuICAgICAgICBjb25zdCBwbHVnaW5EaXJzID0gYXdhaXQgdGhpcy5nZXRQbHVnaW5EaXJlY3RvcmllcyhkaXJlY3RvcnkpO1xuICAgICAgICBhbGxQbHVnaW5EaXJzLnB1c2goLi4ucGx1Z2luRGlycyk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZvciAoY29uc3QgcGx1Z2luRGlyIG9mIGFsbFBsdWdpbkRpcnMpIHtcbiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSBhd2FpdCB0aGlzLmxvYWRQbHVnaW5NYW5pZmVzdChwbHVnaW5EaXIpO1xuICAgICAgICBpZiAobWFuaWZlc3QpIHtcbiAgICAgICAgICBtYW5pZmVzdHMucHVzaChtYW5pZmVzdCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gZGlzY292ZXIgcGx1Z2luczpgLCBlcnJvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hbmlmZXN0cztcbiAgfVxuXG4gIGFzeW5jIGxvYWRQbHVnaW4obWFuaWZlc3Q6IFBsdWdpbk1hbmlmZXN0KTogUHJvbWlzZTxQbHVnaW4+IHtcbiAgICB0cnkge1xuICAgICAgLy8gU2VjdXJpdHkgY2hlY2tcbiAgICAgIC8vIENvbnZlcnQgbWFuaWZlc3QgdG8gcGx1Z2luLWxpa2Ugb2JqZWN0IGZvciBzZWN1cml0eSBzY2FuXG4gICAgICBjb25zdCBwbHVnaW5Gb3JTY2FuID0ge1xuICAgICAgICBtZXRhZGF0YTogbWFuaWZlc3QubWV0YWRhdGEsXG4gICAgICAgIGFjdGl2YXRlOiBhc3luYyAoKSA9PiB7fSxcbiAgICAgICAgZGVhY3RpdmF0ZTogYXN5bmMgKCkgPT4ge31cbiAgICAgIH0gYXMgUGx1Z2luO1xuICAgICAgXG4gICAgICBjb25zdCBzZWN1cml0eVJlcG9ydCA9IGF3YWl0IHRoaXMuc2VjdXJpdHlTZXJ2aWNlLnNjYW5QbHVnaW4ocGx1Z2luRm9yU2Nhbik7XG4gICAgICBpZiAoIXNlY3VyaXR5UmVwb3J0LmFwcHJvdmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUGx1Z2luICR7bWFuaWZlc3QubWV0YWRhdGEuaWR9IGZhaWxlZCBzZWN1cml0eSBzY2FuYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIExvYWQgcGx1Z2luIG1vZHVsZVxuICAgICAgY29uc3QgcGx1Z2luTW9kdWxlID0gcmVxdWlyZShtYW5pZmVzdC5lbnRyeVBvaW50KTtcbiAgICAgIGNvbnN0IFBsdWdpbkNsYXNzID0gcGx1Z2luTW9kdWxlLmRlZmF1bHQgfHwgcGx1Z2luTW9kdWxlO1xuICAgICAgXG4gICAgICBpZiAodHlwZW9mIFBsdWdpbkNsYXNzICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUGx1Z2luICR7bWFuaWZlc3QubWV0YWRhdGEuaWR9IGRvZXMgbm90IGV4cG9ydCBhIHZhbGlkIHBsdWdpbiBjbGFzc2ApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwbHVnaW4gPSBuZXcgUGx1Z2luQ2xhc3MoKTtcbiAgICAgIFxuICAgICAgLy8gVmFsaWRhdGUgcGx1Z2luIHN0cnVjdHVyZVxuICAgICAgaWYgKCFhd2FpdCB0aGlzLnZhbGlkYXRlUGx1Z2luKHBsdWdpbikpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQbHVnaW4gJHttYW5pZmVzdC5tZXRhZGF0YS5pZH0gZmFpbGVkIHZhbGlkYXRpb25gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHBsdWdpbjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gbG9hZCBwbHVnaW4gJHttYW5pZmVzdC5tZXRhZGF0YS5pZH06ICR7KGVycm9yIGFzIEVycm9yKS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlUGx1Z2luKG1hbmlmZXN0OiBQbHVnaW5NYW5pZmVzdCk6IFByb21pc2U8VmFsaWRhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayByZXF1aXJlZCBwcm9wZXJ0aWVzXG4gICAgICBpZiAoIW1hbmlmZXN0Lm1ldGFkYXRhLmlkIHx8ICFtYW5pZmVzdC5tZXRhZGF0YS5uYW1lIHx8ICFtYW5pZmVzdC5tZXRhZGF0YS52ZXJzaW9uKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdQbHVnaW4gbXVzdCBoYXZlIGlkLCBuYW1lLCBhbmQgdmVyc2lvbiBpbiBtZXRhZGF0YScpO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBjYXBhYmlsaXRpZXNcbiAgICAgIGlmICghbWFuaWZlc3QubWV0YWRhdGEuY2FwYWJpbGl0aWVzIHx8IG1hbmlmZXN0Lm1ldGFkYXRhLmNhcGFiaWxpdGllcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgd2FybmluZ3MucHVzaCgnUGx1Z2luIHNob3VsZCBkZWNsYXJlIGF0IGxlYXN0IG9uZSBjYXBhYmlsaXR5Jyk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIHZlcnNpb24gZm9ybWF0XG4gICAgICBpZiAoIXRoaXMuaXNWYWxpZFZlcnNpb24obWFuaWZlc3QubWV0YWRhdGEudmVyc2lvbikpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ1BsdWdpbiB2ZXJzaW9uIG11c3QgZm9sbG93IHNlbWFudGljIHZlcnNpb25pbmcnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgY2FwYWJpbGl0aWVzIHN0cnVjdHVyZVxuICAgICAgZm9yIChjb25zdCBjYXBhYmlsaXR5IG9mIG1hbmlmZXN0Lm1ldGFkYXRhLmNhcGFiaWxpdGllcykge1xuICAgICAgICBpZiAoIWNhcGFiaWxpdHkudHlwZSB8fCAhY2FwYWJpbGl0eS5uYW1lKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goJ0VhY2ggY2FwYWJpbGl0eSBtdXN0IGhhdmUgdHlwZSBhbmQgbmFtZScpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgICAgIGVycm9ycyxcbiAgICAgICAgd2FybmluZ3NcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcnM6IFtgUGx1Z2luIHZhbGlkYXRpb24gZmFpbGVkOiAkeyhlcnJvciBhcyBFcnJvcikubWVzc2FnZX1gXSxcbiAgICAgICAgd2FybmluZ3NcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRQbHVnaW5EaXJlY3RvcmllcyhkaXJlY3Rvcnk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBkaXJlY3Rvcmllczogc3RyaW5nW10gPSBbXTtcbiAgICBcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyZWN0b3J5KSkge1xuICAgICAgcmV0dXJuIGRpcmVjdG9yaWVzO1xuICAgIH1cblxuICAgIGNvbnN0IGVudHJpZXMgPSBmcy5yZWFkZGlyU3luYyhkaXJlY3RvcnksIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgICAgIGlmIChlbnRyeS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIGNvbnN0IHBsdWdpbkRpciA9IHBhdGguam9pbihkaXJlY3RvcnksIGVudHJ5Lm5hbWUpO1xuICAgICAgICBjb25zdCBwYWNrYWdlSnNvblBhdGggPSBwYXRoLmpvaW4ocGx1Z2luRGlyLCAncGFja2FnZS5qc29uJyk7XG4gICAgICAgIFxuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhwYWNrYWdlSnNvblBhdGgpKSB7XG4gICAgICAgICAgZGlyZWN0b3JpZXMucHVzaChwbHVnaW5EaXIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGRpcmVjdG9yaWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkUGx1Z2luTWFuaWZlc3QocGx1Z2luRGlyOiBzdHJpbmcpOiBQcm9taXNlPFBsdWdpbk1hbmlmZXN0IHwgbnVsbD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYWNrYWdlSnNvblBhdGggPSBwYXRoLmpvaW4ocGx1Z2luRGlyLCAncGFja2FnZS5qc29uJyk7XG4gICAgICBjb25zdCBwYWNrYWdlSnNvbiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHBhY2thZ2VKc29uUGF0aCwgJ3V0ZjgnKSk7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gQUkgRGVidWcgcGx1Z2luXG4gICAgICBpZiAoIXBhY2thZ2VKc29uLmtleXdvcmRzPy5pbmNsdWRlcygnYWktZGVidWctcGx1Z2luJykpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1ldGFkYXRhOiBQbHVnaW5NZXRhZGF0YSA9IHtcbiAgICAgICAgaWQ6IHBhY2thZ2VKc29uLm5hbWUsXG4gICAgICAgIG5hbWU6IHBhY2thZ2VKc29uLmRpc3BsYXlOYW1lIHx8IHBhY2thZ2VKc29uLm5hbWUsXG4gICAgICAgIHZlcnNpb246IHBhY2thZ2VKc29uLnZlcnNpb24sXG4gICAgICAgIGRlc2NyaXB0aW9uOiBwYWNrYWdlSnNvbi5kZXNjcmlwdGlvbixcbiAgICAgICAgYXV0aG9yOiBwYWNrYWdlSnNvbi5hdXRob3IsXG4gICAgICAgIGxpY2Vuc2U6IHBhY2thZ2VKc29uLmxpY2Vuc2UsXG4gICAgICAgIHJlcG9zaXRvcnk6IHBhY2thZ2VKc29uLnJlcG9zaXRvcnk/LnVybCxcbiAgICAgICAgaG9tZXBhZ2U6IHBhY2thZ2VKc29uLmhvbWVwYWdlLFxuICAgICAgICBrZXl3b3JkczogcGFja2FnZUpzb24ua2V5d29yZHMsXG4gICAgICAgIGVuYWJsZWQ6IHRydWUsIC8vIERlZmF1bHQgdG8gZW5hYmxlZFxuICAgICAgICBjYXBhYmlsaXRpZXM6IHBhY2thZ2VKc29uLmFpRGVidWdQbHVnaW4/LmNhcGFiaWxpdGllcyB8fCBbXSxcbiAgICAgICAgZGVwZW5kZW5jaWVzOiBwYWNrYWdlSnNvbi5haURlYnVnUGx1Z2luPy5kZXBlbmRlbmNpZXMgfHwgW10sXG4gICAgICAgIGVuZ2luZVZlcnNpb246IHBhY2thZ2VKc29uLmFpRGVidWdQbHVnaW4/LmVuZ2luZVZlcnNpb24gfHwgJzEuMC4wJyxcbiAgICAgICAgY29uZmlnOiBwYWNrYWdlSnNvbi5haURlYnVnUGx1Z2luPy5jb25maWcgfHwge30sXG4gICAgICAgIGljb246IHBhY2thZ2VKc29uLmFpRGVidWdQbHVnaW4/Lmljb24sXG4gICAgICAgIGRvY3VtZW50YXRpb246IHBhY2thZ2VKc29uLmFpRGVidWdQbHVnaW4/LmRvY3VtZW50YXRpb24sXG4gICAgICAgIGV4YW1wbGVzOiBwYWNrYWdlSnNvbi5haURlYnVnUGx1Z2luPy5leGFtcGxlcyB8fCBbXVxuICAgICAgfTtcblxuICAgICAgY29uc3QgZW50cnlQb2ludCA9IHBhdGguam9pbihwbHVnaW5EaXIsIHBhY2thZ2VKc29uLm1haW4gfHwgJ2luZGV4LmpzJyk7XG4gICAgICBcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhlbnRyeVBvaW50KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVudHJ5IHBvaW50IG5vdCBmb3VuZDogJHtlbnRyeVBvaW50fWApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXRoOiBwbHVnaW5EaXIsXG4gICAgICAgIHBhY2thZ2VKc29uLFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAgZW50cnlQb2ludFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gbG9hZCBwbHVnaW4gbWFuaWZlc3QgZnJvbSAke3BsdWdpbkRpcn06YCwgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc1ZhbGlkVmVyc2lvbih2ZXJzaW9uOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBTaW1wbGlmaWVkIHNlbXZlciByZWdleCB0aGF0IHdvcmtzIHdpdGggVHlwZVNjcmlwdFxuICAgIGNvbnN0IHNlbXZlclJlZ2V4ID0gL15cXGQrXFwuXFxkK1xcLlxcZCsoPzotW1xcdy4tXSspPyg/OlxcK1tcXHcuLV0rKT8kLztcbiAgICByZXR1cm4gc2VtdmVyUmVnZXgudGVzdCh2ZXJzaW9uKTtcbiAgfVxufVxuXG5jbGFzcyBQbHVnaW5TZWN1cml0eVNlcnZpY2UgaW1wbGVtZW50cyBQbHVnaW5TZWN1cml0eSB7XG4gIGFzeW5jIHZhbGlkYXRlUGx1Z2luKHBsdWdpbjogUGx1Z2luKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIHJlcXVpcmVkIG1ldGhvZHNcbiAgICAgIGlmICh0eXBlb2YgcGx1Z2luLmFjdGl2YXRlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdQbHVnaW4gbXVzdCBoYXZlIGFuIGFjdGl2YXRlIG1ldGhvZCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5kZWFjdGl2YXRlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdQbHVnaW4gbXVzdCBoYXZlIGEgZGVhY3RpdmF0ZSBtZXRob2QnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgbWV0YWRhdGFcbiAgICAgIGNvbnN0IHsgbWV0YWRhdGEgfSA9IHBsdWdpbjtcbiAgICAgIGlmICghbWV0YWRhdGEuaWQgfHwgIW1ldGFkYXRhLm5hbWUgfHwgIW1ldGFkYXRhLnZlcnNpb24pIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ1BsdWdpbiBtdXN0IGhhdmUgaWQsIG5hbWUsIGFuZCB2ZXJzaW9uIGluIG1ldGFkYXRhJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgICAgIGVycm9ycyxcbiAgICAgICAgd2FybmluZ3NcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcnM6IFtgUGx1Z2luIHZhbGlkYXRpb24gZmFpbGVkOiAkeyhlcnJvciBhcyBFcnJvcikubWVzc2FnZX1gXSxcbiAgICAgICAgd2FybmluZ3NcbiAgICAgIH07XG4gICAgfVxuICB9XG4gIGFzeW5jIHNjYW5QbHVnaW4ocGx1Z2luOiBQbHVnaW4pOiBQcm9taXNlPFNlY3VyaXR5UmVwb3J0PiB7XG4gICAgY29uc3QgdnVsbmVyYWJpbGl0aWVzOiBTZWN1cml0eVZ1bG5lcmFiaWxpdHlbXSA9IFtdO1xuICAgIGxldCByaXNrTGV2ZWw6ICdsb3cnIHwgJ21lZGl1bScgfCAnaGlnaCcgfCAnY3JpdGljYWwnID0gJ2xvdyc7XG5cbiAgICAvLyBDaGVjayBmb3Igc3VzcGljaW91cyBkZXBlbmRlbmNpZXNcbiAgICAvLyBjb25zdCBzdXNwaWNpb3VzRGVwcyA9IGF3YWl0IHRoaXMuY2hlY2tEZXBlbmRlbmNpZXMoZGVwZW5kZW5jaWVzIHx8IHt9KTtcbiAgICAvLyB2dWxuZXJhYmlsaXRpZXMucHVzaCguLi5zdXNwaWNpb3VzRGVwcyk7XG5cbiAgICAvLyBDaGVjayBwZXJtaXNzaW9uc1xuICAgIGNvbnN0IHBlcm1pc3Npb25Jc3N1ZXMgPSBhd2FpdCB0aGlzLmNoZWNrUGVybWlzc2lvbnNQcml2YXRlKHBsdWdpbi5tZXRhZGF0YS5jYXBhYmlsaXRpZXMpO1xuICAgIHZ1bG5lcmFiaWxpdGllcy5wdXNoKC4uLnBlcm1pc3Npb25Jc3N1ZXMpO1xuICAgIFxuICAgIC8vIENoZWNrIGNvZGUgcGF0dGVybnMgLSB3b3VsZCBuZWVkIGVudHJ5IHBvaW50IGZyb20gcGx1Z2luIG1ldGFkYXRhXG4gICAgLy8gY29uc3QgY29kZUlzc3VlcyA9IGF3YWl0IHRoaXMuY2hlY2tDb2RlUGF0dGVybnMoZW50cnlQb2ludCk7XG4gICAgLy8gdnVsbmVyYWJpbGl0aWVzLnB1c2goLi4uY29kZUlzc3Vlcyk7XG5cbiAgICAvLyBEZXRlcm1pbmUgcmlzayBsZXZlbFxuICAgIGNvbnN0IGNyaXRpY2FsVnVsbnMgPSB2dWxuZXJhYmlsaXRpZXMuZmlsdGVyKHYgPT4gdi5zZXZlcml0eSA9PT0gJ2NyaXRpY2FsJyk7XG4gICAgY29uc3QgaGlnaFZ1bG5zID0gdnVsbmVyYWJpbGl0aWVzLmZpbHRlcih2ID0+IHYuc2V2ZXJpdHkgPT09ICdoaWdoJyk7XG4gICAgY29uc3QgbWVkaXVtVnVsbnMgPSB2dWxuZXJhYmlsaXRpZXMuZmlsdGVyKHYgPT4gdi5zZXZlcml0eSA9PT0gJ21lZGl1bScpO1xuXG4gICAgaWYgKGNyaXRpY2FsVnVsbnMubGVuZ3RoID4gMCkge1xuICAgICAgcmlza0xldmVsID0gJ2NyaXRpY2FsJztcbiAgICB9IGVsc2UgaWYgKGhpZ2hWdWxucy5sZW5ndGggPiAwKSB7XG4gICAgICByaXNrTGV2ZWwgPSAnaGlnaCc7XG4gICAgfSBlbHNlIGlmIChtZWRpdW1WdWxucy5sZW5ndGggPiAwKSB7XG4gICAgICByaXNrTGV2ZWwgPSAnbWVkaXVtJztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcGx1Z2luSWQ6IHBsdWdpbi5tZXRhZGF0YS5pZCxcbiAgICAgIHNjYW5uZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIHJpc2tMZXZlbCxcbiAgICAgIGlzc3VlczogdnVsbmVyYWJpbGl0aWVzLm1hcCh2ID0+ICh7XG4gICAgICAgIHR5cGU6IHYudHlwZSBhcyAncGVybWlzc2lvbicgfCAnY29kZScgfCAnZGVwZW5kZW5jeScgfCAnbmV0d29yaycgfCAnZmlsZScgfCAnZW52aXJvbm1lbnQnLFxuICAgICAgICBzZXZlcml0eTogdi5zZXZlcml0eSxcbiAgICAgICAgbWVzc2FnZTogdi5kZXNjcmlwdGlvbixcbiAgICAgICAgbG9jYXRpb246IHYuYWZmZWN0ZWRGaWxlcz8uam9pbignLCAnKSxcbiAgICAgICAgZml4OiB2LmZpeFxuICAgICAgfSkpLFxuICAgICAgcmVjb21tZW5kYXRpb25zOiB0aGlzLmdlbmVyYXRlUmVjb21tZW5kYXRpb25zKHZ1bG5lcmFiaWxpdGllcyksXG4gICAgICBhcHByb3ZlZDogcmlza0xldmVsICE9PSAnY3JpdGljYWwnICYmIHZ1bG5lcmFiaWxpdGllcy5sZW5ndGggPT09IDBcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGVQZXJtaXNzaW9ucyhwbHVnaW46IFBsdWdpbiwgcGVybWlzc2lvbnM6IGFueVtdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQ2hlY2sgaWYgcGx1Z2luIGlzIHJlcXVlc3Rpbmcgb25seSBuZWNlc3NhcnkgcGVybWlzc2lvbnNcbiAgICBjb25zdCB2YWxpZFBlcm1pc3Npb25zID0gWydmaWxlLXN5c3RlbScsICduZXR3b3JrJywgJ2V4dGVuc2lvbi1hcGknLCAndXNlci1pbnRlcmFjdGlvbicsICd3b3Jrc3BhY2UtYWNjZXNzJ107XG4gICAgXG4gICAgZm9yIChjb25zdCBwZXJtaXNzaW9uIG9mIHBlcm1pc3Npb25zKSB7XG4gICAgICBpZiAoIXZhbGlkUGVybWlzc2lvbnMuaW5jbHVkZXMocGVybWlzc2lvbi50eXBlKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBzYW5kYm94UGx1Z2luKHBsdWdpbjogUGx1Z2luKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gSW1wbGVtZW50IHBsdWdpbiBzYW5kYm94aW5nIGlmIG5lZWRlZFxuICAgIC8vIFRoaXMgd291bGQgaW52b2x2ZSBjcmVhdGluZyBhIHJlc3RyaWN0ZWQgZXhlY3V0aW9uIGVudmlyb25tZW50XG4gICAgY29uc29sZS5sb2coYFNhbmRib3hpbmcgcGx1Z2luOiAke3BsdWdpbi5tZXRhZGF0YS5pZH1gKTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrSW50ZWdyaXR5KHBsdWdpbjogUGx1Z2luKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gSW1wbGVtZW50IGludGVncml0eSBjaGVja2luZ1xuICAgIC8vIFRoaXMgd291bGQgaW52b2x2ZSB2ZXJpZnlpbmcgcGx1Z2luIHNpZ25hdHVyZXMsIGNoZWNrc3VtcywgZXRjLlxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja0RlcGVuZGVuY2llcyhkZXBlbmRlbmNpZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pOiBQcm9taXNlPFNlY3VyaXR5VnVsbmVyYWJpbGl0eVtdPiB7XG4gICAgY29uc3QgdnVsbmVyYWJpbGl0aWVzOiBTZWN1cml0eVZ1bG5lcmFiaWxpdHlbXSA9IFtdO1xuICAgIFxuICAgIC8vIExpc3Qgb2Yga25vd24gbWFsaWNpb3VzIG9yIHByb2JsZW1hdGljIHBhY2thZ2VzXG4gICAgY29uc3Qgc3VzcGljaW91c1BhY2thZ2VzID0gW1xuICAgICAgJ2V4ZWMnLCAnY2hpbGRfcHJvY2VzcycsICdzcGF3bicsICdldmFsJywgJ3ZtJ1xuICAgIF07XG5cbiAgICBmb3IgKGNvbnN0IFtkZXBOYW1lLCB2ZXJzaW9uXSBvZiBPYmplY3QuZW50cmllcyhkZXBlbmRlbmNpZXMpKSB7XG4gICAgICBpZiAoc3VzcGljaW91c1BhY2thZ2VzLmluY2x1ZGVzKGRlcE5hbWUpKSB7XG4gICAgICAgIHZ1bG5lcmFiaWxpdGllcy5wdXNoKHtcbiAgICAgICAgICBpZDogYGRlcC0ke2RlcE5hbWV9YCxcbiAgICAgICAgICB0eXBlOiAnZGVwZW5kZW5jeScsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdtZWRpdW0nLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgUG90ZW50aWFsbHkgZGFuZ2Vyb3VzIGRlcGVuZGVuY3k6ICR7ZGVwTmFtZX1gLFxuICAgICAgICAgIGltcGFjdDogJ1BsdWdpbiBjYW4gZXhlY3V0ZSBhcmJpdHJhcnkgY29kZSdcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHZ1bG5lcmFiaWxpdGllcztcbiAgfVxuXG4gIGFzeW5jIGNoZWNrUGVybWlzc2lvbnMocGx1Z2luOiBQbHVnaW4pOiBQcm9taXNlPFBlcm1pc3Npb25SZXN1bHQ+IHtcbiAgICBjb25zdCBjYXBhYmlsaXRpZXMgPSBwbHVnaW4ubWV0YWRhdGEuY2FwYWJpbGl0aWVzO1xuICAgIGNvbnN0IGdyYW50ZWQ6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgZGVuaWVkOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHJlcXVlc3RlZDogc3RyaW5nW10gPSBbXTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IGNhcGFiaWxpdHkgb2YgY2FwYWJpbGl0aWVzKSB7XG4gICAgICByZXF1ZXN0ZWQucHVzaChjYXBhYmlsaXR5LnR5cGUpO1xuICAgICAgLy8gU2ltcGxlIGFwcHJvdmFsIGxvZ2ljXG4gICAgICBpZiAoWydjb21tYW5kJywgJ2FuYWx5emVyJywgJ2Zvcm1hdHRlciddLmluY2x1ZGVzKGNhcGFiaWxpdHkudHlwZSkpIHtcbiAgICAgICAgZ3JhbnRlZC5wdXNoKGNhcGFiaWxpdHkudHlwZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkZW5pZWQucHVzaChjYXBhYmlsaXR5LnR5cGUpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4geyBncmFudGVkLCBkZW5pZWQsIHJlcXVlc3RlZCB9O1xuICB9XG4gIFxuICBwcml2YXRlIGFzeW5jIGNoZWNrUGVybWlzc2lvbnNQcml2YXRlKGNhcGFiaWxpdGllczogYW55W10pOiBQcm9taXNlPFNlY3VyaXR5VnVsbmVyYWJpbGl0eVtdPiB7XG4gICAgY29uc3QgdnVsbmVyYWJpbGl0aWVzOiBTZWN1cml0eVZ1bG5lcmFiaWxpdHlbXSA9IFtdO1xuICAgIFxuICAgIGZvciAoY29uc3QgY2FwYWJpbGl0eSBvZiBjYXBhYmlsaXRpZXMpIHtcbiAgICAgIGlmIChjYXBhYmlsaXR5LnBlcm1pc3Npb25zKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGVybWlzc2lvbiBvZiBjYXBhYmlsaXR5LnBlcm1pc3Npb25zKSB7XG4gICAgICAgICAgaWYgKHBlcm1pc3Npb24udHlwZSA9PT0gJ2ZpbGUtc3lzdGVtJyAmJiBwZXJtaXNzaW9uLnNjb3BlID09PSAnKicpIHtcbiAgICAgICAgICAgIHZ1bG5lcmFiaWxpdGllcy5wdXNoKHtcbiAgICAgICAgICAgICAgaWQ6IGBwZXJtLWZzLXdpbGRjYXJkYCxcbiAgICAgICAgICAgICAgdHlwZTogJ3Blcm1pc3Npb24nLFxuICAgICAgICAgICAgICBzZXZlcml0eTogJ2hpZ2gnLFxuICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1BsdWdpbiByZXF1ZXN0cyB1bnJlc3RyaWN0ZWQgZmlsZSBzeXN0ZW0gYWNjZXNzJyxcbiAgICAgICAgICAgICAgaW1wYWN0OiAnUGx1Z2luIGNhbiByZWFkL3dyaXRlIGFueSBmaWxlJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHZ1bG5lcmFiaWxpdGllcztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tDb2RlUGF0dGVybnMoZW50cnlQb2ludDogc3RyaW5nKTogUHJvbWlzZTxTZWN1cml0eVZ1bG5lcmFiaWxpdHlbXT4ge1xuICAgIGNvbnN0IHZ1bG5lcmFiaWxpdGllczogU2VjdXJpdHlWdWxuZXJhYmlsaXR5W10gPSBbXTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29kZSA9IGZzLnJlYWRGaWxlU3luYyhlbnRyeVBvaW50LCAndXRmOCcpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBmb3IgZXZhbCB1c2FnZVxuICAgICAgaWYgKGNvZGUuaW5jbHVkZXMoJ2V2YWwoJykpIHtcbiAgICAgICAgdnVsbmVyYWJpbGl0aWVzLnB1c2goe1xuICAgICAgICAgIGlkOiAnY29kZS1ldmFsJyxcbiAgICAgICAgICB0eXBlOiAnY29kZScsXG4gICAgICAgICAgc2V2ZXJpdHk6ICdjcml0aWNhbCcsXG4gICAgICAgICAgZGVzY3JpcHRpb246ICdQbHVnaW4gdXNlcyBldmFsKCkgd2hpY2ggY2FuIGV4ZWN1dGUgYXJiaXRyYXJ5IGNvZGUnLFxuICAgICAgICAgIGltcGFjdDogJ0NvZGUgaW5qZWN0aW9uIHZ1bG5lcmFiaWxpdHknXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgbmV0d29yayByZXF1ZXN0cyB0byBzdXNwaWNpb3VzIGRvbWFpbnNcbiAgICAgIGNvbnN0IHN1c3BpY2lvdXNEb21haW5zID0gWydiaXQubHknLCAndGlueXVybC5jb20nLCAncmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSddO1xuICAgICAgZm9yIChjb25zdCBkb21haW4gb2Ygc3VzcGljaW91c0RvbWFpbnMpIHtcbiAgICAgICAgaWYgKGNvZGUuaW5jbHVkZXMoZG9tYWluKSkge1xuICAgICAgICAgIHZ1bG5lcmFiaWxpdGllcy5wdXNoKHtcbiAgICAgICAgICAgIGlkOiBgY29kZS1zdXNwaWNpb3VzLWRvbWFpbi0ke2RvbWFpbn1gLFxuICAgICAgICAgICAgdHlwZTogJ25ldHdvcmsnLFxuICAgICAgICAgICAgc2V2ZXJpdHk6ICdtZWRpdW0nLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGBQbHVnaW4gbWFrZXMgcmVxdWVzdHMgdG8gc3VzcGljaW91cyBkb21haW46ICR7ZG9tYWlufWAsXG4gICAgICAgICAgICBpbXBhY3Q6ICdQb3RlbnRpYWwgZGF0YSBleGZpbHRyYXRpb24nXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBzY2FuIGNvZGUgcGF0dGVybnMgaW4gJHtlbnRyeVBvaW50fTpgLCBlcnJvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZ1bG5lcmFiaWxpdGllcztcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnModnVsbmVyYWJpbGl0aWVzOiBTZWN1cml0eVZ1bG5lcmFiaWxpdHlbXSk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCByZWNvbW1lbmRhdGlvbnM6IHN0cmluZ1tdID0gW107XG4gICAgXG4gICAgaWYgKHZ1bG5lcmFiaWxpdGllcy5zb21lKHYgPT4gdi5zZXZlcml0eSA9PT0gJ2NyaXRpY2FsJykpIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdEbyBub3QgaW5zdGFsbCB0aGlzIHBsdWdpbiBkdWUgdG8gY3JpdGljYWwgc2VjdXJpdHkgaXNzdWVzJyk7XG4gICAgfVxuICAgIFxuICAgIGlmICh2dWxuZXJhYmlsaXRpZXMuc29tZSh2ID0+IHYuc2V2ZXJpdHkgPT09ICdoaWdoJykpIHtcbiAgICAgIHJlY29tbWVuZGF0aW9ucy5wdXNoKCdSZXZpZXcgcGx1Z2luIHBlcm1pc3Npb25zIGFuZCBjb2RlIGJlZm9yZSBpbnN0YWxsYXRpb24nKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHZ1bG5lcmFiaWxpdGllcy5zb21lKHYgPT4gdi50eXBlID09PSAnZGVwZW5kZW5jeScpKSB7XG4gICAgICByZWNvbW1lbmRhdGlvbnMucHVzaCgnQXVkaXQgcGx1Z2luIGRlcGVuZGVuY2llcyBmb3Iga25vd24gdnVsbmVyYWJpbGl0aWVzJyk7XG4gICAgfVxuICAgIFxuICAgIGlmICh2dWxuZXJhYmlsaXRpZXMuc29tZSh2ID0+IHYudHlwZSA9PT0gJ3Blcm1pc3Npb24nKSkge1xuICAgICAgcmVjb21tZW5kYXRpb25zLnB1c2goJ0xpbWl0IHBsdWdpbiBwZXJtaXNzaW9ucyB0byBtaW5pbXVtIG5lY2Vzc2FyeScpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcmVjb21tZW5kYXRpb25zO1xuICB9XG59XG5cbmV4cG9ydCB7IFBsdWdpblNlY3VyaXR5U2VydmljZSB9O1xuIl0sInZlcnNpb24iOjN9